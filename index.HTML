<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00A0B0">
    <title>App Xylem Trabajos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #ffffff;
            color: #333333;
            overflow: hidden;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #00A0B0;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .hamburger {
            font-size: 30px;
            cursor: pointer;
        }
        .header-title {
            font-size: 1.4em;
            text-align: center;
            flex: 1;
        }
        .user-info {
            font-size: 1em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 998;
        }
        .overlay.active {
            display: block;
        }
        .drawer {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: #00A0B0;
            color: #ffffff;
            padding: 80px 20px 20px;
            transition: left 0.3s ease;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 999;
            overflow-y: auto;
        }
        .drawer.open {
            left: 0;
        }
        .drawer button {
            background: none;
            border: none;
            color: #ffffff;
            text-align: left;
            cursor: pointer;
            font-size: 1.2em;
            padding: 15px;
            width: 100%;
            border-radius: 5px;
            transition: background 0.3s;
            margin-bottom: 10px;
        }
        .drawer button:hover, .drawer button.active {
            background-color: #00838f;
        }
        .drawer button.logout {
            background-color: #ff4444;
            margin-top: 30px;
        }
        .main-content {
            margin-top: 60px;
            padding: 20px;
            width: 100%;
            height: calc(100% - 60px);
            overflow-y: auto;
            box-sizing: border-box;
        }
        .section-title {
            text-align: center;
            font-size: 1.6em;
            margin-bottom: 20px;
            color: #00A0B0;
        }
        .tabs {
            display: flex;
            overflow-x: auto;
            background-color: #f9f9f9;
            border-bottom: 2px solid #00A0B0;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background-color: #e0e0e0;
            white-space: nowrap;
            font-weight: bold;
        }
        .tab.active {
            background-color: #00A0B0;
            color: white;
        }
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }
        .card {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 150px;
            text-align: center;
        }
        .card h4 {
            margin: 0 0 10px 0;
            color: #00A0B0;
        }
        .big-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #00A0B0;
        }
        .big-number.red {
            color: #ff4444;
        }
        .big-number.amber {
            color: #FFB300;
        }
        .big-number.green {
            color: #4CAF50;
        }
        .chart-wrapper {
            width: 150px;
            height: 150px;
            margin: 10px auto;
        }
        .obs-cards {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        .obs-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-left: 5px solid #FF4444;
            cursor: pointer;
        }
        .obs-card.resolved {
            border-left-color: #4CAF50;
        }
        .obs-card.delayed {
            border-left-color: #FFB300;
        }
        .obs-card h3 {
            margin: 0 0 10px 0;
            word-break: break-word;
        }
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            display: inline-block;
            margin-right: 5px;
        }
        .badge-pendiente {
            background-color: #FF4444;
            color: white;
        }
        .badge-resuelto {
            background-color: #4CAF50;
            color: white;
        }
        .badge-atrasado {
            background-color: #FFB300;
            color: black;
        }
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #00A0B0;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 997;
        }
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #00A0B0;
            display: none;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 996;
        }
        .bottom-bar button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 10px;
        }
        .bottom-bar button span {
            display: block;
            font-size: 0.7em;
            margin-top: 5px;
        }
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .toolbar select, .toolbar input {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #00A0B0;
        }
        .matrix-table-wrapper {
            overflow-x: auto;
            border: 1px solid #00A0B0;
            border-radius: 8px;
            background-color: #ffffff;
            margin-top: 20px;
        }
        .matrix-table th, .matrix-table td {
            min-width: 120px;
            padding: 12px;
            text-align: center;
            border: 1px solid #00A0B0;
        }
        .matrix-table th {
            background-color: #00A0B0;
            color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .fixed-column {
            position: sticky;
            left: 0;
            background-color: #f9f9f9;
            z-index: 1;
            font-weight: bold;
        }
        .matrix-table th.fixed-column {
            background-color: #00A0B0;
            color: #ffffff;
            z-index: 3;
        }
        .cell-green { background-color: #4CAF50; color: white; }
        .cell-orange { background-color: #FFB300; color: black; }
        .cell-red { background-color: #ff4444; color: white; }
        .cell-gray { background-color: #cccccc; color: black; cursor: pointer; }
        .cell-critical-zero { background-color: #4CAF50; color: white; font-weight: bold; }
        .cell-critical-positive { background-color: #ff4444; color: white; font-weight: bold; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #f9f9f9;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
        }
        .close {
            color: #00838f;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .voice-btn {
            background-color: #00A0B0;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            margin-top: 10px;
        }
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #00A0B0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 2000;
        }
        .login-screen select, .login-screen input, .login-screen button {
            width: 80%;
            max-width: 400px;
            padding: 15px;
            margin: 10px 0;
            font-size: 1.2em;
            border-radius: 8px;
            border: none;
        }
        .login-screen button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        .trabajador-cursos {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
        .trabajador-curso-card {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        @media (max-width: 768px) {
            .bottom-bar {
                display: flex;
            }
            .fab {
                bottom: 80px;
            }
            .dashboard {
                flex-direction: column;
            }
            .chart-wrapper {
                width: 120px;
                height: 120px;
            }
            .obs-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="login-screen">
        <h1 style="font-size:2.5em;margin-bottom:30px;">App Xylem Trabajos</h1>
        <select id="user-select"></select>
        <input type="text" id="dni-input" placeholder="Ingrese su DNI" maxlength="8">
        <button onclick="login()">Ingresar</button>
        <p id="login-error" style="color:#ff4444;margin-top:15px;"></p>
    </div>

    <div id="app" style="display:none;">
        <div class="header">
            <div class="hamburger" onclick="toggleDrawer()">☰</div>
            <div class="header-title" id="section-title">Pendientes / Observaciones</div>
            <div class="user-info" id="user-info"></div>
        </div>

        <div class="overlay" onclick="toggleDrawer()"></div>

        <div class="drawer" id="drawer">
            <button id="btn-pendientes" class="active" onclick="loadPendientes()">Pendientes / Observaciones</button>
            <button id="btn-cursos" onclick="loadCursosSection()">Cursos de Seguridad</button>
            <button class="logout" onclick="logout()">Cerrar Sesión</button>
        </div>

        <div class="main-content">
            <h2 class="section-title" id="main-title">Pendientes / Observaciones</h2>
            <div id="content"></div>
        </div>

        <div class="fab" id="fab" onclick="openNewObsModal()">+</div>

        <div class="bottom-bar">
            <button onclick="loadPendientes()"><i class="fas fa-list-ol"></i><span>Pendientes</span></button>
            <button onclick="loadCursosSection()"><i class="fas fa-certificate"></i><span>Cursos</span></button>
        </div>
    </div>

    <!-- Modal Nueva Observación -->
    <div id="new-obs-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('new-obs-modal')">&times;</span>
            <h3>Nueva Observación</h3>
            <label>Sector:</label>
            <select id="new-obs-sector">
                <option value="pozos">Pozos</option>
                <option value="pozas">Pozas</option>
                <option value="pb1">PB1</option>
                <option value="well_point">Well Point</option>
            </select>
            <label>Descripción:</label>
            <textarea id="new-obs-desc" rows="5"></textarea>
            <button class="voice-btn" id="voice-btn"><i class="fas fa-microphone"></i></button>
            <label>¿Lo arreglaste ahora?</label>
            <div style="display:flex;gap:20px;justify-content:center;margin:15px 0;">
                <button style="background:#4CAF50;color:white;padding:10px 20px;border:none;border-radius:5px;" onclick="setResolvedNow(true)">SÍ</button>
                <button style="background:#FF4444;color:white;padding:10px 20px;border:none;border-radius:5px;" onclick="setResolvedNow(false)">NO</button>
            </div>
            <div id="resolved-comment-div" style="display:none;">
                <label>Comentario de resolución (obligatorio):</label>
                <textarea id="resolved-comment" rows="4"></textarea>
            </div>
            <button style="background:#00A0B0;color:white;padding:10px 20px;border:none;border-radius:5px;margin-top:15px;" onclick="saveNewObs()">Guardar</button>
        </div>
    </div>

    <!-- Modal Detalle Observación -->
    <div id="detail-obs-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('detail-obs-modal')">&times;</span>
            <h3 id="detail-title">Detalle Observación</h3>
            <p><strong>Descripción:</strong> <span id="detail-desc"></span></p>
            <p><strong>Sector:</strong> <span id="detail-sector"></span></p>
            <p><strong>Reportado por:</strong> <span id="detail-reportado"></span></p>
            <p><strong>Fecha:</strong> <span id="detail-fecha"></span></p>
            <div id="detail-resuelto-div" style="display:none;">
                <p><strong>Estado:</strong> <span class="badge badge-resuelto">Resuelto</span></p>
                <p><strong>Comentario de resolución:</strong> <span id="detail-comentario"></span></p>
                <p><strong>Fecha resolución:</strong> <span id="detail-fecha-res"></span></p>
            </div>
            <div id="resolve-div" style="display:none;margin-top:20px;">
                <label>Comentario de resolución (obligatorio):</label>
                <textarea id="resolve-comment" rows="4"></textarea>
                <button style="background:#4CAF50;color:white;padding:10px 20px;border:none;border-radius:5px;margin-top:10px;" onclick="resolveCurrentObs()">Marcar como Resuelto</button>
            </div>
        </div>
    </div>

    <!-- Modal Cursos (reutilizado del original) -->
    <div id="add-curso-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('add-curso-modal')">&times;</span>
            <h3 id="curso-modal-title">Añadir Curso</h3>
            <label>Personal:</label>
            <input type="text" id="curso-personal" list="personal-datalist">
            <datalist id="personal-datalist"></datalist>
            <label>Curso:</label>
            <input type="text" id="curso-nombre">
            <label>Fecha de Vencimiento:</label>
            <input type="date" id="curso-venc">
            <button id="save-curso" style="background:#00A0B0;color:white;padding:10px 20px;border:none;border-radius:5px;margin-top:15px;">Guardar</button>
            <button id="delete-curso" style="display:none;background:#ff4444;color:white;margin-left:10px;padding:10px 20px;border:none;border-radius:5px;">Eliminar</button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyhP0Ak3ziNrGTCFHKlFr7-_HAMimYX_g",
            authDomain: "trabajos---xylem.firebaseapp.com",
            projectId: "trabajos---xylem",
            storageBucket: "trabajos---xylem.firebasestorage.app",
            messagingSenderId: "719564556454",
            appId: "1:719564556454:web:22e10612163f79d4b5cc67",
            measurementId: "G-M4QXHB30W2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const usuarios = [
            { nombre: "TURPO CALLOHUANCA CESAR JHONY", dni: "40968321", rol: "supervisor" },
            { nombre: "ASTULLE AZA WILLY ENRIQUE", dni: "41834020", rol: "supervisor" },
            { nombre: "LIMASCA CHAHUAYO AMERICO", dni: "46146718", rol: "trabajador" },
            { nombre: "HUAMANI QUIO OSCAR EMILIO", dni: "72156518", rol: "supervisor" },
            { nombre: "PEREZ VARIAS WALTER SERGEY", dni: "29419804", rol: "trabajador" },
            { nombre: "CONDORI HUANCA FREDY", dni: "29652867", rol: "trabajador" },
            { nombre: "LLAIQUE QUISPE SAMUEL", dni: "76647913", rol: "trabajador" },
            { nombre: "GOMEZ LACACTA JOSE LUIS", dni: "47673736", rol: "trabajador" },
            { nombre: "QUSIPE YUCRA GILBER SILVESTRE", dni: "46759346", rol: "trabajador" },
            { nombre: "QUINA BARRIGA CARLOS FERMANDO", dni: "29320149", rol: "trabajador" },
            { nombre: "FUENTES FUENTES JOSE", dni: "04431627", rol: "trabajador" },
            { nombre: "SUCASACA YUCRA JUAN NOE", dni: "47057969", rol: "trabajador" },
            { nombre: "CCAHUANA HUAMANI MARCO ANTONIO", dni: "74752120", rol: "trabajador" },
            { nombre: "QUISPE YUCRA JUAN CARLOS", dni: "78374316", rol: "trabajador" },
            { nombre: "PAUCCARA HUAMANI HUGO", dni: "24893792", rol: "trabajador" },
            { nombre: "HUAYTA MAMANI HUGO ELOY", dni: "29685210", rol: "trabajador" },
            { nombre: "QUISPE APAZA JUAN CARLOS", dni: "71994478", rol: "trabajador" },
            { nombre: "SUPHO TUNQUIPA EVER", dni: "44672755", rol: "trabajador" },
            { nombre: "MERMA CRUZ MARCO ANTONIO", dni: "72271044", rol: "trabajador" },
            { nombre: "PPACCO HUAMANI ALEX", dni: "74164942", rol: "trabajador" },
            { nombre: "HUANCA CONDORI EVENISTER ADAN", dni: "04430425", rol: "trabajador" },
            { nombre: "FLOREZ ARQUE WILLAM", dni: "44626323", rol: "supervisor" }
        ];

        let currentUser = null;
        let currentSection = 'pendientes';
        let currentSectorFilter = 'todos';
        let currentCharts = [];
        let recognition = null;
        let currentObsId = null;

        const sectors = ['pozos', 'pozas', 'pb1', 'well_point'];

        function destroyCharts() {
            currentCharts.forEach(chart => chart && chart.destroy());
            currentCharts = [];
        }

        function toggleDrawer() {
            document.getElementById('drawer').classList.toggle('open');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if (recognition) recognition.stop();
        }

        function populateUserSelect() {
            const sorted = [...usuarios].sort((a, b) => a.nombre.localeCompare(b.nombre));
            const select = document.getElementById('user-select');
            sorted.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.nombre;
                opt.textContent = u.nombre;
                select.appendChild(opt);
            });
        }

        function login() {
            const nombre = document.getElementById('user-select').value;
            const dni = document.getElementById('dni-input').value.trim();
            const errorEl = document.getElementById('login-error');
            const user = usuarios.find(u => u.nombre === nombre && u.dni === dni);
            if (user) {
                currentUser = { nombre: user.nombre, rol: user.rol };
                localStorage.setItem('user', JSON.stringify(currentUser));
                document.getElementById('app').style.display = 'block';
                document.getElementById('login-screen').style.display = 'none';
                updateHeader();
                loadPendientes();
            } else {
                errorEl.textContent = 'DNI incorrecto o usuario no encontrado';
            }
        }

        function logout() {
            localStorage.removeItem('user');
            location.reload();
        }

        function updateHeader() {
            document.getElementById('user-info').textContent = `${currentUser.nombre} - ${new Date().toLocaleDateString('es-PE')}`;
        }

        function loadPendientes() {
            currentSection = 'pendientes';
            document.getElementById('main-title').textContent = 'Pendientes / Observaciones';
            document.getElementById('btn-pendientes').classList.add('active');
            document.getElementById('btn-cursos').classList.remove('active');
            document.getElementById('fab').style.display = 'block';

            let html = '<div class="tabs" id="obs-tabs"></div>';
            if (currentUser.rol === 'supervisor') {
                html += '<div class="toolbar" id="supervisor-toolbar"></div>';
            }
            html += '<div class="dashboard" id="obs-dashboard"></div>';
            html += '<div class="obs-cards" id="obs-cards"></div>';

            document.getElementById('content').innerHTML = html;

            const tabs = document.getElementById('obs-tabs');
            tabs.innerHTML = sectors.map(s => 
                `<div class="tab ${currentSectorFilter === s ? 'active' : ''}" onclick="setSectorFilter('${s}')">${s.charAt(0).toUpperCase() + s.slice(1).replace('_',' ')}</div>`
            ).join('') + 
            `<div class="tab ${currentSectorFilter === 'todos' ? 'active' : ''}" onclick="setSectorFilter('todos')">Todos</div>`;
            if (currentUser.rol === 'supervisor') {
                tabs.innerHTML += `<div class="tab ${currentSectorFilter === 'mis' ? 'active' : ''}" onclick="setSectorFilter('mis')">Mis Pendientes</div>`;
            }

            if (currentUser.rol === 'supervisor') {
                const toolbar = document.getElementById('supervisor-toolbar');
                toolbar.innerHTML = `
                    <select id="date-filter">
                        <option value="todos">Todos</option>
                        <option value="hoy">Hoy</option>
                        <option value="semana">Última semana</option>
                        <option value="rango">Rango</option>
                    </select>
                    <div id="range-div" style="display:none;">
                        <input type="date" id="from-date">
                        <input type="date" id="to-date">
                    </div>
                `;
                document.getElementById('date-filter').onchange = handleDateFilterChange;
            }

            loadObservations();
        }

        function setSectorFilter(filter) {
            currentSectorFilter = filter;
            loadObservations();
            // Re-render tabs active state
            document.querySelectorAll('#obs-tabs .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#obs-tabs .tab:nth-child(${filter === 'todos' ? sectors.length + 1 : sectors.indexOf(filter) + 1})`).classList.add('active');
            if (filter === 'mis') {
                document.querySelector('#obs-tabs .tab:last-child').classList.add('active');
            }
        }

        function handleDateFilterChange() {
            const val = document.getElementById('date-filter').value;
            document.getElementById('range-div').style.display = val === 'rango' ? 'flex' : 'none';
            loadObservations();
        }

        function loadObservations() {
            destroyCharts();
            db.collection('observaciones').onSnapshot(snapshot => {
                let obs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    data.fechaReporteDate = data.fechaReporte ? data.fechaReporte.toDate() : new Date();
                    obs.push(data);
                });

                // Filtros
                let filtered = obs;

                // Sector
                if (currentSectorFilter !== 'todos') {
                    if (currentSectorFilter === 'mis') {
                        filtered = filtered.filter(o => o.reportadoPor === currentUser.nombre);
                    } else {
                        filtered = filtered.filter(o => o.sector === currentSectorFilter);
                    }
                }

                // Fecha supervisor
                if (currentUser.rol === 'supervisor') {
                    const filterVal = document.getElementById('date-filter').value;
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    if (filterVal === 'hoy') {
                        filtered = filtered.filter(o => {
                            const d = o.fechaReporteDate;
                            d.setHours(0,0,0,0);
                            return d.getTime() === today.getTime();
                        });
                    } else if (filterVal === 'semana') {
                        const weekAgo = new Date(today);
                        weekAgo.setDate(today.getDate() - 7);
                        filtered = filtered.filter(o => o.fechaReporteDate >= weekAgo);
                    } else if (filterVal === 'rango') {
                        const from = document.getElementById('from-date').valueAsDate;
                        const to = document.getElementById('to-date').valueAsDate;
                        if (from && to) {
                            to.setHours(23,59,59,999);
                            filtered = filtered.filter(o => o.fechaReporteDate >= from && o.fechaReporteDate <= to);
                        }
                    }
                }

                renderObsDashboard(filtered);
                renderObsCards(filtered);
            });
        }

        function relativeTime(date) {
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return 'Hoy';
            if (diffDays === 1) return 'Ayer';
            return `Hace ${diffDays} días`;
        }

        function renderObsDashboard(data) {
            const dashboard = document.getElementById('obs-dashboard');
            let total = data.length;
            let pendientes = data.filter(o => !o.resuelto).length;
            let resueltos = total - pendientes;
            let atrasados = data.filter(o => !o.resuelto && Math.floor((new Date() - o.fechaReporteDate) / (1000*60*60*24)) > 2).length;

            let html = '';
            if (currentUser.rol === 'trabajador') {
                html = `
                    <div class="card"><h4>Total Pendientes</h4><div class="big-number red">${pendientes}</div></div>
                    <div class="card"><h4>Atrasados</h4><div class="big-number amber">${atrasados}</div></div>
                    <div class="card"><h4>Resueltos</h4><div class="big-number green">${resueltos}</div></div>
                    <div class="card"><h4>% Resolución</h4><div class="chart-wrapper"><canvas id="chart-worker"></canvas></div><div class="big-number green">${total > 0 ? Math.round((resueltos/total)*100) : 0}%</div></div>
                `;
            } else {
                // Supervisor - más completo
                const porSector = {};
                sectors.forEach(s => porSector[s] = {total:0, pendientes:0, atrasados:0});
                data.forEach(o => {
                    const s = o.sector || 'pb1';
                    porSector[s].total++;
                    if (!o.resuelto) {
                        porSector[s].pendientes++;
                        if (Math.floor((new Date() - o.fechaReporteDate) / (1000*60*60*24)) > 2) porSector[s].atrasados++;
                    }
                });

                html = `
                    <div class="card"><h4>Total</h4><div class="big-number">${total}</div></div>
                    <div class="card"><h4>Pendientes</h4><div class="big-number red">${pendientes}</div></div>
                    <div class="card"><h4>Atrasados</h4><div class="big-number amber">${atrasados}</div></div>
                    <div class="card"><h4>Resueltos</h4><div class="big-number green">${resueltos}</div></div>
                    <div class="card"><h4>% Resolución</h4><div class="chart-wrapper"><canvas id="chart-sup"></canvas></div><div class="big-number green">${total > 0 ? Math.round((resueltos/total)*100) : 0}%</div></div>
                `;
            }
            dashboard.innerHTML = html;

            const chartId = currentUser.rol === 'trabajador' ? 'chart-worker' : 'chart-sup';
            const chart = new Chart(document.getElementById(chartId), {
                type: 'doughnut',
                data: {
                    labels: ['Pendientes', 'Resueltos'],
                    datasets: [{ data: [pendientes, resueltos], backgroundColor: ['#FF4444', '#4CAF50'] }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
            currentCharts.push(chart);
        }

        function renderObsCards(data) {
            data.sort((a,b) => b.fechaReporteDate - a.fechaReporteDate);
            const container = document.getElementById('obs-cards');
            let html = '';
            data.forEach(o => {
                const days = Math.floor((new Date() - o.fechaReporteDate) / (1000*60*60*24));
                const isDelayed = !o.resuelto && days > 2;
                html += `
                    <div class="obs-card ${o.resuelto ? 'resolved' : isDelayed ? 'delayed' : ''}" onclick="openDetailObs('${o.id}')">
                        <h3>${o.descripcion}</h3>
                        <p><strong>Sector:</strong> ${o.sector ? o.sector.charAt(0).toUpperCase() + o.sector.slice(1).replace('_',' ') : 'PB1'}</p>
                        <p><strong>Reportado por:</strong> ${o.reportadoPor}</p>
                        <p><strong>Fecha:</strong> ${relativeTime(o.fechaReporteDate)}</p>
                        <span class="badge ${o.resuelto ? 'badge-resuelto' : 'badge-pendiente'}">${o.resuelto ? 'Resuelto' : 'Pendiente'}</span>
                        ${isDelayed ? '<span class="badge badge-atrasado">Atrasado</span>' : ''}
                    </div>
                `;
            });
            if (data.length === 0) html = '<p>No hay observaciones.</p>';
            container.innerHTML = html;
        }

        function openNewObsModal() {
            document.getElementById('new-obs-desc').value = '';
            document.getElementById('resolved-comment-div').style.display = 'none';
            document.getElementById('new-obs-modal').style.display = 'block';

            // Voice setup
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'es-PE';
                recognition.continuous = false;
                recognition.interimResults = true;

                document.getElementById('voice-btn').onclick = () => {
                    recognition.start();
                };

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    document.getElementById('new-obs-desc').value += transcript + ' ';
                };

                recognition.onerror = (event) => console.error('Speech error', event);
                recognition.onend = () => {};
            } else {
                document.getElementById('voice-btn').style.display = 'none';
            }
        }

        let resolvedNow = false;
        function setResolvedNow(val) {
            resolvedNow = val;
            document.getElementById('resolved-comment-div').style.display = val ? 'block' : 'none';
        }

        function saveNewObs() {
            const sector = document.getElementById('new-obs-sector').value;
            const desc = document.getElementById('new-obs-desc').value.trim();
            if (!desc) return alert('Ingrese descripción');

            const comentario = resolvedNow ? document.getElementById('resolved-comment').value.trim() : '';
            if (resolvedNow && !comentario) return alert('Ingrese comentario de resolución');

            const data = {
                sector,
                descripcion: desc,
                reportadoPor: currentUser.nombre,
                fechaReporte: firebase.firestore.FieldValue.serverTimestamp(),
                resuelto: resolvedNow,
                comentarioResolucion: resolvedNow ? comentario : '',
                fechaResolucion: resolvedNow ? firebase.firestore.FieldValue.serverTimestamp() : null
            };

            db.collection('observaciones').add(data)
                .then(() => {
                    closeModal('new-obs-modal');
                    alert('Observación guardada');
                })
                .catch(err => {
                    console.error(err);
                    alert('Error al guardar');
                });
        }

        function openDetailObs(id) {
            currentObsId = id;
            db.collection('observaciones').doc(id).get().then(doc => {
                if (!doc.exists) return alert('No encontrada');
                const o = doc.data();
                o.fechaReporteDate = o.fechaReporte ? o.fechaReporte.toDate() : new Date();
                document.getElementById('detail-desc').textContent = o.descripcion;
                document.getElementById('detail-sector').textContent = o.sector ? o.sector.charAt(0).toUpperCase() + o.sector.slice(1).replace('_',' ') : 'PB1';
                document.getElementById('detail-reportado').textContent = o.reportadoPor;
                document.getElementById('detail-fecha').textContent = relativeTime(o.fechaReporteDate);

                if (o.resuelto) {
                    document.getElementById('detail-resuelto-div').style.display = 'block';
                    document.getElementById('detail-comentario').textContent = o.comentarioResolucion || 'Sin comentario';
                    document.getElementById('detail-fecha-res').textContent = o.fechaResolucion ? o.fechaResolucion.toDate().toLocaleDateString('es-PE') : 'N/A';
                    document.getElementById('resolve-div').style.display = 'none';
                } else {
                    document.getElementById('detail-resuelto-div').style.display = 'none';
                    document.getElementById('resolve-div').style.display = 'block';
                    document.getElementById('resolve-comment').value = '';
                }

                document.getElementById('detail-obs-modal').style.display = 'block';
            });
        }

        function resolveCurrentObs() {
            const comentario = document.getElementById('resolve-comment').value.trim();
            if (!comentario) return alert('Ingrese comentario');

            db.collection('observaciones').doc(currentObsId).update({
                resuelto: true,
                comentarioResolucion: comentario,
                fechaResolucion: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                closeModal('detail-obs-modal');
                alert('Marcada como resuelta');
            }).catch(err => console.error(err));
        }

        function loadCursosSection() {
            currentSection = 'cursos';
            document.getElementById('main-title').textContent = 'Cursos de Seguridad';
            document.getElementById('btn-cursos').classList.add('active');
            document.getElementById('btn-pendientes').classList.remove('active');
            document.getElementById('fab').style.display = 'none';

            if (currentUser.rol === 'trabajador') {
                loadCursosTrabajador();
            } else {
                loadCursosSupervisor();
            }
        }

        function loadCursosTrabajador() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="dashboard" id="cursos-dashboard-trab"></div>
                <div class="trabajador-cursos" id="cursos-list-trab"></div>
            `;

            db.collection('cursos').where('personal', '==', currentUser.nombre).get().then(snapshot => {
                const cursos = [];
                snapshot.forEach(doc => cursos.push({id: doc.id, ...doc.data()}));

                let vigentes = 0, porVencer = 0, vencidos = 0;
                const today = new Date(); today.setHours(0,0,0,0);

                cursos.forEach(c => {
                    const venc = c.vencimiento.toDate();
                    venc.setHours(0,0,0,0);
                    const days = Math.ceil((venc - today) / (1000*60*60*24));
                    if (days > 90) vigentes++;
                    else if (days > 0) porVencer++;
                    else vencidos++;
                });

                document.getElementById('cursos-dashboard-trab').innerHTML = `
                    <div class="card"><h4>Vigentes</h4><div class="big-number green">${vigentes}</div></div>
                    <div class="card"><h4>Por Vencer (≤90 días)</h4><div class="big-number amber">${porVencer}</div></div>
                    <div class="card"><h4>Vencidos</h4><div class="big-number red">${vencidos}</div></div>
                    <div class="card"><h4>Estado General</h4><div class="chart-wrapper"><canvas id="chart-trab-cursos"></canvas></div></div>
                `;

                const chart = new Chart(document.getElementById('chart-trab-cursos'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Vigentes', 'Por Vencer', 'Vencidos'],
                        datasets: [{ data: [vigentes, porVencer, vencidos], backgroundColor: ['#00A0B0', '#FFB300', '#FF4444'] }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });
                currentCharts.push(chart);

                let listHtml = '';
                cursos.forEach(c => {
                    const venc = c.vencimiento.toDate();
                    const days = Math.ceil((venc - today) / (1000*60*60*24));
                    let daysText = days > 0 ? `${days} días` : days === 0 ? 'Vence hoy' : `Vencido hace ${-days} días`;
                    let classColor = days > 90 ? 'cell-green' : days > 0 ? 'cell-orange' : 'cell-red';
                    listHtml += `
                        <div class="trabajador-curso-card ${classColor}" onclick="openEditCurso('${c.id}')">
                            <h4>${c.curso}</h4>
                            <p><strong>${daysText}</strong><br><small>${venc.toLocaleDateString('es-PE')}</small></p>
                        </div>
                    `;
                });
                if (cursos.length === 0) listHtml = '<p>No tienes cursos registrados.</p>';
                document.getElementById('cursos-list-trab').innerHTML = listHtml;
            });
        }

        function loadCursosSupervisor() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <button class="add-observation" style="margin-bottom:20px;" onclick="openAddCursoModal()">Añadir Curso</button>
                <div class="dashboard" id="cursos-dashboard"></div>
                <div class="matrix-table-wrapper">
                    <table class="matrix-table">
                        <thead id="matrix-thead"></thead>
                        <tbody id="matrix-tbody"></tbody>
                    </table>
                </div>
            `;

            db.collection('cursos').get().then(snapshot => {
                const cursosData = [];
                snapshot.forEach(doc => cursosData.push({id: doc.id, ...doc.data()}));

                const uniquePersons = [...new Set(cursosData.map(c => c.personal))].sort();
                const uniqueCursos = [...new Set(cursosData.map(c => c.curso))].sort();

                const matrix = {};
                uniquePersons.forEach(p => {
                    matrix[p] = {};
                    uniqueCursos.forEach(c => matrix[p][c] = null);
                });

                let vigentes = 0, porVencer = 0, vencidos = 0;
                const personasCriticos = new Set();
                const today = new Date(); today.setHours(0,0,0,0);

                cursosData.forEach(item => {
                    const p = item.personal;
                    const c = item.curso;
                    const venc = item.vencimiento.toDate();
                    venc.setHours(0,0,0,0);
                    const days = Math.ceil((venc - today) / (1000*60*60*24));

                    matrix[p][c] = {days, date: venc, id: item.id};

                    if (days > 90) vigentes++;
                    else if (days > 0 && days <= 90) { porVencer++; personasCriticos.add(p); }
                    else { vencidos++; personasCriticos.add(p); }
                });

                document.getElementById('cursos-dashboard').innerHTML = `
                    <div class="card"><h4>Total Personal</h4><div class="big-number">${uniquePersons.length}</div></div>
                    <div class="card"><h4>Cursos Registrados</h4><div class="big-number">${cursosData.length}</div></div>
                    <div class="card"><h4>Personas con Críticos</h4><div class="big-number ${personasCriticos.size > 0 ? 'red' : ''}">${personasCriticos.size}</div></div>
                    <div class="card"><h4>Vencidos</h4><div class="big-number red">${vencidos}</div></div>
                    <div class="card"><h4>Distribución</h4><div class="chart-wrapper"><canvas id="chart-cursos-sup"></canvas></div></div>
                `;

                const chart = new Chart(document.getElementById('chart-cursos-sup'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Vigentes', 'Por Vencer', 'Vencidos'],
                        datasets: [{ data: [vigentes, porVencer, vencidos], backgroundColor: ['#00A0B0', '#FFB300', '#FF4444'] }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });
                currentCharts.push(chart);

                const personCriticals = {};
                uniquePersons.forEach(p => {
                    let count = 0;
                    uniqueCursos.forEach(c => {
                        const cell = matrix[p][c];
                        if (cell && cell.days <= 90) count++;
                    });
                    personCriticals[p] = count;
                });

                uniquePersons.sort((a,b) => personCriticals[b] - personCriticals[a]);

                const thead = document.getElementById('matrix-thead');
                let header = '<tr><th class="fixed-column">Personal</th>';
                uniqueCursos.forEach(c => header += `<th>${c}</th>`);
                header += '<th>Críticos</th></tr>';
                thead.innerHTML = header;

                const tbody = document.getElementById('matrix-tbody');
                tbody.innerHTML = '';
                uniquePersons.forEach(p => {
                    const tr = document.createElement('tr');
                    const tdName = document.createElement('td');
                    tdName.className = 'fixed-column';
                    tdName.textContent = p;
                    tr.appendChild(tdName);

                    uniqueCursos.forEach(c => {
                        const td = document.createElement('td');
                        const cell = matrix[p][c];
                        if (!cell) {
                            td.textContent = 'NO REQUIERE';
                            td.className = 'cell-gray';
                            td.onclick = () => openAddCursoModal(p, c);
                        } else {
                            const daysText = cell.days > 0 ? `${cell.days} días` : cell.days === 0 ? 'Vence hoy' : `Vencido hace ${-cell.days} días`;
                            td.innerHTML = `<strong>${daysText}</strong><br><small>${cell.date.toLocaleDateString('es-PE')}</small>`;
                            td.className = cell.days > 90 ? 'cell-green' : cell.days > 0 ? 'cell-orange' : 'cell-red';
                            td.onclick = () => openEditCurso(cell.id);
                        }
                        tr.appendChild(td);
                    });

                    const critTd = document.createElement('td');
                    critTd.textContent = personCriticals[p];
                    critTd.className = personCriticals[p] > 0 ? 'cell-critical-positive' : 'cell-critical-zero';
                    tr.appendChild(critTd);

                    tbody.appendChild(tr);
                });
            });
        }

        function openAddCursoModal(prePersonal = '', preCurso = '') {
            editingCursoId = null;
            document.getElementById('curso-modal-title').textContent = 'Añadir Curso';
            document.getElementById('curso-personal').value = prePersonal;
            document.getElementById('curso-nombre').value = preCurso;
            document.getElementById('curso-venc').value = '';
            document.getElementById('delete-curso').style.display = 'none';
            populatePersonalDatalist();
            document.getElementById('add-curso-modal').style.display = 'block';
        }

        let editingCursoId = null;
        function openEditCurso(id) {
            editingCursoId = id;
            document.getElementById('curso-modal-title').textContent = 'Editar Curso';
            db.collection('cursos').doc(id).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('curso-personal').value = data.personal;
                    document.getElementById('curso-nombre').value = data.curso;
                    document.getElementById('curso-venc').value = data.vencimiento.toDate().toISOString().split('T')[0];
                    document.getElementById('delete-curso').style.display = 'block';
                    populatePersonalDatalist();
                    document.getElementById('add-curso-modal').style.display = 'block';
                }
            });
        }

        function populatePersonalDatalist() {
            const datalist = document.getElementById('personal-datalist');
            datalist.innerHTML = '';
            usuarios.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.nombre;
                datalist.appendChild(opt);
            });
        }

        document.getElementById('save-curso').onclick = () => {
            const personal = document.getElementById('curso-personal').value.trim();
            const curso = document.getElementById('curso-nombre').value.trim();
            const dateStr = document.getElementById('curso-venc').value;
            if (!personal || !curso || !dateStr) return alert('Complete todos los campos');

            const venc = firebase.firestore.Timestamp.fromDate(new Date(dateStr));
            const data = { personal, curso, vencimiento: venc };

            if (editingCursoId) {
                db.collection('cursos').doc(editingCursoId).update(data).then(() => {
                    alert('Actualizado');
                    closeModal('add-curso-modal');
                    loadCursosSection();
                });
            } else {
                db.collection('cursos').add(data).then(() => {
                    alert('Añadido');
                    closeModal('add-curso-modal');
                    loadCursosSection();
                });
            }
        };

        document.getElementById('delete-curso').onclick = () => {
            if (confirm('¿Eliminar este curso?')) {
                db.collection('cursos').doc(editingCursoId).delete().then(() => {
                    alert('Eliminado');
                    closeModal('add-curso-modal');
                    loadCursosSection();
                });
            }
        };

        window.onload = () => {
            const stored = localStorage.getItem('user');
            if (stored) {
                currentUser = JSON.parse(stored);
                document.getElementById('app').style.display = 'block';
                updateHeader();
                loadPendientes();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                populateUserSelect();
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js');
            }
        };
    </script>
</body>
</html>