<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#00A0B0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Hidrogeolog√≠a Trabajos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--primary:#00A0B0;--primary-dark:#007A87;--primary-light:#4DD0E1;--success:#2E7D32;--success-light:#4CAF50;--warning:#F57C00;--warning-light:#FFB300;--danger:#C62828;--danger-light:#EF5350;--text-dark:#1A1A2E;--text-medium:#4A4A5A;--text-light:#6B6B7B;--bg-white:#FFF;--bg-light:#F5F7FA;--border-light:#E0E4E8;--shadow-sm:0 2px 8px rgba(0,0,0,0.08);--shadow-md:0 4px 16px rgba(0,0,0,0.12);--shadow-lg:0 8px 32px rgba(0,0,0,0.16);--radius-sm:12px;--radius-md:16px;--radius-lg:24px}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        html,body{height:100%;font-family:'Nunito',Arial,sans-serif;font-size:18px;background:var(--bg-light);color:var(--text-dark);overflow:hidden;line-height:1.5}
        .header{position:fixed;top:0;left:0;right:0;height:70px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;box-shadow:var(--shadow-md);z-index:1000}
        .hamburger{font-size:32px;cursor:pointer;padding:10px;border-radius:var(--radius-sm)}.hamburger:active{background:rgba(255,255,255,0.2)}
        .header-title{font-size:20px;font-weight:700;text-align:center;flex:1}
        .user-info{font-size:16px;font-weight:600;background:rgba(255,255,255,0.15);padding:8px 14px;border-radius:50px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;z-index:998;backdrop-filter:blur(4px)}.overlay.active{display:block}
        .drawer{position:fixed;top:0;left:-320px;width:300px;height:100%;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;padding:90px 20px 30px;transition:left .3s;box-shadow:var(--shadow-lg);z-index:999}.drawer.open{left:0}
        .drawer button{background:rgba(255,255,255,0.1);border:none;color:#fff;text-align:left;cursor:pointer;font-size:20px;font-weight:600;padding:18px 20px;width:100%;border-radius:var(--radius-md);margin-bottom:12px;display:flex;align-items:center;gap:15px;transition:all .3s}
        .drawer button i{font-size:24px;width:30px;text-align:center}.drawer button:hover,.drawer button.active{background:rgba(255,255,255,0.25);transform:translateX(5px)}.drawer button.logout{background:var(--danger);margin-top:30px}
        .main-content{margin-top:70px;padding:20px;width:100%;height:calc(100vh - 70px);overflow-y:auto}
        .section-title{text-align:center;font-size:28px;font-weight:800;margin-bottom:20px;color:var(--primary-dark)}
        .quick-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:25px}
        .quick-action-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 10px;border-radius:var(--radius-md);border:none;cursor:pointer;font-size:16px;font-weight:700;box-shadow:var(--shadow-sm);min-height:100px;transition:transform .2s}
        .quick-action-btn i{font-size:32px;margin-bottom:10px}.quick-action-btn:active{transform:scale(0.95)}
        .btn-new-obs{background:linear-gradient(135deg,var(--success),var(--success-light));color:#fff}
        .btn-pending{background:linear-gradient(135deg,var(--warning),var(--warning-light));color:#fff}
        .btn-courses{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff}
        .search-container{position:relative;margin-bottom:20px}
        .search-input{width:100%;padding:18px 20px 18px 55px;font-size:18px;border:3px solid var(--border-light);border-radius:var(--radius-lg);background:var(--bg-white);color:var(--text-dark);font-weight:600}
        .search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(0,160,176,0.15)}
        .search-icon{position:absolute;left:20px;top:50%;transform:translateY(-50%);font-size:22px;color:var(--text-light)}
        .search-clear{position:absolute;right:15px;top:50%;transform:translateY(-50%);font-size:20px;color:var(--text-light);cursor:pointer;display:none}.search-clear.show{display:block}
        .tabs{display:flex;overflow-x:auto;background:var(--bg-white);border-radius:var(--radius-lg);padding:8px;margin-bottom:20px;box-shadow:var(--shadow-sm);gap:8px;scrollbar-width:none}.tabs::-webkit-scrollbar{display:none}
        .tab{padding:14px 20px;cursor:pointer;background:transparent;font-weight:700;font-size:16px;min-width:fit-content;text-align:center;border-radius:var(--radius-md);color:var(--text-medium);white-space:nowrap}
        .tab.active{background:var(--primary);color:#fff;box-shadow:var(--shadow-sm)}
        .dashboard{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:25px}
        .card{background:var(--bg-white);padding:20px;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);text-align:center;border:2px solid var(--border-light)}
        .card i{font-size:36px;margin-bottom:10px}.card h4{margin:0 0 8px;color:var(--text-medium);font-size:16px;font-weight:600}
        .big-number{font-size:42px;font-weight:800;line-height:1}.big-number.primary{color:var(--primary)}.big-number.red{color:var(--danger)}.big-number.green{color:var(--success)}.big-number.orange{color:var(--warning)}
        .card.card-primary{border-color:var(--primary)}.card.card-primary i{color:var(--primary)}
        .card.card-danger{border-color:var(--danger)}.card.card-danger i{color:var(--danger)}
        .card.card-success{border-color:var(--success)}.card.card-success i{color:var(--success)}
        .card.card-warning{border-color:var(--warning)}.card.card-warning i{color:var(--warning)}
        .obs-cards{display:flex;flex-direction:column;gap:15px}
        .obs-card{background:var(--bg-white);padding:20px;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);border-left:6px solid var(--danger);cursor:pointer;position:relative}
        .obs-card:active{transform:scale(0.98)}.obs-card.resolved{border-left-color:var(--success)}.obs-card.partial{border-left-color:var(--warning)}
        .obs-card-header{display:flex;align-items:flex-start;gap:15px;margin-bottom:12px}
        .sector-icon{width:50px;height:50px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;flex-shrink:0}
        .sector-icon.pozos{background:linear-gradient(135deg,#1976D2,#42A5F5)}.sector-icon.pozas{background:linear-gradient(135deg,#7B1FA2,#AB47BC)}.sector-icon.pb1{background:linear-gradient(135deg,#E64A19,#FF7043)}.sector-icon.well_point{background:linear-gradient(135deg,#00796B,#26A69A)}
        .obs-card-info{flex:1;min-width:0}.obs-card h3{font-size:18px;font-weight:700;color:var(--text-dark);margin-bottom:6px;word-break:break-word}
        .obs-card-meta{font-size:16px;color:var(--text-medium);display:flex;flex-wrap:wrap;gap:10px}.obs-card-meta span{display:flex;align-items:center;gap:5px}
        .priority-indicator{position:absolute;top:15px;right:15px;padding:6px 12px;border-radius:50px;font-size:14px;font-weight:700}
        .priority-alta{background:var(--danger-light);color:#fff}.priority-media{background:var(--warning-light);color:var(--text-dark)}.priority-baja{background:var(--success-light);color:#fff}
        .obs-card .progress-container{background:var(--bg-light);border-radius:10px;height:24px;margin:15px 0;border:2px solid var(--border-light);overflow:hidden}
        .obs-card .progress-bar{height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:16px;border-radius:8px}
        .badge{padding:8px 16px;border-radius:50px;font-weight:700;font-size:16px}.badge-pendiente{background:rgba(198,40,40,0.15);color:var(--danger)}.badge-resuelto{background:rgba(46,125,50,0.15);color:var(--success)}
        .fab{position:fixed;bottom:30px;right:20px;width:70px;height:70px;background:linear-gradient(135deg,var(--success),var(--success-light));color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;box-shadow:var(--shadow-lg);cursor:pointer;z-index:997;border:none}.fab:active{transform:scale(0.9)}
        .modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
        .modal-content{background:var(--bg-white);margin:20px auto;padding:25px;border-radius:var(--radius-lg);width:95%;max-width:500px;box-shadow:var(--shadow-lg);max-height:90vh;overflow-y:auto;animation:slideUp .3s}
        @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .modal-content h3{font-size:24px;font-weight:800;margin-bottom:25px;text-align:center;color:var(--primary-dark)}
        .modal-content label{font-size:18px;font-weight:700;margin:15px 0 10px;display:block;color:var(--text-dark)}
        .modal-content select,.modal-content textarea,.modal-content input[type="text"],.modal-content input[type="number"],.modal-content input[type="date"]{width:100%;padding:16px 18px;border-radius:var(--radius-md);border:3px solid var(--border-light);font-size:18px;font-weight:600;background:var(--bg-white);color:var(--text-dark)}
        .modal-content select:focus,.modal-content textarea:focus,.modal-content input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(0,160,176,0.15)}
        .modal-content textarea{resize:vertical;min-height:120px}
        .close{float:right;font-size:36px;font-weight:bold;cursor:pointer;color:var(--text-light);line-height:1}.close:hover{color:var(--danger)}
        .sector-selector{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:15px}
        .sector-option{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 15px;border-radius:var(--radius-md);border:3px solid var(--border-light);background:var(--bg-white);cursor:pointer;min-height:100px}
        .sector-option i{font-size:32px;margin-bottom:10px}.sector-option span{font-size:16px;font-weight:700;color:var(--text-dark)}
        .sector-option.selected{border-color:var(--primary);background:rgba(0,160,176,0.1)}
        .sector-option[data-sector="pozos"] i{color:#1976D2}.sector-option[data-sector="pozas"] i{color:#7B1FA2}.sector-option[data-sector="pb1"] i{color:#E64A19}.sector-option[data-sector="well_point"] i{color:#00796B}
        .priority-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:15px}
        .priority-option{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:15px 10px;border-radius:var(--radius-md);border:3px solid var(--border-light);background:var(--bg-white);cursor:pointer}
        .priority-option i{font-size:24px;margin-bottom:8px}.priority-option span{font-size:16px;font-weight:700}
        .priority-option[data-priority="alta"] i{color:var(--danger)}.priority-option[data-priority="media"] i{color:var(--warning)}.priority-option[data-priority="baja"] i{color:var(--success)}
        .priority-option[data-priority="alta"].selected{border-color:var(--danger);background:rgba(198,40,40,0.1)}
        .priority-option[data-priority="media"].selected{border-color:var(--warning);background:rgba(245,124,0,0.1)}
        .priority-option[data-priority="baja"].selected{border-color:var(--success);background:rgba(46,125,50,0.1)}
        .slider-container{margin:20px 0}.slider-value{text-align:center;font-size:48px;font-weight:800;color:var(--primary);margin-bottom:15px}
        .slider-track{position:relative;height:60px;background:var(--bg-light);border-radius:30px;border:3px solid var(--border-light);overflow:hidden}
        .slider-fill{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--danger),var(--warning) 50%,var(--success));border-radius:30px}
        .slider-input{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;-webkit-appearance:none}
        .slider-marks{display:flex;justify-content:space-between;margin-top:10px;padding:0 5px}.slider-mark{font-size:16px;font-weight:600;color:var(--text-light)}
        .quick-100-btn{width:100%;padding:18px;margin-top:15px;background:linear-gradient(135deg,var(--success),var(--success-light));color:#fff;border:none;border-radius:var(--radius-md);font-size:20px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}.quick-100-btn:active{transform:scale(0.98)}
        .voice-container{position:relative}
        .voice-btn{position:absolute;right:10px;bottom:10px;width:50px;height:50px;background:var(--primary);color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center}.voice-btn:active{transform:scale(0.9)}.voice-btn.recording{background:var(--danger);animation:pulse 1s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        .save-btn{width:100%;padding:20px;margin-top:25px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border:none;border-radius:var(--radius-md);font-size:20px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
        .save-btn:disabled{opacity:0.7;cursor:not-allowed}.save-btn .spinner{width:24px;height:24px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .delete-btn{width:100%;padding:16px;margin-top:15px;background:var(--danger);color:#fff;border:none;border-radius:var(--radius-md);font-size:18px;font-weight:700;cursor:pointer}
        .toast-container{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:10px;pointer-events:none}
        .toast{background:var(--success);color:#fff;padding:18px 30px;border-radius:50px;font-weight:700;font-size:18px;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:12px;transform:translateY(100px);opacity:0;transition:all .4s;pointer-events:auto}
        .toast.show{opacity:1;transform:translateY(0)}.toast.error{background:var(--danger)}.toast.warning{background:var(--warning);color:var(--text-dark)}.toast i{font-size:24px}
        .offline-indicator{position:fixed;top:70px;left:0;right:0;background:var(--warning);color:var(--text-dark);padding:12px 20px;text-align:center;font-weight:700;font-size:16px;z-index:999;display:none}
        .offline-indicator.show{display:flex;align-items:center;justify-content:center;gap:10px}.offline-indicator i{font-size:20px}
        body.offline .main-content{margin-top:120px;height:calc(100vh - 120px)}
        .login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--primary),var(--primary-dark));display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;z-index:2000;padding:30px}
        .login-screen .logo{font-size:80px;margin-bottom:20px}.login-screen h1{font-size:28px;font-weight:800;margin-bottom:10px;text-align:center}.login-screen p{font-size:20px;margin-bottom:40px;opacity:0.9;text-align:center}
        .login-screen input{width:100%;max-width:400px;padding:20px 25px;margin:10px 0;font-size:24px;font-weight:700;border-radius:var(--radius-lg);border:none;background:#fff;color:var(--text-dark);text-align:center;letter-spacing:4px}
        .login-screen input::placeholder{letter-spacing:0;color:var(--text-light)}
        .login-screen button{width:100%;max-width:400px;padding:20px;margin:15px 0;font-size:20px;font-weight:700;border-radius:var(--radius-lg);border:none;cursor:pointer}
        .login-btn{background:var(--success);color:#fff}.login-btn:active{transform:scale(0.98)}.guest-btn{background:rgba(255,255,255,0.2);color:#fff}
        .login-error{color:#FFCDD2;font-size:18px;font-weight:600;margin-top:20px;min-height:30px}
        .toolbar{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}.toolbar select{padding:14px 18px;border-radius:var(--radius-md);border:3px solid var(--border-light);font-size:18px;font-weight:600;background:var(--bg-white)}
        .matrix-table-wrapper{overflow-x:auto;border:2px solid var(--primary);border-radius:var(--radius-md);background:var(--bg-white);margin-top:20px}
        .matrix-table{width:100%;border-collapse:collapse}.matrix-table th,.matrix-table td{min-width:100px;padding:12px;text-align:center;border:1px solid var(--border-light);font-size:14px;font-weight:600}
        .matrix-table th{background:var(--primary);color:#fff;position:sticky;top:0;z-index:2}
        .fixed-column{position:sticky;left:0;background:var(--bg-light);z-index:1;font-weight:700;cursor:pointer}.matrix-table th.fixed-column{background:var(--primary-dark);z-index:3}
        .cell-green{background:var(--success-light);color:#fff}.cell-orange{background:var(--warning-light);color:var(--text-dark)}.cell-red{background:var(--danger-light);color:#fff}.cell-gray{background:#E0E0E0;color:var(--text-medium);cursor:pointer}
        .trabajador-cursos{display:grid;gap:15px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
        .trabajador-curso-card{background:var(--bg-white);padding:25px;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);text-align:center;border:3px solid var(--border-light)}
        .trabajador-curso-card i{font-size:48px;margin-bottom:15px}.trabajador-curso-card h4{font-size:20px;margin-bottom:10px}
        .trabajador-curso-card.cell-green{background:var(--success-light);color:#fff;border-color:var(--success)}
        .trabajador-curso-card.cell-orange{background:var(--warning-light);color:var(--text-dark);border-color:var(--warning)}
        .trabajador-curso-card.cell-red{background:var(--danger-light);color:#fff;border-color:var(--danger)}
        .history-item{padding:15px;background:var(--bg-light);border-radius:var(--radius-sm);margin-bottom:10px;border-left:4px solid var(--primary)}.history-item strong{color:var(--primary-dark)}.history-item small{color:var(--text-light);display:block;margin-top:5px}
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-light)}.empty-state i{font-size:80px;margin-bottom:20px;opacity:0.5}.empty-state p{font-size:20px;font-weight:600}
        @media(max-width:768px){.header{height:65px}.header-title{font-size:18px}.user-info{display:none}.main-content{margin-top:65px;padding:15px;height:calc(100vh - 65px)}.section-title{font-size:24px}body.offline .main-content{margin-top:115px;height:calc(100vh - 115px)}}
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>
    <div class="offline-indicator" id="offline-indicator"><i class="fas fa-wifi-slash"></i><span>Sin conexi√≥n - Se guardar√° al reconectar</span></div>
    <div id="login-screen" class="login-screen">
        <div class="logo"><i class="fas fa-hard-hat"></i></div>
        <h1>Hidrogeolog√≠a Trabajos</h1>
        <p>Ingrese su DNI para acceder</p>
        <input type="tel" id="dni-input" placeholder="12345678" maxlength="8" inputmode="numeric">
        <button class="login-btn" onclick="login()"><i class="fas fa-sign-in-alt"></i> INGRESAR</button>
        <button class="guest-btn" onclick="loginAsGuest()"><i class="fas fa-user"></i> Entrar como Invitado</button>
        <p class="login-error" id="login-error"></p>
    </div>
    <div id="app" style="display:none;">
        <div class="header">
            <div class="hamburger" onclick="toggleDrawer()">‚ò∞</div>
            <div class="header-title" id="section-title">Pendientes</div>
            <div class="user-info" id="user-info"></div>
        </div>
        <div class="overlay" onclick="toggleDrawer()"></div>
        <div class="drawer" id="drawer">
            <button id="btn-pendientes" class="active" onclick="loadPendientes();toggleDrawer()"><i class="fas fa-clipboard-list"></i> Pendientes</button>
            <button id="btn-cursos" onclick="loadCursosSection();toggleDrawer()"><i class="fas fa-graduation-cap"></i> Cursos</button>
            <button class="logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</button>
        </div>
        <div class="main-content"><h2 class="section-title" id="main-title">Pendientes</h2><div id="content"></div></div>
        <button class="fab" id="fab" onclick="openNewObsModal()"><i class="fas fa-plus"></i></button>
    </div>
    <div id="personal-dni-modal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('personal-dni-modal')">&times;</span><h3>Informaci√≥n del Personal</h3><p style="font-size:20px;margin:15px 0;"><strong>Nombre:</strong><br><span id="modal-personal-nombre"></span></p><p style="font-size:20px;margin:15px 0;"><strong>DNI:</strong><br><span id="modal-personal-dni"></span></p></div></div>
    <div id="new-obs-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('new-obs-modal')">&times;</span>
            <h3><i class="fas fa-plus-circle"></i> Nueva Observaci√≥n</h3>
            <label>Sector:</label>
            <div class="sector-selector">
                <div class="sector-option" data-sector="pozos" onclick="selectSector('pozos')"><i class="fas fa-tint"></i><span>Pozos</span></div>
                <div class="sector-option" data-sector="pozas" onclick="selectSector('pozas')"><i class="fas fa-water"></i><span>Pozas</span></div>
                <div class="sector-option" data-sector="pb1" onclick="selectSector('pb1')"><i class="fas fa-industry"></i><span>PB1</span></div>
                <div class="sector-option" data-sector="well_point" onclick="selectSector('well_point')"><i class="fas fa-faucet"></i><span>Well Point</span></div>
            </div>
            <input type="hidden" id="new-obs-sector">
            <label>Prioridad:</label>
            <div class="priority-selector">
                <div class="priority-option" data-priority="alta" onclick="selectPriority('alta')"><i class="fas fa-exclamation-circle"></i><span>ALTA</span></div>
                <div class="priority-option selected" data-priority="media" onclick="selectPriority('media')"><i class="fas fa-minus-circle"></i><span>MEDIA</span></div>
                <div class="priority-option" data-priority="baja" onclick="selectPriority('baja')"><i class="fas fa-arrow-circle-down"></i><span>BAJA</span></div>
            </div>
            <input type="hidden" id="new-obs-priority" value="media">
            <label>Descripci√≥n:</label>
            <div class="voice-container"><textarea id="new-obs-desc" rows="4" placeholder="Describe la observaci√≥n..."></textarea><button class="voice-btn" id="voice-btn" onclick="toggleVoice()"><i class="fas fa-microphone"></i></button></div>
            <label>% de Avance:</label>
            <div class="slider-container">
                <div class="slider-value" id="slider-value">0%</div>
                <div class="slider-track"><div class="slider-fill" id="slider-fill" style="width:0%"></div><input type="range" class="slider-input" id="new-obs-progress" min="0" max="100" value="0" oninput="updateSlider(this.value)"></div>
                <div class="slider-marks"><span class="slider-mark">0%</span><span class="slider-mark">25%</span><span class="slider-mark">50%</span><span class="slider-mark">75%</span><span class="slider-mark">100%</span></div>
            </div>
            <button class="quick-100-btn" onclick="setProgress100()"><i class="fas fa-check-double"></i> MARCAR 100% LISTO</button>
            <div id="resolved-comment-div" style="display:none;margin-top:20px;"><label>Comentario de resoluci√≥n:</label><textarea id="resolved-comment" rows="3" placeholder="¬øC√≥mo lo resolviste?"></textarea></div>
            <button id="save-new-obs-btn" class="save-btn" onclick="saveNewObs()"><span class="btn-text"><i class="fas fa-save"></i> GUARDAR</span></button>
        </div>
    </div>
    <div id="detail-obs-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('detail-obs-modal')">&times;</span>
            <h3><i class="fas fa-info-circle"></i> Detalle</h3>
            <div style="background:var(--bg-light);padding:20px;border-radius:var(--radius-md);margin-bottom:20px;">
                <p style="font-size:20px;margin-bottom:15px;"><strong>Descripci√≥n:</strong><br><span id="detail-desc"></span></p>
                <p><strong>Sector:</strong> <span id="detail-sector"></span></p>
                <p><strong>Prioridad:</strong> <span id="detail-priority"></span></p>
                <p><strong>Reportado por:</strong> <span id="detail-reportado"></span></p>
                <p><strong>Fecha:</strong> <span id="detail-fecha"></span></p>
            </div>
            <div style="background:var(--bg-light);border-radius:12px;height:30px;margin:20px 0;overflow:hidden;"><div class="progress-bar" id="detail-progress-bar" style="height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;">0%</div></div>
            <div id="detail-resuelto-div" style="display:none;margin-top:20px;padding:20px;background:rgba(46,125,50,0.1);border-radius:var(--radius-md);border:2px solid var(--success);"><p style="color:var(--success);font-weight:700;font-size:20px;margin-bottom:10px;"><i class="fas fa-check-circle"></i> RESUELTO</p><p><strong>Comentario:</strong> <span id="detail-comentario"></span></p><p><strong>Fecha resoluci√≥n:</strong> <span id="detail-fecha-res"></span></p></div>
            <div id="update-progress-div" style="margin-top:25px;">
                <label>Actualizar Avance:</label>
                <div class="slider-container"><div class="slider-value" id="update-slider-value">0%</div><div class="slider-track"><div class="slider-fill" id="update-slider-fill" style="width:0%"></div><input type="range" class="slider-input" id="update-progress" min="0" max="100" value="0" oninput="updateDetailSlider(this.value)"></div></div>
                <button class="quick-100-btn" onclick="setUpdateProgress100()" style="margin-bottom:15px;"><i class="fas fa-check-double"></i> MARCAR 100% LISTO</button>
                <label>Comentario (obligatorio):</label><textarea id="update-comment" rows="3" placeholder="Describe el avance..."></textarea>
                <button class="save-btn" onclick="updateProgress()"><span class="btn-text"><i class="fas fa-sync-alt"></i> ACTUALIZAR</span></button>
            </div>
            <div style="margin-top:25px;"><label><i class="fas fa-history"></i> Historial:</label><div id="history-list" style="margin-top:10px;"></div></div>
            <div id="delete-div" style="display:none;"><button class="delete-btn" onclick="deleteCurrentObs()"><i class="fas fa-trash-alt"></i> ELIMINAR</button></div>
        </div>
    </div>
    <div id="add-curso-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('add-curso-modal')">&times;</span>
            <h3 id="curso-modal-title"><i class="fas fa-graduation-cap"></i> A√±adir Curso</h3>
            <label>Personal:</label><select id="curso-dni"><option value="">Seleccione personal</option></select>
            <label>Nombre del Curso:</label><input type="text" id="curso-nombre" placeholder="Ej: Trabajo en Altura">
            <label>Fecha de Vencimiento:</label><input type="date" id="curso-venc">
            <button id="save-curso" class="save-btn"><i class="fas fa-save"></i> GUARDAR</button>
            <button id="delete-curso" class="delete-btn" style="display:none;"><i class="fas fa-trash-alt"></i> ELIMINAR</button>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script>
    const firebaseConfig={apiKey:"AIzaSyAyhP0Ak3ziNrGTCFHKlFr7-_HAMimYX_g",authDomain:"trabajos---xylem.firebaseapp.com",projectId:"trabajos---xylem",storageBucket:"trabajos---xylem.firebasestorage.app",messagingSenderId:"719564556454",appId:"1:719564556454:web:22e10612163f79d4b5cc67"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();
    db.enablePersistence({synchronizeTabs:true}).catch(function(e){console.log('Persistencia:',e.code)});

    const usuarios=[{nombre:"TURPO CALLOHUANCA CESAR JHONY",dni:"40968321",rol:"supervisor"},{nombre:"ASTULLE AZA WILLY ENRIQUE",dni:"41834020",rol:"supervisor"},{nombre:"LIMASCA CHAHUAYO AMERICO",dni:"46146718",rol:"trabajador"},{nombre:"HUAMANI QUIO OSCAR EMILIO",dni:"72156518",rol:"supervisor"},{nombre:"PEREZ VARIAS WALTER SERGEY",dni:"29419804",rol:"trabajador"},{nombre:"CONDORI HUANCA FREDY",dni:"29652867",rol:"trabajador"},{nombre:"LLAIQUE QUISPE SAMUEL",dni:"76647913",rol:"trabajador"},{nombre:"GOMEZ LACACTA JOSE LUIS",dni:"47673736",rol:"trabajador"},{nombre:"QUSIPE YUCRA GILBER SILVESTRE",dni:"46759346",rol:"trabajador"},{nombre:"QUINA BARRIGA CARLOS FERMANDO",dni:"29320149",rol:"trabajador"},{nombre:"FUENTES FUENTES JOSE",dni:"04431627",rol:"trabajador"},{nombre:"SUCASACA YUCRA JUAN NOE",dni:"47057969",rol:"trabajador"},{nombre:"CCAHUANA HUAMANI MARCO ANTONIO",dni:"74752120",rol:"trabajador"},{nombre:"QUISPE YUCRA JUAN CARLOS",dni:"78374316",rol:"trabajador"},{nombre:"PAUCCARA HUAMANI HUGO",dni:"24893792",rol:"trabajador"},{nombre:"HUAYTA MAMANI HUGO ELOY",dni:"29685210",rol:"trabajador"},{nombre:"QUISPE APAZA JUAN CARLOS",dni:"71994478",rol:"trabajador"},{nombre:"SUPHO TUNQUIPA EVER",dni:"44672755",rol:"trabajador"},{nombre:"MERMA CRUZ MARCO ANTONIO",dni:"72271044",rol:"trabajador"},{nombre:"PPACCO HUAMANI ALEX",dni:"74164942",rol:"trabajador"},{nombre:"HUANCA CONDORI EVENISTER ADAN",dni:"04430425",rol:"trabajador"},{nombre:"FLOREZ ARQUE WILLAM",dni:"44626323",rol:"supervisor"}];

    let currentUser=null,currentSection='pendientes',currentSectorFilter='todos',currentSearchQuery='',currentCharts=[],recognition=null,isRecording=false,currentObsId=null,editingCursoId=null,pendingOfflineOps=[],isOnline=navigator.onLine;
    const sectorIcons={pozos:'fa-tint',pozas:'fa-water',pb1:'fa-industry',well_point:'fa-faucet'};
    const priorityLabels={alta:'ALTA',media:'MEDIA',baja:'BAJA'};

    function showToast(msg,type){type=type||'success';var c=document.getElementById('toast-container'),t=document.createElement('div');t.className='toast '+type;var i=type==='error'?'times-circle':type==='warning'?'exclamation-triangle':'check-circle';t.innerHTML='<i class="fas fa-'+i+'"></i><span>'+msg+'</span>';c.appendChild(t);if(navigator.vibrate)navigator.vibrate(type==='error'?[100,50,100]:100);setTimeout(function(){t.classList.add('show')},10);setTimeout(function(){t.classList.remove('show');setTimeout(function(){t.remove()},400)},3500);}

    function updateOnlineStatus(){isOnline=navigator.onLine;var ind=document.getElementById('offline-indicator');if(!isOnline){ind.classList.add('show');document.body.classList.add('offline');showToast('Sin conexi√≥n','warning');}else{ind.classList.remove('show');document.body.classList.remove('offline');if(pendingOfflineOps.length>0){showToast('Sincronizando...','success');syncPendingOps();}}}
    function syncPendingOps(){var ops=pendingOfflineOps.slice();pendingOfflineOps=[];ops.forEach(function(op){if(op.type==='add')db.collection('observaciones').add(op.data).catch(function(){pendingOfflineOps.push(op)});else if(op.type==='update')db.collection('observaciones').doc(op.id).update(op.data).catch(function(){pendingOfflineOps.push(op)})});localStorage.setItem('pendingOps',JSON.stringify(pendingOfflineOps));}
    window.addEventListener('online',updateOnlineStatus);window.addEventListener('offline',updateOnlineStatus);

    function destroyCharts(){currentCharts.forEach(function(c){if(c)c.destroy()});currentCharts=[];}
    function toggleDrawer(){document.getElementById('drawer').classList.toggle('open');document.querySelector('.overlay').classList.toggle('active');}
    function closeModal(id){document.getElementById(id).style.display='none';if(recognition&&isRecording){recognition.stop();isRecording=false;}}
    function relativeTime(d){if(!d)return'Fecha desconocida';var now=new Date(),diff=now-d,mins=Math.floor(diff/60000),hrs=Math.floor(diff/3600000),days=Math.floor(diff/86400000);if(mins<1)return'Ahora';if(mins<60)return'Hace '+mins+' min';if(hrs<24)return'Hace '+hrs+'h';if(days===1)return'Ayer';if(days<7)return'Hace '+days+' d√≠as';return d.toLocaleDateString('es-PE');}
    function getProgressColor(p){if(p===100)return'var(--success)';if(p>=50)return'var(--warning)';return'var(--danger)';}

    function selectSector(s){document.querySelectorAll('.sector-option').forEach(function(e){e.classList.remove('selected')});document.querySelector('.sector-option[data-sector="'+s+'"]').classList.add('selected');document.getElementById('new-obs-sector').value=s;}
    function selectPriority(p){document.querySelectorAll('.priority-option').forEach(function(e){e.classList.remove('selected')});document.querySelector('.priority-option[data-priority="'+p+'"]').classList.add('selected');document.getElementById('new-obs-priority').value=p;}
    function updateSlider(v){document.getElementById('slider-value').textContent=v+'%';document.getElementById('slider-fill').style.width=v+'%';document.getElementById('resolved-comment-div').style.display=v==100?'block':'none';}
    function updateDetailSlider(v){document.getElementById('update-slider-value').textContent=v+'%';document.getElementById('update-slider-fill').style.width=v+'%';}
    function setProgress100(){document.getElementById('new-obs-progress').value=100;updateSlider(100);}
    function setUpdateProgress100(){document.getElementById('update-progress').value=100;updateDetailSlider(100);}

    function toggleVoice(){var btn=document.getElementById('voice-btn');if(!('SpeechRecognition'in window||'webkitSpeechRecognition'in window)){showToast('Voz no disponible','error');return;}if(!recognition){recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition)();recognition.lang='es-PE';recognition.continuous=true;recognition.interimResults=true;recognition.onresult=function(e){var t='';for(var i=e.resultIndex;i<e.results.length;i++)t+=e.results[i][0].transcript;document.getElementById('new-obs-desc').value+=t+' ';};recognition.onend=function(){isRecording=false;btn.classList.remove('recording');btn.innerHTML='<i class="fas fa-microphone"></i>';};recognition.onerror=function(){isRecording=false;btn.classList.remove('recording');showToast('Error de voz','error');};}if(isRecording){recognition.stop();isRecording=false;btn.classList.remove('recording');btn.innerHTML='<i class="fas fa-microphone"></i>';}else{recognition.start();isRecording=true;btn.classList.add('recording');btn.innerHTML='<i class="fas fa-stop"></i>';showToast('Grabando...','warning');}}

    function login(){var dni=document.getElementById('dni-input').value.trim(),err=document.getElementById('login-error');if(!dni){err.textContent='Ingrese su DNI';return;}if(!/^\d{8}$/.test(dni)){err.textContent='DNI debe tener 8 d√≠gitos';return;}var u=usuarios.find(function(x){return x.dni===dni});if(u){currentUser={nombre:u.nombre,rol:u.rol,dni:u.dni};localStorage.setItem('user',JSON.stringify(currentUser));document.getElementById('app').style.display='block';document.getElementById('login-screen').style.display='none';updateHeader();loadPendientes();showToast('¬°Bienvenido, '+u.nombre.split(' ')[0]+'!');}else{err.textContent='DNI no registrado';}}
    function loginAsGuest(){currentUser={nombre:'Invitado',rol:'supervisor',dni:'00000000'};document.getElementById('app').style.display='block';document.getElementById('login-screen').style.display='none';updateHeader();loadPendientes();showToast('Ingresaste como invitado');}
    function logout(){localStorage.removeItem('user');location.reload();}
    function updateHeader(){document.getElementById('user-info').textContent=currentUser.nombre.split(' ')[0];}

    function handleSearch(q){currentSearchQuery=q.toLowerCase().trim();var cl=document.querySelector('.search-clear');if(cl)cl.classList.toggle('show',q.length>0);loadObservations();}
    function clearSearch(){document.getElementById('search-input').value='';currentSearchQuery='';var cl=document.querySelector('.search-clear');if(cl)cl.classList.remove('show');loadObservations();}

    function loadPendientes(){currentSection='pendientes';document.getElementById('main-title').textContent='Pendientes';document.getElementById('btn-pendientes').classList.add('active');document.getElementById('btn-cursos').classList.remove('active');document.getElementById('fab').style.display='flex';
        var html='<div class="quick-actions"><button class="quick-action-btn btn-new-obs" onclick="openNewObsModal()"><i class="fas fa-plus"></i><span>NUEVA</span></button><button class="quick-action-btn btn-pending" onclick="setSectorFilter(\'todos\')"><i class="fas fa-list"></i><span>VER TODO</span></button><button class="quick-action-btn btn-courses" onclick="loadCursosSection()"><i class="fas fa-graduation-cap"></i><span>CURSOS</span></button></div><div class="search-container"><i class="fas fa-search search-icon"></i><input type="text" class="search-input" id="search-input" placeholder="Buscar..." oninput="handleSearch(this.value)"><i class="fas fa-times search-clear" onclick="clearSearch()"></i></div><div class="tabs" id="obs-tabs"></div>';
        if(currentUser.rol==='supervisor')html+='<div class="toolbar" id="supervisor-toolbar"></div>';
        html+='<div class="dashboard" id="obs-dashboard"></div><div class="obs-cards" id="obs-cards"></div>';
        document.getElementById('content').innerHTML=html;renderTabs();
        if(currentUser.rol==='supervisor')document.getElementById('supervisor-toolbar').innerHTML='<select id="date-filter" onchange="handleDateFilter()"><option value="todos">üìÖ Todas</option><option value="hoy">üìå Hoy</option><option value="semana">üìÜ Semana</option><option value="rango">üìÜ Elegir fechas</option></select><div id="date-range-container" style="display:none;flex-wrap:wrap;gap:10px;margin-top:10px;width:100%;"><div style="display:flex;align-items:center;gap:8px;"><label style="font-weight:700;font-size:16px;">Desde:</label><input type="date" id="date-from" onchange="loadObservations()" style="padding:12px;border-radius:12px;border:3px solid var(--border-light);font-size:16px;font-weight:600;"></div><div style="display:flex;align-items:center;gap:8px;"><label style="font-weight:700;font-size:16px;">Hasta:</label><input type="date" id="date-to" onchange="loadObservations()" style="padding:12px;border-radius:12px;border:3px solid var(--border-light);font-size:16px;font-weight:600;"></div></div>';
        loadObservations();}

    function renderTabs(){var tabs=document.getElementById('obs-tabs');var h='<div class="tab '+(currentSectorFilter==='todos'?'active':'')+'" onclick="setSectorFilter(\'todos\')">Todos</div>';['pozos','pozas','pb1','well_point'].forEach(function(s){var l=s.charAt(0).toUpperCase()+s.slice(1).replace('_',' ');h+='<div class="tab '+(currentSectorFilter===s?'active':'')+'" onclick="setSectorFilter(\''+s+'\')">'+l+'</div>';});tabs.innerHTML=h;}
    function setSectorFilter(f){currentSectorFilter=f;renderTabs();loadObservations();}

    function handleDateFilter(){var fv=document.getElementById('date-filter').value;var rangeContainer=document.getElementById('date-range-container');if(rangeContainer){if(fv==='rango'){rangeContainer.style.display='flex';}else{rangeContainer.style.display='none';loadObservations();}}}

    function loadObservations(){destroyCharts();db.collection('observaciones').onSnapshot(function(snap){var obs=[];snap.forEach(function(doc){var d=doc.data();d.id=doc.id;d.fechaReporteDate=d.fechaReporte?d.fechaReporte.toDate():new Date();d.progress=d.progress||0;d.priority=d.priority||'media';d.history=d.history||[];obs.push(d);});var filtered=obs;
        if(currentSectorFilter!=='todos')filtered=filtered.filter(function(o){return o.sector===currentSectorFilter});
        if(currentSearchQuery)filtered=filtered.filter(function(o){return(o.descripcion&&o.descripcion.toLowerCase().indexOf(currentSearchQuery)>-1)||(o.reportadoPor&&o.reportadoPor.toLowerCase().indexOf(currentSearchQuery)>-1)});
        if(currentUser.rol==='supervisor'){var fv=document.getElementById('date-filter');fv=fv?fv.value:'todos';var today=new Date();today.setHours(0,0,0,0);if(fv==='hoy')filtered=filtered.filter(function(o){var d=new Date(o.fechaReporteDate);d.setHours(0,0,0,0);return d.getTime()===today.getTime();});else if(fv==='semana'){var wa=new Date(today);wa.setDate(today.getDate()-7);filtered=filtered.filter(function(o){return o.fechaReporteDate>=wa});}else if(fv==='rango'){var fromEl=document.getElementById('date-from'),toEl=document.getElementById('date-to');if(fromEl&&fromEl.value&&toEl&&toEl.value){var fromDate=new Date(fromEl.value);fromDate.setHours(0,0,0,0);var toDate=new Date(toEl.value);toDate.setHours(23,59,59,999);filtered=filtered.filter(function(o){return o.fechaReporteDate>=fromDate&&o.fechaReporteDate<=toDate;});}}}
        renderObsDashboard(filtered);renderObsCards(filtered);},function(e){console.error(e);showToast('Error cargando datos','error');});}

    function renderObsDashboard(data){var dash=document.getElementById('obs-dashboard'),total=data.length,pend=data.filter(function(o){return o.progress<100}).length,res=data.filter(function(o){return o.progress===100}).length,urg=data.filter(function(o){return o.priority==='alta'&&o.progress<100}).length;
        dash.innerHTML='<div class="card card-primary"><i class="fas fa-clipboard-list"></i><h4>TOTAL</h4><div class="big-number primary">'+total+'</div></div><div class="card card-danger"><i class="fas fa-exclamation-triangle"></i><h4>PENDIENTES</h4><div class="big-number red">'+pend+'</div></div><div class="card card-success"><i class="fas fa-check-circle"></i><h4>RESUELTOS</h4><div class="big-number green">'+res+'</div></div><div class="card card-warning"><i class="fas fa-bolt"></i><h4>URGENTES</h4><div class="big-number orange">'+urg+'</div></div>';}

    function renderObsCards(data){data.sort(function(a,b){var po={alta:0,media:1,baja:2};if(a.progress<100&&b.progress<100&&po[a.priority]!==po[b.priority])return po[a.priority]-po[b.priority];return b.fechaReporteDate-a.fechaReporteDate;});var c=document.getElementById('obs-cards');
        if(data.length===0){c.innerHTML='<div class="empty-state"><i class="fas fa-clipboard-check"></i><p>No hay observaciones</p></div>';return;}
        var h='';data.forEach(function(o){var sec=o.sector||'pozos',icon=sectorIcons[sec]||'fa-question',prog=o.progress||0,cls=prog===100?'resolved':prog>0?'partial':'',pri=o.priority||'media';
            h+='<div class="obs-card '+cls+'" onclick="openDetailObs(\''+o.id+'\')">'+(prog<100?'<span class="priority-indicator priority-'+pri+'">'+priorityLabels[pri]+'</span>':'')+'<div class="obs-card-header"><div class="sector-icon '+sec+'"><i class="fas '+icon+'"></i></div><div class="obs-card-info"><h3>'+(o.descripcion||'Sin descripci√≥n')+'</h3><div class="obs-card-meta"><span><i class="fas fa-map-marker-alt"></i> '+(sec.charAt(0).toUpperCase()+sec.slice(1).replace('_',' '))+'</span><span><i class="fas fa-clock"></i> '+relativeTime(o.fechaReporteDate)+'</span></div></div></div><div class="progress-container"><div class="progress-bar" style="width:'+prog+'%;background:'+getProgressColor(prog)+';">'+prog+'%</div></div><div class="badges"><span class="badge '+(prog===100?'badge-resuelto':'badge-pendiente')+'">'+(prog===100?'‚úì Resuelto':'‚è≥ Pendiente')+'</span></div></div>';});c.innerHTML=h;}

    function openNewObsModal(){document.querySelectorAll('.sector-option').forEach(function(e){e.classList.remove('selected')});document.getElementById('new-obs-sector').value='';document.querySelectorAll('.priority-option').forEach(function(e){e.classList.remove('selected')});document.querySelector('.priority-option[data-priority="media"]').classList.add('selected');document.getElementById('new-obs-priority').value='media';document.getElementById('new-obs-desc').value='';document.getElementById('new-obs-progress').value=0;updateSlider(0);document.getElementById('resolved-comment-div').style.display='none';document.getElementById('resolved-comment').value='';document.getElementById('new-obs-modal').style.display='block';}

    function saveNewObs(){var btn=document.getElementById('save-new-obs-btn'),txt=btn.querySelector('.btn-text'),sec=document.getElementById('new-obs-sector').value,desc=document.getElementById('new-obs-desc').value.trim(),prog=parseInt(document.getElementById('new-obs-progress').value)||0,pri=document.getElementById('new-obs-priority').value||'media';
        if(!sec){showToast('Selecciona un sector','error');return;}if(!desc){showToast('Escribe descripci√≥n','error');return;}
        var com='';if(prog===100){com=document.getElementById('resolved-comment').value.trim();if(!com){showToast('Agrega comentario','error');return;}}
        btn.disabled=true;txt.innerHTML='<div class="spinner"></div> GUARDANDO...';
        var hist={user:currentUser.nombre,timestamp:new Date(),progress:prog,comment:com||'Creaci√≥n'};
        var data={sector:sec,descripcion:desc,priority:pri,reportadoPor:currentUser.nombre,fechaReporte:firebase.firestore.FieldValue.serverTimestamp(),progress:prog,resuelto:prog===100,comentarioResolucion:prog===100?com:null,fechaResolucion:prog===100?firebase.firestore.FieldValue.serverTimestamp():null,history:[hist]};
        db.collection('observaciones').add(data).then(function(){closeModal('new-obs-modal');showToast('Guardado correctamente');btn.disabled=false;txt.innerHTML='<i class="fas fa-save"></i> GUARDAR';}).catch(function(e){console.error(e);if(!isOnline){pendingOfflineOps.push({type:'add',data:data});localStorage.setItem('pendingOps',JSON.stringify(pendingOfflineOps));closeModal('new-obs-modal');showToast('Guardado local','warning');}else showToast('Error al guardar','error');btn.disabled=false;txt.innerHTML='<i class="fas fa-save"></i> GUARDAR';});}

    function openDetailObs(id){currentObsId=id;db.collection('observaciones').doc(id).get().then(function(doc){if(!doc.exists){showToast('No encontrado','error');return;}var o=doc.data();o.fechaReporteDate=o.fechaReporte?o.fechaReporte.toDate():new Date();o.progress=o.progress||0;o.priority=o.priority||'media';o.history=o.history||[];
        document.getElementById('detail-desc').textContent=o.descripcion||'Sin descripci√≥n';document.getElementById('detail-sector').textContent=o.sector?(o.sector.charAt(0).toUpperCase()+o.sector.slice(1).replace('_',' ')):'';document.getElementById('detail-priority').innerHTML='<span class="badge priority-'+o.priority+'" style="background:'+(o.priority==='alta'?'var(--danger-light)':o.priority==='media'?'var(--warning-light)':'var(--success-light)')+';color:'+(o.priority==='media'?'var(--text-dark)':'#fff')+';">'+priorityLabels[o.priority]+'</span>';document.getElementById('detail-reportado').textContent=o.reportadoPor||'Desconocido';document.getElementById('detail-fecha').textContent=relativeTime(o.fechaReporteDate);
        var pb=document.getElementById('detail-progress-bar');pb.style.width=o.progress+'%';pb.style.backgroundColor=getProgressColor(o.progress);pb.textContent=o.progress+'%';document.getElementById('update-progress').value=o.progress;updateDetailSlider(o.progress);
        if(o.resuelto||o.progress===100){document.getElementById('detail-resuelto-div').style.display='block';document.getElementById('detail-comentario').textContent=o.comentarioResolucion||'';document.getElementById('detail-fecha-res').textContent=o.fechaResolucion?o.fechaResolucion.toDate().toLocaleDateString('es-PE'):'';document.getElementById('update-progress-div').style.display='none';}else{document.getElementById('detail-resuelto-div').style.display='none';document.getElementById('update-progress-div').style.display='block';}
        var hl=document.getElementById('history-list');if(o.history.length===0)hl.innerHTML='<p style="color:var(--text-light);">Sin historial</p>';else{o.history.sort(function(a,b){var da=a.timestamp&&a.timestamp.toDate?a.timestamp.toDate():new Date(a.timestamp);var db=b.timestamp&&b.timestamp.toDate?b.timestamp.toDate():new Date(b.timestamp);return db-da;});hl.innerHTML=o.history.map(function(e){var d=e.timestamp&&e.timestamp.toDate?e.timestamp.toDate():new Date(e.timestamp);return'<div class="history-item"><strong>'+(e.user||'?')+'</strong> - '+e.progress+'%<br>'+(e.comment||'')+'<small>'+d.toLocaleString('es-PE')+'</small></div>';}).join('');}
        document.getElementById('delete-div').style.display=(currentUser.rol==='supervisor'&&currentUser.nombre!=='Invitado')?'block':'none';document.getElementById('detail-obs-modal').style.display='block';}).catch(function(e){console.error(e);showToast('Error','error');});}

    function updateProgress(){var np=parseInt(document.getElementById('update-progress').value),com=document.getElementById('update-comment').value.trim();if(isNaN(np)||np<0||np>100){showToast('Porcentaje inv√°lido','error');return;}if(!com){showToast('Agrega comentario','error');return;}
        var hist={user:currentUser.nombre,timestamp:new Date(),progress:np,comment:com},upd={progress:np,history:firebase.firestore.FieldValue.arrayUnion(hist)};if(np===100){upd.resuelto=true;upd.comentarioResolucion=com;upd.fechaResolucion=firebase.firestore.FieldValue.serverTimestamp();}
        db.collection('observaciones').doc(currentObsId).update(upd).then(function(){showToast('Actualizado');closeModal('detail-obs-modal');}).catch(function(e){console.error(e);if(!isOnline){pendingOfflineOps.push({type:'update',id:currentObsId,data:upd});localStorage.setItem('pendingOps',JSON.stringify(pendingOfflineOps));showToast('Guardado local','warning');closeModal('detail-obs-modal');}else showToast('Error','error');});}

    function deleteCurrentObs(){if(confirm('¬øEliminar permanentemente?'))db.collection('observaciones').doc(currentObsId).delete().then(function(){showToast('Eliminado');closeModal('detail-obs-modal');}).catch(function(e){console.error(e);showToast('Error','error');});}

    function loadCursosSection(){currentSection='cursos';document.getElementById('main-title').textContent='Cursos de Seguridad';document.getElementById('btn-cursos').classList.add('active');document.getElementById('btn-pendientes').classList.remove('active');document.getElementById('fab').style.display='none';if(currentUser.rol==='trabajador')loadCursosTrabajador();else loadCursosSupervisor();}

    function loadCursosTrabajador(){var cont=document.getElementById('content');cont.innerHTML='<div class="dashboard" id="cursos-dashboard-trab"></div><div class="trabajador-cursos" id="cursos-list-trab"></div>';var u=usuarios.find(function(x){return x.nombre===currentUser.nombre});if(!u)return;
        db.collection('cursos').get().then(function(snap){var all=[];snap.forEach(function(doc){var d=doc.data();d.id=doc.id;all.push(d)});var cursos=all.filter(function(c){return(c.dni&&c.dni===u.dni)||c.personal===currentUser.nombre});var vig=0,pv=0,ven=0;var today=new Date();today.setHours(0,0,0,0);
            cursos.forEach(function(c){var v=c.vencimiento?c.vencimiento.toDate():new Date();v.setHours(0,0,0,0);var d=Math.ceil((v-today)/(1000*60*60*24));if(d>90)vig++;else if(d>0)pv++;else ven++;});
            document.getElementById('cursos-dashboard-trab').innerHTML='<div class="card card-success"><i class="fas fa-check-circle"></i><h4>VIGENTES</h4><div class="big-number green">'+vig+'</div></div><div class="card card-warning"><i class="fas fa-clock"></i><h4>POR VENCER</h4><div class="big-number orange">'+pv+'</div></div><div class="card card-danger"><i class="fas fa-exclamation-triangle"></i><h4>VENCIDOS</h4><div class="big-number red">'+ven+'</div></div><div class="card card-primary"><i class="fas fa-graduation-cap"></i><h4>TOTAL</h4><div class="big-number primary">'+cursos.length+'</div></div>';
            var lh='';cursos.forEach(function(c){var v=c.vencimiento?c.vencimiento.toDate():new Date();var d=Math.ceil((v-today)/(1000*60*60*24));var dt=d>0?d+' d√≠as':d===0?'Vence hoy':'Vencido '+(-d)+'d';var cc=d>90?'cell-green':d>0?'cell-orange':'cell-red';lh+='<div class="trabajador-curso-card '+cc+'"><i class="fas fa-certificate"></i><h4>'+(c.curso||'Sin nombre')+'</h4><p><strong>'+dt+'</strong><br><small>'+v.toLocaleDateString('es-PE')+'</small></p></div>';});if(cursos.length===0)lh='<div class="empty-state" style="grid-column:1/-1;"><i class="fas fa-graduation-cap"></i><p>Sin cursos registrados</p></div>';document.getElementById('cursos-list-trab').innerHTML=lh;});}

    function loadCursosSupervisor(){var cont=document.getElementById('content');cont.innerHTML='<button class="save-btn" style="margin-bottom:20px;" onclick="openAddCursoModal()"><i class="fas fa-plus"></i> A√ëADIR CURSO</button><div class="dashboard" id="cursos-dashboard"></div><div class="matrix-table-wrapper"><table class="matrix-table"><thead id="matrix-thead"></thead><tbody id="matrix-tbody"></tbody></table></div>';
        db.collection('cursos').get().then(function(snap){var cd=[];snap.forEach(function(doc){var d=doc.data();d.id=doc.id;cd.push(d);});var up=usuarios.map(function(u){return u.nombre}).sort(),mx={};up.forEach(function(p){mx[p]={};});var vig=0,pv=0,ven=0;var pc=new Set(),today=new Date();today.setHours(0,0,0,0);
            up.forEach(function(p){var u=usuarios.find(function(x){return x.nombre===p});if(!u)return;var pcs=cd.filter(function(c){return(c.dni&&c.dni===u.dni)||c.personal===p});pcs.forEach(function(c){var cn=c.curso||'Sin nombre';if(!mx[p][cn])mx[p][cn]=null;var v=c.vencimiento?c.vencimiento.toDate():new Date();v.setHours(0,0,0,0);var d=Math.ceil((v-today)/(1000*60*60*24));mx[p][cn]={days:d,date:v,id:c.id};if(d>90)vig++;else if(d>0){pv++;pc.add(p);}else{ven++;pc.add(p);}});});
            var uc=[];cd.forEach(function(c){if(c.curso&&uc.indexOf(c.curso)===-1)uc.push(c.curso)});uc.sort();
            document.getElementById('cursos-dashboard').innerHTML='<div class="card card-primary"><i class="fas fa-users"></i><h4>PERSONAL</h4><div class="big-number primary">'+up.length+'</div></div><div class="card card-success"><i class="fas fa-certificate"></i><h4>VIGENTES</h4><div class="big-number green">'+vig+'</div></div><div class="card card-warning"><i class="fas fa-user-clock"></i><h4>CR√çTICOS</h4><div class="big-number orange">'+pc.size+'</div></div><div class="card card-danger"><i class="fas fa-times-circle"></i><h4>VENCIDOS</h4><div class="big-number red">'+ven+'</div></div>';
            var pcrit={};up.forEach(function(p){var cnt=0;for(var k in mx[p]){if(mx[p][k]&&mx[p][k].days<=90)cnt++;}pcrit[p]=cnt;});up.sort(function(a,b){return pcrit[b]-pcrit[a]});
            var th=document.getElementById('matrix-thead');var hdr='<tr><th class="fixed-column">Personal</th>';uc.forEach(function(c){hdr+='<th>'+c+'</th>'});hdr+='<th>Cr√≠t</th></tr>';th.innerHTML=hdr;
            var tb=document.getElementById('matrix-tbody');tb.innerHTML='';up.forEach(function(p){var tr=document.createElement('tr'),tdn=document.createElement('td');tdn.className='fixed-column';tdn.textContent=p.split(' ').slice(0,2).join(' ');tdn.onclick=function(){showPersonalDni(p)};tr.appendChild(tdn);
                uc.forEach(function(c){var td=document.createElement('td'),cl=mx[p][c];if(!cl){td.textContent='-';td.className='cell-gray';td.onclick=function(){openAddCursoModal(p,c)};}else{td.innerHTML='<strong>'+(cl.days>0?cl.days+'d':cl.days===0?'HOY':(-cl.days)+'d')+'</strong>';td.className=cl.days>90?'cell-green':cl.days>0?'cell-orange':'cell-red';(function(cid){td.onclick=function(){openEditCurso(cid)};})(cl.id);}tr.appendChild(td);});
                var ctd=document.createElement('td');ctd.textContent=pcrit[p];ctd.className=pcrit[p]>0?'cell-red':'cell-green';tr.appendChild(ctd);tb.appendChild(tr);});});}

    function showPersonalDni(n){var u=usuarios.find(function(x){return x.nombre===n});if(u){document.getElementById('modal-personal-nombre').textContent=u.nombre;document.getElementById('modal-personal-dni').textContent=u.dni;document.getElementById('personal-dni-modal').style.display='block';}}

    function openAddCursoModal(pp,pc){editingCursoId=null;document.getElementById('curso-modal-title').innerHTML='<i class="fas fa-graduation-cap"></i> A√±adir Curso';document.getElementById('curso-nombre').value=pc||'';document.getElementById('curso-venc').value='';var sel=document.getElementById('curso-dni');sel.innerHTML='<option value="">Seleccione personal</option>';usuarios.forEach(function(u){var o=document.createElement('option');o.value=u.dni;o.textContent=u.nombre.split(' ').slice(0,2).join(' ')+' - '+u.dni;sel.appendChild(o);});document.getElementById('delete-curso').style.display='none';document.getElementById('add-curso-modal').style.display='block';}

    function openEditCurso(id){editingCursoId=id;document.getElementById('curso-modal-title').innerHTML='<i class="fas fa-edit"></i> Editar Curso';db.collection('cursos').doc(id).get().then(function(doc){if(doc.exists){var d=doc.data();document.getElementById('curso-nombre').value=d.curso||'';document.getElementById('curso-venc').value=d.vencimiento?d.vencimiento.toDate().toISOString().split('T')[0]:'';var sel=document.getElementById('curso-dni');sel.innerHTML='<option value="">Seleccione personal</option>';usuarios.forEach(function(u){var o=document.createElement('option');o.value=u.dni;o.textContent=u.nombre.split(' ').slice(0,2).join(' ')+' - '+u.dni;if(d.dni===u.dni)o.selected=true;sel.appendChild(o);});document.getElementById('delete-curso').style.display='block';document.getElementById('add-curso-modal').style.display='block';}});}

    document.getElementById('save-curso').onclick=function(){var dni=document.getElementById('curso-dni').value,cur=document.getElementById('curso-nombre').value.trim(),ds=document.getElementById('curso-venc').value;if(!dni){showToast('Selecciona personal','error');return;}if(!cur||!ds){showToast('Completa todos los campos','error');return;}var vc=firebase.firestore.Timestamp.fromDate(new Date(ds)),data={dni:dni,curso:cur,vencimiento:vc};if(editingCursoId)db.collection('cursos').doc(editingCursoId).update(data).then(function(){showToast('Actualizado');closeModal('add-curso-modal');loadCursosSection();}).catch(function(e){console.error(e);showToast('Error','error');});else db.collection('cursos').add(data).then(function(){showToast('A√±adido');closeModal('add-curso-modal');loadCursosSection();}).catch(function(e){console.error(e);showToast('Error','error');});};

    document.getElementById('delete-curso').onclick=function(){if(confirm('¬øEliminar curso?'))db.collection('cursos').doc(editingCursoId).delete().then(function(){showToast('Eliminado');closeModal('add-curso-modal');loadCursosSection();}).catch(function(e){console.error(e);showToast('Error','error');});};

    window.onload=function(){var st=localStorage.getItem('user');if(st){try{currentUser=JSON.parse(st);}catch(e){}if(currentUser){document.getElementById('app').style.display='block';document.getElementById('login-screen').style.display='none';updateHeader();loadPendientes();}}else document.getElementById('login-screen').style.display='flex';
        var po=localStorage.getItem('pendingOps');if(po)try{pendingOfflineOps=JSON.parse(po)}catch(e){}
        if('serviceWorker'in navigator)navigator.serviceWorker.register('/sw.js').then(function(r){console.log('SW:',r.scope)}).catch(function(e){console.log('SW err:',e)});
        firebase.auth().signInAnonymously().catch(function(e){console.error('Auth:',e)});
        updateOnlineStatus();
        document.getElementById('dni-input').addEventListener('input',function(){this.value=this.value.replace(/[^0-9]/g,'');});
        document.getElementById('dni-input').addEventListener('keypress',function(e){if(e.key==='Enter')login();});};
    </script>
</body>
</html>
