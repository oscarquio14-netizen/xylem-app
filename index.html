<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#00A0B0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Control de Observaciones - Hidrogeología</title>
    <!-- Manifest se inyecta solo en HTTP(S) para evitar CORS al abrir con file:// -->
    <script>
    (function () {
        if (location.protocol === 'http:' || location.protocol === 'https:') {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = './manifest.json';
            document.head.appendChild(link);
        }
    })();
    </script>
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--primary:#00A0B0;--primary-dark:#007A87;--primary-light:#4DD0E1;--success:#2E7D32;--success-light:#4CAF50;--warning:#F57C00;--warning-light:#FFB300;--danger:#C62828;--danger-light:#EF5350;--info:#1565C0;--info-light:#42A5F5;--purple:#7B1FA2;--purple-light:#AB47BC;--text-dark:#1A1A2E;--text-medium:#4A4A5A;--text-light:#6B6B7B;--bg-white:#FFFFFF;--bg-light:#F5F7FA;--border-light:#E0E4E8;--shadow-sm:0 2px 8px rgba(0,0,0,0.08);--shadow-md:0 4px 16px rgba(0,0,0,0.12);--shadow-lg:0 8px 32px rgba(0,0,0,0.16);--radius-sm:12px;--radius-md:16px;--radius-lg:24px}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        html,body{height:100%;font-family:'Nunito',Arial,sans-serif;font-size:17px;background:var(--bg-light);color:var(--text-dark);overflow:hidden;line-height:1.5}
        
        /* Header */
        .header{position:fixed;top:0;left:0;right:0;height:65px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 15px;box-shadow:var(--shadow-md);z-index:1000}
        .hamburger{font-size:28px;cursor:pointer;padding:8px;border-radius:var(--radius-sm);width:44px;height:44px;display:flex;align-items:center;justify-content:center}.hamburger:active{background:rgba(255,255,255,0.2)}
        .header-title{font-size:17px;font-weight:700;text-align:center;flex:1;padding:0 10px}
        .user-info{font-size:14px;font-weight:600;background:rgba(255,255,255,0.15);padding:6px 12px;border-radius:50px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        
        /* Drawer */
        .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;z-index:998;backdrop-filter:blur(4px)}.overlay.active{display:block}
        .drawer{position:fixed;top:0;left:-300px;width:280px;height:100%;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;padding:80px 15px 20px;transition:left .3s;box-shadow:var(--shadow-lg);z-index:999;overflow-y:auto}.drawer.open{left:0}
        .drawer-header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.2)}
        .drawer-header i{font-size:40px;margin-bottom:8px}
        .drawer-header h3{font-size:16px;font-weight:600;opacity:0.9}
        .drawer button{background:rgba(255,255,255,0.1);border:none;color:#fff;text-align:left;cursor:pointer;font-size:17px;font-weight:600;padding:14px 16px;width:100%;border-radius:var(--radius-md);margin-bottom:8px;display:flex;align-items:center;gap:12px;transition:all .2s;position:relative}
        .drawer button i{font-size:20px;width:26px;text-align:center}
        .drawer button:active,.drawer button.active{background:rgba(255,255,255,0.25)}
        .drawer button.logout{background:var(--danger);margin-top:20px}
        .menu-badge{position:absolute;right:12px;background:#fff;color:var(--danger);font-size:12px;font-weight:800;padding:2px 8px;border-radius:50px;min-width:24px;text-align:center}
        
        /* Main Content */
        .main-content{margin-top:65px;padding:15px;width:100%;height:calc(100vh - 65px);overflow-y:auto;-webkit-overflow-scrolling:touch}
        
        /* Login Screen */
        .login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);display:none;flex-direction:column;align-items:center;justify-content:center;color:#fff;z-index:2000;padding:30px;text-align:center}
        .login-logo{font-size:70px;margin-bottom:15px;text-shadow:0 4px 20px rgba(0,0,0,0.2)}
        .login-title{font-size:22px;font-weight:800;margin-bottom:5px}
        .login-subtitle{font-size:15px;font-weight:600;opacity:0.9;margin-bottom:8px;line-height:1.4}
        .login-tagline{font-size:13px;opacity:0.8;margin-bottom:30px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
        .login-tagline span{background:rgba(255,255,255,0.15);padding:4px 12px;border-radius:50px}
        .login-screen input{width:100%;max-width:320px;padding:16px 20px;margin:8px 0;font-size:22px;font-weight:700;border-radius:var(--radius-lg);border:none;background:#fff;color:var(--text-dark);text-align:center;letter-spacing:3px}
        .login-screen input::placeholder{letter-spacing:0;font-size:16px;color:var(--text-light)}
        .login-screen button{width:100%;max-width:320px;padding:16px;margin:8px 0;font-size:17px;font-weight:700;border-radius:var(--radius-lg);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
        .login-btn{background:var(--success);color:#fff;transition:background .15s,transform .1s}.login-btn:active{transform:scale(0.95);background:var(--success-light)}
        .guest-btn{background:rgba(255,255,255,0.2);color:#fff;transition:background .15s,transform .1s}.guest-btn:active{transform:scale(0.95);background:rgba(255,255,255,0.35)}
        .login-error{color:#FFCDD2;font-size:15px;font-weight:600;margin-top:15px;min-height:25px}
        
        /* Dashboard Cards */
        .dashboard-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .dash-card{background:var(--bg-white);padding:15px;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);text-align:center;cursor:pointer;transition:transform .2s,box-shadow .2s;border:2px solid transparent}
        .dash-card:active{transform:scale(0.97)}
        .dash-card.active{border-color:var(--primary);box-shadow:var(--shadow-md)}
        .dash-card i{font-size:28px;margin-bottom:8px}
        .dash-card .number{font-size:32px;font-weight:800;line-height:1}
        .dash-card .label{font-size:12px;font-weight:700;color:var(--text-medium);margin-top:4px;text-transform:uppercase}
        .dash-card.urgent{border-left:4px solid var(--danger)}.dash-card.urgent i,.dash-card.urgent .number{color:var(--danger)}
        .dash-card.warning{border-left:4px solid var(--warning)}.dash-card.warning i,.dash-card.warning .number{color:var(--warning)}
        .dash-card.success{border-left:4px solid var(--success)}.dash-card.success i,.dash-card.success .number{color:var(--success)}
        .dash-card.info{border-left:4px solid var(--info)}.dash-card.info i,.dash-card.info .number{color:var(--info)}
        .dash-card.primary{border-left:4px solid var(--primary)}.dash-card.primary i,.dash-card.primary .number{color:var(--primary)}
        
        /* Alert Banner */
        .alert-banner{background:linear-gradient(135deg,var(--danger),var(--danger-light));color:#fff;padding:12px 15px;border-radius:var(--radius-md);margin-bottom:15px;display:flex;align-items:center;gap:12px;cursor:pointer;animation:pulse-bg 2s infinite}
        @keyframes pulse-bg{0%,100%{opacity:1}50%{opacity:0.85}}
        .alert-banner i{font-size:24px}
        .alert-banner-content{flex:1}
        .alert-banner-content strong{display:block;font-size:15px}
        .alert-banner-content span{font-size:13px;opacity:0.9}
        .alert-banner .arrow{font-size:20px}
        
        /* Charts Container */
        .charts-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
        .chart-card{background:var(--bg-white);padding:15px;border-radius:var(--radius-md);box-shadow:var(--shadow-sm)}
        .chart-card h4{font-size:13px;font-weight:700;color:var(--text-medium);margin-bottom:10px;text-transform:uppercase}
        .chart-card canvas{max-height:120px}
        
        /* Progress Bar */
        .progress-section{background:var(--bg-white);padding:15px;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);margin-bottom:20px}
        .progress-section h4{font-size:14px;font-weight:700;color:var(--text-medium);margin-bottom:10px}
        .progress-bar-container{background:var(--bg-light);border-radius:10px;height:30px;overflow:hidden;border:2px solid var(--border-light)}
        .progress-bar-fill{height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px;transition:width .5s}
        .progress-stats{display:flex;justify-content:space-between;margin-top:8px;font-size:13px;color:var(--text-medium)}
        
        /* Tabs */
        .tabs{display:flex;overflow-x:auto;background:var(--bg-white);border-radius:var(--radius-lg);padding:6px;margin-bottom:15px;box-shadow:var(--shadow-sm);gap:6px;scrollbar-width:none}.tabs::-webkit-scrollbar{display:none}
        .tab{padding:10px 16px;cursor:pointer;background:transparent;font-weight:700;font-size:14px;min-width:fit-content;text-align:center;border-radius:var(--radius-md);color:var(--text-medium);white-space:nowrap;transition:all .2s}
        .tab.active{background:var(--primary);color:#fff}
        
        /* Filter Bar */
        .filter-bar{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
        .filter-bar select{padding:10px 14px;border-radius:var(--radius-md);border:2px solid var(--border-light);font-size:14px;font-weight:600;background:var(--bg-white);flex:1;min-width:120px}
        .filter-bar select:focus{outline:none;border-color:var(--primary)}
        
        /* Search */
        .search-container{position:relative;margin-bottom:15px}
        .search-input{width:100%;padding:14px 16px 14px 48px;font-size:16px;border:2px solid var(--border-light);border-radius:var(--radius-lg);background:var(--bg-white);font-weight:600}
        .search-input:focus{outline:none;border-color:var(--primary)}
        .search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:18px;color:var(--text-light)}
        .search-clear{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:18px;color:var(--text-light);cursor:pointer;display:none}.search-clear.show{display:block}
        
        /* Observation Cards */
        .obs-list{display:flex;flex-direction:column;gap:12px}
        .obs-card{background:var(--bg-white);padding:15px;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);cursor:pointer;position:relative;border-left:5px solid var(--danger);transition:transform .2s}
        .obs-card:active{transform:scale(0.98)}
        .obs-card.completed{border-left-color:var(--success);opacity:0.8}
        .obs-card.in-progress{border-left-color:var(--warning)}
        .obs-card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
        .obs-card-type{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:50px;font-size:11px;font-weight:700;text-transform:uppercase}
        .type-acto{background:rgba(198,40,40,0.15);color:var(--danger)}
        .type-condicion{background:rgba(21,101,192,0.15);color:var(--info)}
        .obs-card-priority{padding:4px 10px;border-radius:50px;font-size:11px;font-weight:700}
        .priority-alta{background:var(--danger);color:#fff}
        .priority-media{background:var(--warning);color:#fff}
        .priority-baja{background:var(--success);color:#fff}
        .obs-card h3{font-size:15px;font-weight:700;margin-bottom:6px;line-height:1.3}
        .obs-card-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:12px;color:var(--text-medium);margin-bottom:10px}
        .obs-card-meta span{display:flex;align-items:center;gap:4px}
        .obs-card-footer{display:flex;justify-content:space-between;align-items:center;padding-top:10px;border-top:1px solid var(--border-light)}
        .obs-card-assignee{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600}
        .obs-card-assignee i{color:var(--primary)}
        .obs-card-assignee.unassigned{color:var(--warning)}
        .obs-card-progress{display:flex;align-items:center;gap:8px}
        .mini-progress{width:60px;height:8px;background:var(--bg-light);border-radius:4px;overflow:hidden}
        .mini-progress-fill{height:100%;border-radius:4px}
        .progress-text{font-size:12px;font-weight:700}
        .obs-card-status{padding:4px 10px;border-radius:50px;font-size:11px;font-weight:700}
        .status-pendiente{background:rgba(198,40,40,0.15);color:var(--danger)}
        .status-proceso{background:rgba(245,124,0,0.15);color:var(--warning)}
        .status-completado{background:rgba(46,125,50,0.15);color:var(--success)}
        
        /* Table View */
        .table-container{overflow-x:auto;background:var(--bg-white);border-radius:var(--radius-md);box-shadow:var(--shadow-sm)}
        .data-table{width:100%;border-collapse:collapse;min-width:800px}
        .data-table th,.data-table td{padding:12px 10px;text-align:left;border-bottom:1px solid var(--border-light);font-size:13px}
        .data-table th{background:var(--primary);color:#fff;font-weight:700;position:sticky;top:0;z-index:1}
        .data-table tr:hover{background:var(--bg-light)}
        .data-table .clickable{cursor:pointer;color:var(--primary);font-weight:600}
        .data-table .clickable:hover{text-decoration:underline}
        
        /* FAB */
        .fab{position:fixed;bottom:25px;right:20px;width:60px;height:60px;background:linear-gradient(135deg,var(--success),var(--success-light));color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:var(--shadow-lg);cursor:pointer;z-index:997;border:none}.fab:active{transform:scale(0.9)}
        
        /* Modal */
        .modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
        .modal-content{background:var(--bg-white);margin:15px auto;padding:20px;border-radius:var(--radius-lg);width:95%;max-width:480px;box-shadow:var(--shadow-lg);max-height:92vh;overflow-y:auto;animation:slideUp .3s}
        @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-header h3{font-size:20px;font-weight:800;color:var(--primary-dark);display:flex;align-items:center;gap:10px}
        .close{font-size:32px;cursor:pointer;color:var(--text-light);line-height:1}.close:hover{color:var(--danger)}
        .form-group{margin-bottom:15px}
        .form-group label{font-size:15px;font-weight:700;margin-bottom:8px;display:block;color:var(--text-dark)}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:14px;border-radius:var(--radius-md);border:2px solid var(--border-light);font-size:16px;font-weight:600;background:var(--bg-white)}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary)}
        .form-group textarea{resize:vertical;min-height:100px}
        
        /* Type Selector */
        .type-selector{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px}
        .type-option{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:15px;border-radius:var(--radius-md);border:3px solid var(--border-light);background:var(--bg-white);cursor:pointer;transition:all .2s}
        .type-option i{font-size:28px;margin-bottom:8px}
        .type-option strong{font-size:14px}
        .type-option span{font-size:11px;color:var(--text-medium);text-align:center;margin-top:4px}
        .type-option[data-type="acto"]{border-color:var(--border-light)}.type-option[data-type="acto"] i{color:var(--danger)}
        .type-option[data-type="condicion"]{border-color:var(--border-light)}.type-option[data-type="condicion"] i{color:var(--info)}
        .type-option[data-type="acto"].selected{border-color:var(--danger);background:rgba(198,40,40,0.1)}
        .type-option[data-type="condicion"].selected{border-color:var(--info);background:rgba(21,101,192,0.1)}
        
        /* Sector Selector */
        .sector-selector{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px}
        .sector-option{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:15px 10px;border-radius:var(--radius-md);border:3px solid var(--border-light);background:var(--bg-white);cursor:pointer;min-height:80px}
        .sector-option i{font-size:26px;margin-bottom:6px}.sector-option span{font-size:13px;font-weight:700}
        .sector-option.selected{border-color:var(--primary);background:rgba(0,160,176,0.1)}
        .sector-option[data-sector="pozos"] i{color:#1976D2}
        .sector-option[data-sector="pozas"] i{color:#7B1FA2}
        .sector-option[data-sector="taller"] i{color:#E64A19}
        .sector-option[data-sector="well_point"] i{color:#00796B}
        
        /* Priority Selector */
        .priority-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:15px}
        .priority-option{display:flex;flex-direction:column;align-items:center;padding:12px 8px;border-radius:var(--radius-md);border:3px solid var(--border-light);background:var(--bg-white);cursor:pointer}
        .priority-option i{font-size:22px;margin-bottom:5px}.priority-option span{font-size:12px;font-weight:700}
        .priority-option[data-priority="alta"] i{color:var(--danger)}
        .priority-option[data-priority="media"] i{color:var(--warning)}
        .priority-option[data-priority="baja"] i{color:var(--success)}
        .priority-option[data-priority="alta"].selected{border-color:var(--danger);background:rgba(198,40,40,0.1)}
        .priority-option[data-priority="media"].selected{border-color:var(--warning);background:rgba(245,124,0,0.1)}
        .priority-option[data-priority="baja"].selected{border-color:var(--success);background:rgba(46,125,50,0.1)}
        
        /* Wheel Picker for % */
        .wheel-picker{background:var(--bg-light);border-radius:var(--radius-md);padding:15px;margin-bottom:15px}
        .wheel-picker-label{text-align:center;font-size:14px;font-weight:700;color:var(--text-medium);margin-bottom:10px}
        .wheel-container{display:flex;justify-content:center;align-items:center;gap:15px}
        .wheel-display{font-size:48px;font-weight:800;color:var(--primary);min-width:120px;text-align:center}
        .wheel-controls{display:flex;flex-direction:column;gap:8px}
        .wheel-btn{width:44px;height:44px;border-radius:50%;border:none;font-size:20px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .wheel-btn.up{background:var(--success);color:#fff}
        .wheel-btn.down{background:var(--danger);color:#fff}
        .wheel-btn:active{transform:scale(0.9)}
        .wheel-presets{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:12px}
        .wheel-preset{padding:10px 5px;border-radius:var(--radius-sm);border:2px solid var(--border-light);background:var(--bg-white);font-size:13px;font-weight:700;cursor:pointer;text-align:center}
        .wheel-preset:active,.wheel-preset.active{border-color:var(--primary);background:rgba(0,160,176,0.1)}
        
        /* Voice Button */
        .voice-container{position:relative}
        .voice-btn{position:absolute;right:10px;bottom:10px;width:44px;height:44px;background:var(--primary);color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center}
        .voice-btn:active{transform:scale(0.9)}.voice-btn.recording{background:var(--danger);animation:pulse 1s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        
        /* Buttons */
        .btn{width:100%;padding:16px;border:none;border-radius:var(--radius-md);font-size:17px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
        .btn-success{background:linear-gradient(135deg,var(--success),var(--success-light));color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn:disabled{opacity:0.6;cursor:not-allowed}
        .btn .spinner{width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* History */
        .history-list{max-height:200px;overflow-y:auto}
        .history-item{padding:12px;background:var(--bg-light);border-radius:var(--radius-sm);margin-bottom:8px;border-left:3px solid var(--primary)}
        .history-item strong{color:var(--primary-dark);font-size:14px}
        .history-item p{font-size:13px;color:var(--text-medium);margin:4px 0}
        .history-item small{font-size:11px;color:var(--text-light)}
        
        /* Course Cards */
        .course-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(250px,1fr))}
        .course-card{background:var(--bg-white);padding:15px;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);border-left:5px solid var(--success)}
        .course-card.expiring{border-left-color:var(--warning)}
        .course-card.expired{border-left-color:var(--danger)}
        .course-card h4{font-size:15px;font-weight:700;margin-bottom:8px}
        .course-card .days{font-size:24px;font-weight:800}
        .course-card .days.ok{color:var(--success)}
        .course-card .days.warning{color:var(--warning)}
        .course-card .days.danger{color:var(--danger)}
        .course-card .legend{font-size:12px;color:var(--text-medium)}
        
        /* Matrix Table */
        .matrix-wrapper{overflow-x:auto;background:var(--bg-white);border-radius:var(--radius-md);box-shadow:var(--shadow-sm)}
        .matrix-table{width:100%;border-collapse:collapse;min-width:600px}
        .matrix-table th,.matrix-table td{padding:10px 8px;text-align:center;border:1px solid var(--border-light);font-size:12px}
        .matrix-table th{background:var(--primary);color:#fff;font-weight:700;position:sticky;top:0}
        .matrix-table .sticky-col{position:sticky;left:0;background:var(--bg-light);font-weight:700;text-align:left;z-index:1}
        .matrix-table th.sticky-col{background:var(--primary-dark);z-index:2}
        .cell-ok{background:#C8E6C9;color:var(--success)}
        .cell-warning{background:#FFE0B2;color:var(--warning)}
        .cell-danger{background:#FFCDD2;color:var(--danger)}
        .cell-empty{background:#EEEEEE;color:var(--text-light)}
        
        /* Toast */
        .toast-container{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;width:90%;max-width:350px}
        .toast{background:var(--success);color:#fff;padding:14px 20px;border-radius:var(--radius-md);font-weight:600;font-size:15px;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px;transform:translateY(100px);opacity:0;transition:all .4s;pointer-events:auto}
        .toast.show{opacity:1;transform:translateY(0)}
        .toast.error{background:var(--danger)}
        .toast.warning{background:var(--warning);color:var(--text-dark)}
        .toast i{font-size:20px}
        
        /* Offline */
        .offline-banner{position:fixed;top:65px;left:0;right:0;background:var(--warning);color:var(--text-dark);padding:10px;text-align:center;font-weight:700;font-size:14px;z-index:999;display:none}
        .offline-banner.show{display:flex;align-items:center;justify-content:center;gap:8px}
        body.offline .main-content{margin-top:105px;height:calc(100vh - 105px)}
        
        /* Empty State */
        .empty-state{text-align:center;padding:40px 20px;color:var(--text-light)}
        .empty-state i{font-size:60px;margin-bottom:15px;opacity:0.5}
        .empty-state p{font-size:16px;font-weight:600}
        
        /* Responsive */
        @media(max-width:400px){
            .dashboard-grid{grid-template-columns:1fr 1fr}
            .dash-card .number{font-size:28px}
            .charts-row{grid-template-columns:1fr}
        }
    
    /* Multi-responsables */
    .assign-list{
        border:1px solid var(--border-light);
        border-radius:var(--radius-md);
        padding:8px;
        max-height:260px;
        overflow:auto;
        background:var(--bg-light);
    }
    .assign-item{
        display:flex;
        align-items:center;
        gap:10px;
        padding:8px 10px;
        border-radius:12px;
        cursor:pointer;
        background:var(--bg-white);
        border:1px solid transparent;
        margin-bottom:8px;
    }
    .assign-item:last-child{margin-bottom:0;}
    .assign-item:hover{
        border-color:var(--border-light);
        box-shadow:var(--shadow-sm);
    }
    .assign-item input{transform:scale(1.1);}
    .assign-item-name{font-weight:900;color:var(--text-dark);flex:1;}
    .assign-item-dni{font-size:12px;font-weight:800;color:var(--text-light);}

</style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>
    <div class="offline-banner" id="offline-banner"><i class="fas fa-wifi-slash"></i><span>Sin conexión - Los cambios se guardarán localmente</span></div>
    
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen" style="display:flex;">
        <div class="login-logo"><i class="fas fa-hard-hat"></i></div>
        <h1 class="login-title">HIDROGEOLOGÍA</h1>
        <p class="login-subtitle">Control de Observaciones<br>(Actos y Condiciones)<br>y Capacitaciones</p>
        <div class="login-tagline">
            <span><i class="fas fa-clipboard-check"></i> Gestiona</span>
            <span><i class="fas fa-bell"></i> Reporta</span>
            <span><i class="fas fa-tasks"></i> Controla</span>
            <span><i class="fas fa-check-circle"></i> Resuelve</span>
        </div>
        <input type="tel" id="dni-input" placeholder="Ingresa tu DNI" maxlength="8" inputmode="numeric">
        <button class="login-btn" onclick="login()"><i class="fas fa-sign-in-alt"></i> INGRESAR CON DNI</button>
        <button class="guest-btn" onclick="loginAsGuest()"><i class="fas fa-eye"></i> Ver como Invitado</button>
        <p class="login-error" id="login-error"></p>
    </div>
    
    <!-- Main App -->
    <div id="app" style="display:none;">
        <header class="header">
            <div class="hamburger" onclick="toggleDrawer()"><i class="fas fa-bars"></i></div>
            <div class="header-title" id="header-title">Panel de Control</div>
            <div class="user-info" id="user-info">Usuario</div>
        </header>
        
        <div class="overlay" onclick="toggleDrawer()"></div>
        
        <nav class="drawer" id="drawer">
            <div class="drawer-header">
                <i class="fas fa-user-circle"></i>
                <h3 id="drawer-user-name">Usuario</h3>
            </div>
            <div id="drawer-menu"></div>
            <button class="logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
        </nav>
        
        <main class="main-content" id="main-content"></main>
        
        <button class="fab" id="fab" onclick="openNewObsModal()" style="display:none;"><i class="fas fa-plus"></i></button>
    </div>
    
    <!-- Modal: Nueva Observación -->
    <div id="modal-new-obs" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Crear Observación</h3>
                <span class="close" onclick="closeModal('modal-new-obs')">&times;</span>
            </div>
            
            <div class="form-group">
                <label>Tipo de Observación</label>
                <div class="type-selector">
                    <div class="type-option" data-type="acto" onclick="selectType('acto')">
                        <i class="fas fa-user-slash"></i>
                        <strong>ACTO</strong>
                        <span>Comportamiento inseguro</span>
                    </div>
                    <div class="type-option" data-type="condicion" onclick="selectType('condicion')">
                        <i class="fas fa-tools"></i>
                        <strong>CONDICIÓN</strong>
                        <span>Situación operativa</span>
                    </div>
                </div>
                <input type="hidden" id="new-obs-type">
            </div>
            
            <div class="form-group">
                <label>Sector</label>
                <div class="sector-selector">
                    <div class="sector-option" data-sector="pozos" onclick="selectSector('pozos')"><i class="fas fa-tint"></i><span>Pozos</span></div>
                    <div class="sector-option" data-sector="pozas" onclick="selectSector('pozas')"><i class="fas fa-water"></i><span>Pozas</span></div>
                    <div class="sector-option" data-sector="taller" onclick="selectSector('taller')"><i class="fas fa-warehouse"></i><span>Taller</span></div>
                    <div class="sector-option" data-sector="well_point" onclick="selectSector('well_point')"><i class="fas fa-faucet"></i><span>Well Point</span></div>
                </div>
                <input type="hidden" id="new-obs-sector">
            </div>
            
            <div class="form-group">
                <label>Prioridad</label>
                <div class="priority-selector">
                    <div class="priority-option" data-priority="alta" onclick="selectPriority('alta')"><i class="fas fa-exclamation-circle"></i><span>ALTA</span></div>
                    <div class="priority-option selected" data-priority="media" onclick="selectPriority('media')"><i class="fas fa-minus-circle"></i><span>MEDIA</span></div>
                    <div class="priority-option" data-priority="baja" onclick="selectPriority('baja')"><i class="fas fa-arrow-circle-down"></i><span>BAJA</span></div>
                </div>
                <input type="hidden" id="new-obs-priority" value="media">
            </div>
            
            <div class="form-group">
                <label>Descripción</label>
                <div class="voice-container">
                    <textarea id="new-obs-desc" placeholder="Describe la observación o pendiente..."></textarea>
                    <button class="voice-btn" id="voice-btn-new" onclick="toggleVoice('new-obs-desc')"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Porcentaje de Avance</label>
                <div class="wheel-picker">
                    <div class="wheel-container">
                        <div class="wheel-controls">
                            <button class="wheel-btn up" onclick="changeProgress(10)"><i class="fas fa-plus"></i></button>
                            <button class="wheel-btn down" onclick="changeProgress(-10)"><i class="fas fa-minus"></i></button>
                        </div>
                        <div class="wheel-display" id="progress-display">0%</div>
                    </div>
                    <div class="wheel-presets">
                        <div class="wheel-preset active" onclick="setProgress(0)">0%</div>
                        <div class="wheel-preset" onclick="setProgress(25)">25%</div>
                        <div class="wheel-preset" onclick="setProgress(50)">50%</div>
                        <div class="wheel-preset" onclick="setProgress(75)">75%</div>
                        <div class="wheel-preset" onclick="setProgress(100)">100%</div>
                    </div>
                </div>
                <input type="hidden" id="new-obs-progress" value="0">
            </div>
            
            <div class="form-group" id="resolution-comment-group" style="display:none;">
                <label>Comentario de Resolución (obligatorio)</label>
                <textarea id="new-obs-resolution" placeholder="¿Cómo se resolvió?"></textarea>
            </div>
            
            <button class="btn btn-primary" id="btn-save-new-obs" onclick="saveNewObs()">
                <i class="fas fa-save"></i> GUARDAR OBSERVACIÓN
            </button>
        </div>
    </div>
    
    <!-- Modal: Detalle Observación -->
    <div id="modal-detail-obs" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Detalle</h3>
                <span class="close" onclick="closeModal('modal-detail-obs')">&times;</span>
            </div>
            
            <div id="detail-content"></div>
            
            <div id="detail-actions"></div>
        </div>
    </div>
    
    <!-- Modal: Asignar Responsable -->
    <div id="modal-assign" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Gestionar Responsables</h3>
                <span class="close" onclick="closeModal('modal-assign')">&times;</span>
            </div>
            
            <div class="form-group">
                <label>Selecciona uno o más responsables</label>
                <div id="assign-list" class="assign-list"></div>
                <div class="hint" style="margin-top:6px;font-size:12px;color:var(--text-light);font-weight:700;">
                    Puedes dejarlo vacío para <b>Sin asignar</b>.
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="confirmAssign()">
                <i class="fas fa-check"></i> GUARDAR
            </button>
        </div>
    </div>
    
    <!-- Modal: Actualizar Avance -->
    <div id="modal-update-progress" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-tasks"></i> Actualizar Avance</h3>
                <span class="close" onclick="closeModal('modal-update-progress')">&times;</span>
            </div>
            
            <div class="form-group">
                <label>Nuevo Porcentaje</label>
                <div class="wheel-picker">
                    <div class="wheel-container">
                        <div class="wheel-controls">
                            <button class="wheel-btn up" onclick="changeUpdateProgress(10)"><i class="fas fa-plus"></i></button>
                            <button class="wheel-btn down" onclick="changeUpdateProgress(-10)"><i class="fas fa-minus"></i></button>
                        </div>
                        <div class="wheel-display" id="update-progress-display">0%</div>
                    </div>
                    <div class="wheel-presets" id="update-presets">
                        <div class="wheel-preset" onclick="setUpdateProgress(0)">0%</div>
                        <div class="wheel-preset" onclick="setUpdateProgress(25)">25%</div>
                        <div class="wheel-preset" onclick="setUpdateProgress(50)">50%</div>
                        <div class="wheel-preset" onclick="setUpdateProgress(75)">75%</div>
                        <div class="wheel-preset" onclick="setUpdateProgress(100)">100%</div>
                    </div>
                </div>
                <input type="hidden" id="update-progress-value" value="0">
            </div>
            
            <div class="form-group">
                <label>Comentario (obligatorio)</label>
                <div class="voice-container">
                    <textarea id="update-comment" placeholder="Describe el avance realizado..."></textarea>
                    <button class="voice-btn" onclick="toggleVoice('update-comment')"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="confirmUpdateProgress()">
                <i class="fas fa-check"></i> ACTUALIZAR AVANCE
            </button>
        </div>
    </div>
    
    <!-- Modal: Personal DNI -->
    <div id="modal-personal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-id-card"></i> Información</h3>
                <span class="close" onclick="closeModal('modal-personal')">&times;</span>
            </div>
            <p style="font-size:16px;margin-bottom:10px;"><strong>Nombre:</strong><br><span id="personal-nombre"></span></p>
            <p style="font-size:16px;"><strong>DNI:</strong><br><span id="personal-dni"></span></p>
        </div>
    </div>
    
    <!-- Modal: Añadir/Editar Curso -->
    <div id="modal-curso" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="curso-modal-title"><i class="fas fa-graduation-cap"></i> Añadir Curso</h3>
                <span class="close" onclick="closeModal('modal-curso')">&times;</span>
            </div>
            
            <div class="form-group">
                <label>Personal</label>
                <select id="curso-personal"></select>
            </div>
            
            <div class="form-group">
                <label>Nombre del Curso</label>
                <input type="text" id="curso-nombre" placeholder="Ej: Trabajo en Altura">
            </div>
            
            <div class="form-group">
                <label>Fecha de Vencimiento</label>
                <input type="date" id="curso-fecha">
            </div>
            
            <button class="btn btn-primary" id="btn-save-curso" onclick="saveCurso()">
                <i class="fas fa-save"></i> GUARDAR
            </button>
            <button class="btn btn-danger" id="btn-delete-curso" onclick="deleteCurso()" style="display:none;">
                <i class="fas fa-trash"></i> ELIMINAR
            </button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyAyhP0Ak3ziNrGTCFHKlFr7-_HAMimYX_g",
        authDomain: "trabajos---xylem.firebaseapp.com",
        projectId: "trabajos---xylem",
        storageBucket: "trabajos---xylem.firebasestorage.app",
        messagingSenderId: "719564556454",
        appId: "1:719564556454:web:22e10612163f79d4b5cc67"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    db.enablePersistence({synchronizeTabs: true}).catch(e => console.log('Persistence:', e.code));
    
    // Users - Updated list (removed Ever Supho)
    const usuarios = [
        {nombre: "TURPO CALLOHUANCA CESAR JHONY", dni: "40968321", rol: "supervisor"},
        {nombre: "ASTULLE AZA WILLY ENRIQUE", dni: "41834020", rol: "supervisor"},
        {nombre: "HUAMANI QUIO OSCAR EMILIO", dni: "72156518", rol: "supervisor"},
        {nombre: "FLOREZ ARQUE WILLAM", dni: "44626323", rol: "supervisor"},
        {nombre: "LIMASCA CHAHUAYO AMERICO", dni: "46146718", rol: "trabajador"},
        {nombre: "PEREZ VARIAS WALTER SERGEY", dni: "29419804", rol: "trabajador"},
        {nombre: "CONDORI HUANCA FREDY", dni: "29652867", rol: "trabajador"},
        {nombre: "LLAIQUE QUISPE SAMUEL", dni: "76647913", rol: "trabajador"},
        {nombre: "GOMEZ LACACTA JOSE LUIS", dni: "47673736", rol: "trabajador"},
        {nombre: "QUSIPE YUCRA GILBER SILVESTRE", dni: "46759346", rol: "trabajador"},
        {nombre: "QUINA BARRIGA CARLOS FERMANDO", dni: "29320149", rol: "trabajador"},
        {nombre: "FUENTES FUENTES JOSE", dni: "04431627", rol: "trabajador"},
        {nombre: "SUCASACA YUCRA JUAN NOE", dni: "47057969", rol: "trabajador"},
        {nombre: "CCAHUANA HUAMANI MARCO ANTONIO", dni: "74752120", rol: "trabajador"},
        {nombre: "QUISPE YUCRA JUAN CARLOS", dni: "78374316", rol: "trabajador"},
        {nombre: "PAUCCARA HUAMANI HUGO", dni: "24893792", rol: "trabajador"},
        {nombre: "HUAYTA MAMANI HUGO ELOY", dni: "29685210", rol: "trabajador"},
        {nombre: "QUISPE APAZA JUAN CARLOS", dni: "71994478", rol: "trabajador"},
        {nombre: "MERMA CRUZ MARCO ANTONIO", dni: "72271044", rol: "trabajador"},
        {nombre: "PPACCO HUAMANI ALEX", dni: "74164942", rol: "trabajador"},
        {nombre: "HUANCA CONDORI EVENISTER ADAN", dni: "04430425", rol: "trabajador"}
    ];
    
    // Global State
    let currentUser = null;
    let currentSection = 'dashboard';
    let currentObsId = null;
    let editingCursoId = null;
    let allObservaciones = [];
    let allCursos = [];
    let currentFilters = {sector: 'todos', tipo: 'todos', estado: 'todos', responsable: 'todos'};
    let charts = [];
    let recognition = null;
    let isRecording = false;
    let newObsProgress = 0;
    let updateProgressValue = 0;
    
    // Sector config
    const sectorConfig = {
        pozos: {icon: 'fa-tint', color: '#1976D2', label: 'Pozos'},
        pozas: {icon: 'fa-water', color: '#7B1FA2', label: 'Pozas'},
        taller: {icon: 'fa-warehouse', color: '#E64A19', label: 'Taller'},
        well_point: {icon: 'fa-faucet', color: '#00796B', label: 'Well Point'}
    };
    
    // ==================== UTILITY FUNCTIONS ====================
    
    function showToast(msg, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        const icons = {success: 'check-circle', error: 'times-circle', warning: 'exclamation-triangle'};
        toast.innerHTML = `<i class="fas fa-${icons[type] || 'info-circle'}"></i><span>${msg}</span>`;
        container.appendChild(toast);
        if (navigator.vibrate) navigator.vibrate(type === 'error' ? [100, 50, 100] : 100);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 400);
        }, 3000);
    }
    
    function getPrimerNombre(nombreCompleto) {
        if (!nombreCompleto || nombreCompleto === 'Invitado') return 'Invitado';
        const partes = nombreCompleto.split(' ');
        return partes.length >= 3 ? partes[2] : partes[0];
    }
    
    function getShortName(nombreCompleto) {
        if (!nombreCompleto) return 'N/A';
        const partes = nombreCompleto.split(' ');
        if (partes.length >= 3) return partes[2];
        return partes[0];
    }


    // Para Cursos: mostrar "PrimerNombre Apellido1 Apellido2"
    // (El sistema suele guardar como: APELLIDO1 APELLIDO2 NOMBRES...)
    function getDisplayNameCursos(nombreCompleto) {
        if (!nombreCompleto) return 'N/A';
        const partes = nombreCompleto.trim().split(/\s+/);
        if (partes.length >= 3) {
            const primerNombre = partes[2];   // primer nombre (después de 2 apellidos)
            const ape1 = partes[0];
            const ape2 = partes[1];
            return `${primerNombre} ${ape1} ${ape2}`;
        }
        return nombreCompleto;
    }

    function getResponsablesLabel(obs) {
        if (!obs) return 'Sin asignar';

        const list = Array.isArray(obs.responsables) ? obs.responsables : (obs.assignedTo ? [obs.assignedTo] : []);
        if (!list || list.length === 0) return 'Sin asignar';

        const names = list.map(dni => {
            const u = usuarios.find(x => x.dni === dni);
            if (u && u.nombre) return getShortName(u.nombre);
            // fallback: si el responsable era el antiguo assignedTo
            // usamos assignedToName si está disponible
            if (obs.assignedTo && dni === obs.assignedTo && obs.assignedToName) return getShortName(obs.assignedToName);
            return dni;
        });

        // Evitar repetidos
        return [...new Set(names)].join(', ');
    }

    function hasResponsables(obs) {
        const list = Array.isArray(obs?.responsables) ? obs.responsables : [];
        return list.length > 0 || !!obs?.assignedTo;
    }
    
    function relativeTime(d) {
        if (!d) return 'Fecha desconocida';
        const now = new Date();
        const diff = now - d;
        const mins = Math.floor(diff / 60000);
        const hrs = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        if (mins < 1) return 'Ahora';
        if (mins < 60) return `Hace ${mins} min`;
        if (hrs < 24) return `Hace ${hrs}h`;
        if (days === 1) return 'Ayer';
        if (days < 7) return `Hace ${days} días`;
        return d.toLocaleDateString('es-PE');
    }
    
    function formatDate(d) {
        if (!d) return '';
        return d.toLocaleDateString('es-PE', {day: '2-digit', month: '2-digit', year: 'numeric'});
    }
    
    function getProgressColor(p) {
        if (p >= 100) return 'var(--success)';
        if (p >= 50) return 'var(--warning)';
        return 'var(--danger)';
    }
    
    function getStatusInfo(progress) {
        if (progress >= 100) return {label: 'Completado', class: 'status-completado'};
        if (progress > 0) return {label: 'En Proceso', class: 'status-proceso'};
        return {label: 'Pendiente', class: 'status-pendiente'};
    }
    
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }
    
    function toggleDrawer() {
        document.getElementById('drawer').classList.toggle('open');
        document.querySelector('.overlay').classList.toggle('active');
    }
    
    function destroyCharts() {
        charts.forEach(c => { if (c) c.destroy(); });
        charts = [];
    }
    
    // ==================== AUTH FUNCTIONS ====================
    
    function login() {
        const dni = document.getElementById('dni-input').value.trim();
        const err = document.getElementById('login-error');
        
        if (!dni) { err.textContent = 'Ingresa tu DNI'; return; }
        if (!/^\d{8}$/.test(dni)) { err.textContent = 'El DNI debe tener 8 dígitos'; return; }
        
        const user = usuarios.find(u => u.dni === dni);
        if (user) {
            currentUser = {nombre: user.nombre, rol: user.rol, dni: user.dni};
            localStorage.setItem('user', JSON.stringify(currentUser));
            startApp();
            showToast(`¡Bienvenido, ${getPrimerNombre(user.nombre)}!`);
        } else {
            err.textContent = 'DNI no registrado en el sistema';
        }
    }
    
    function loginAsGuest() {
        currentUser = {nombre: 'Invitado', rol: 'supervisor', dni: '00000000'};
        startApp();
        showToast('Ingresaste como invitado (vista supervisor)');
    }
    
    function logout() {
        localStorage.removeItem('user');
        location.reload();
    }
    
    function startApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('user-info').textContent = getPrimerNombre(currentUser.nombre);
        document.getElementById('drawer-user-name').textContent = getPrimerNombre(currentUser.nombre);
        
        buildMenu();
        
        if (currentUser.rol === 'supervisor') {
            loadDashboard();
        } else {
            loadMyTasks();
        }
    
        loadData();
}
    
    function buildMenu() {
        const menu = document.getElementById('drawer-menu');
        let html = '';
        
        if (currentUser.rol === 'supervisor') {
            html = `
                <button id="menu-dashboard" class="active" onclick="loadDashboard();toggleDrawer();">
                    <i class="fas fa-chart-pie"></i> Panel de Control
                </button>
                <button id="menu-observaciones" onclick="loadObservaciones();toggleDrawer();">
                    <i class="fas fa-clipboard-list"></i> Observaciones
                    <span class="menu-badge" id="badge-obs" style="display:none;">0</span>
                </button>
                <button id="menu-crear" onclick="openNewObsModal();toggleDrawer();">
                    <i class="fas fa-plus-circle"></i> Crear Observación
                </button>
                <button id="menu-cursos" onclick="loadCursos();toggleDrawer();">
                    <i class="fas fa-graduation-cap"></i> Gestión de Cursos
                    <span class="menu-badge" id="badge-cursos" style="display:none;">0</span>
                </button>
            `;
        } else {
            html = `
                <button id="menu-mytasks" class="active" onclick="loadMyTasks();toggleDrawer();">
                    <i class="fas fa-tasks"></i> Mis Tareas
                    <span class="menu-badge" id="badge-mytasks" style="display:none;">0</span>
                </button>
                <button id="menu-crear" onclick="openNewObsModal();toggleDrawer();">
                    <i class="fas fa-plus-circle"></i> Crear Observación
                </button>
                <button id="menu-all-obs" onclick="loadAllObsWorker();toggleDrawer();">
                    <i class="fas fa-eye"></i> Ver Observaciones
                </button>
                <button id="menu-cursos" onclick="loadMyCursos();toggleDrawer();">
                    <i class="fas fa-graduation-cap"></i> Mis Cursos
                </button>
            `;
        }
        
        menu.innerHTML = html;
    }
    
    function setActiveMenu(id) {
        document.querySelectorAll('.drawer button').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(id);
        if (btn) btn.classList.add('active');
    }
    
    // ==================== DATA LOADING ====================
    
    function loadData() {
        // Load observaciones
        db.collection('observaciones').onSnapshot(snap => {
            allObservaciones = [];
            snap.forEach(doc => {
                const data = doc.data();
                data.id = doc.id;
                data.fechaDate = data.fechaReporte ? data.fechaReporte.toDate() : new Date();
                data.progress = data.progress || 0;
                data.tipo = data.tipo || 'condicion';
                data.priority = data.priority || 'media';
                data.history = data.history || [];
                                data.assignedTo = data.assignedTo || null;
                data.assignedToName = data.assignedToName || null;

                // Multi-responsables (compat: si solo existe assignedTo, lo convertimos a lista)
                if (Array.isArray(data.responsables)) {
                    data.responsables = data.responsables
                        .map(r => (typeof r === 'string') ? r : (r && r.dni ? r.dni : null))
                        .filter(Boolean);
                } else {
                    data.responsables = data.assignedTo ? [data.assignedTo] : [];
                }
                if (data.assignedTo && !data.responsables.includes(data.assignedTo)) {
                    data.responsables.push(data.assignedTo);
                }
                // Convert pb1 to taller
                if (data.sector === 'pb1') data.sector = 'taller';
                allObservaciones.push(data);
            });
            updateBadges();
            if (currentSection === 'dashboard') renderDashboard();
            else if (currentSection === 'observaciones') renderObservaciones();
            else if (currentSection === 'mytasks') renderMyTasks();
            else if (currentSection === 'allobs') renderAllObsWorker();
        });
        
        // Load cursos
        db.collection('cursos').onSnapshot(snap => {
            allCursos = [];
            snap.forEach(doc => {
                const data = doc.data();
                data.id = doc.id;
                data.vencDate = data.vencimiento ? data.vencimiento.toDate() : new Date();
                allCursos.push(data);
            });
            updateBadges();
            if (currentSection === 'cursos') renderCursos();
            else if (currentSection === 'mycursos') renderMyCursos();
        });
    }
    
    function updateBadges() {
        // Badge for unassigned
        const unassigned = allObservaciones.filter(o => !hasResponsables(o) && o.progress < 100).length;
        const badgeObs = document.getElementById('badge-obs');
        if (badgeObs) {
            badgeObs.textContent = unassigned;
            badgeObs.style.display = unassigned > 0 ? 'block' : 'none';
        }
        
        // Badge for my tasks (worker)
        if (currentUser) {
            const myTasks = allObservaciones.filter(o => ((Array.isArray(o.responsables) && o.responsables.includes(currentUser.dni)) || o.assignedTo === currentUser.dni) && o.progress < 100).length;
            const badgeMyTasks = document.getElementById('badge-mytasks');
            if (badgeMyTasks) {
                badgeMyTasks.textContent = myTasks;
                badgeMyTasks.style.display = myTasks > 0 ? 'block' : 'none';
            }
        }
        
        // Badge for expiring courses
        const today = new Date();
        const expiring = allCursos.filter(c => {
            const days = Math.ceil((c.vencDate - today) / (1000 * 60 * 60 * 24));
            return days <= 30 && days > 0;
        }).length;
        const expired = allCursos.filter(c => c.vencDate < today).length;
        const badgeCursos = document.getElementById('badge-cursos');
        if (badgeCursos) {
            const total = expiring + expired;
            badgeCursos.textContent = total;
            badgeCursos.style.display = total > 0 ? 'block' : 'none';
        }
    }
    
    // ==================== DASHBOARD (SUPERVISOR) ====================
    
    function loadDashboard() {
        currentSection = 'dashboard';
        setActiveMenu('menu-dashboard');
        document.getElementById('header-title').textContent = 'Panel de Control';
        document.getElementById('fab').style.display = 'flex';
        renderDashboard();
    }
    
    function renderDashboard() {
        destroyCharts();
        const main = document.getElementById('main-content');
        
        const total = allObservaciones.length;
        const pending = allObservaciones.filter(o => o.progress === 0).length;
        const inProgress = allObservaciones.filter(o => o.progress > 0 && o.progress < 100).length;
        const completed = allObservaciones.filter(o => o.progress >= 100).length;
        const urgent = allObservaciones.filter(o => o.priority === 'alta' && o.progress < 100).length;
        const unassigned = allObservaciones.filter(o => !hasResponsables(o) && o.progress < 100).length;
        const actos = allObservaciones.filter(o => o.tipo === 'acto' && o.progress < 100).length;
        const condiciones = allObservaciones.filter(o => o.tipo === 'condicion' && o.progress < 100).length;
        
        // Sectors count
        const bySector = {};
        Object.keys(sectorConfig).forEach(s => {
            bySector[s] = allObservaciones.filter(o => o.sector === s && o.progress < 100).length;
        });
        
        // Expiring courses
        const today = new Date();
        const expiringCourses = allCursos.filter(c => {
            const days = Math.ceil((c.vencDate - today) / (1000*60*60*24));
            return days <= 30 && days > 0;
        }).length;
        const expiredCourses = allCursos.filter(c => c.vencDate < today).length;
        
        let html = '';
        
        // Alert banners
        if (urgent > 0) {
            html += `
                <div class="alert-banner" onclick="filterAndShow('priority','alta')">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="alert-banner-content">
                        <strong>${urgent} Observación${urgent > 1 ? 'es' : ''} URGENTE${urgent > 1 ? 'S' : ''}</strong>
                        <span>Requieren atención inmediata</span>
                    </div>
                    <i class="fas fa-chevron-right arrow"></i>
                </div>
            `;
        }
        
        if (unassigned > 0) {
            html += `
                <div class="alert-banner" style="background:linear-gradient(135deg,var(--warning),var(--warning-light));" onclick="filterAndShow('estado','unassigned')">
                    <i class="fas fa-user-slash"></i>
                    <div class="alert-banner-content">
                        <strong>${unassigned} Sin Asignar</strong>
                        <span>Necesitan un responsable</span>
                    </div>
                    <i class="fas fa-chevron-right arrow"></i>
                </div>
            `;
        }
        
        // Dashboard cards
        html += `
            <div class="dashboard-grid">
                <div class="dash-card primary" onclick="filterAndShow('estado','todos')">
                    <i class="fas fa-clipboard-list"></i>
                    <div class="number">${total}</div>
                    <div class="label">Total</div>
                </div>
                <div class="dash-card urgent" onclick="filterAndShow('priority','alta')">
                    <i class="fas fa-exclamation-circle"></i>
                    <div class="number">${urgent}</div>
                    <div class="label">Urgentes</div>
                </div>
                <div class="dash-card warning" onclick="filterAndShow('estado','pending')">
                    <i class="fas fa-clock"></i>
                    <div class="number">${pending}</div>
                    <div class="label">Pendientes</div>
                </div>
                <div class="dash-card info" onclick="filterAndShow('estado','inprogress')">
                    <i class="fas fa-spinner"></i>
                    <div class="number">${inProgress}</div>
                    <div class="label">En Proceso</div>
                </div>
                <div class="dash-card success" onclick="filterAndShow('estado','completed')">
                    <i class="fas fa-check-circle"></i>
                    <div class="number">${completed}</div>
                    <div class="label">Completados</div>
                </div>
                <div class="dash-card" style="border-left-color:var(--purple);" onclick="loadCursos()">
                    <i class="fas fa-graduation-cap" style="color:var(--purple)"></i>
                    <div class="number" style="color:var(--purple)">${expiredCourses + expiringCourses}</div>
                    <div class="label">Cursos Críticos</div>
                </div>
            </div>
        `;
        
        // Progress bar
        const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
        html += `
            <div class="progress-section">
                <h4><i class="fas fa-chart-line"></i> Avance General</h4>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width:${completionRate}%;background:${getProgressColor(completionRate)}">${completionRate}%</div>
                </div>
                <div class="progress-stats">
                    <span>Resueltas: ${completed}</span>
                    <span>Pendientes: ${total - completed}</span>
                </div>
            </div>
        `;
        
        // Charts
        html += `
            <div class="charts-row">
                <div class="chart-card">
                    <h4><i class="fas fa-tags"></i> Por Tipo</h4>
                    <canvas id="chart-tipo"></canvas>
                </div>
                <div class="chart-card">
                    <h4><i class="fas fa-map-marker-alt"></i> Por Sector</h4>
                    <canvas id="chart-sector"></canvas>
                </div>
            </div>
        `;
        
        // Quick actions
        html += `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;">
                <button class="btn btn-primary" onclick="loadObservaciones()" style="margin:0;">
                    <i class="fas fa-list"></i> Ver Todo
                </button>
                <button class="btn btn-success" onclick="openNewObsModal()" style="margin:0;">
                    <i class="fas fa-plus"></i> Crear
                </button>
            </div>
        `;
        
        main.innerHTML = html;
        
        // Render charts
        setTimeout(() => {
            // Tipo chart
            const ctxTipo = document.getElementById('chart-tipo');
            if (ctxTipo) {
                charts.push(new Chart(ctxTipo, {
                    type: 'doughnut',
                    data: {
                        labels: ['Actos', 'Condiciones'],
                        datasets: [{
                            data: [actos, condiciones],
                            backgroundColor: ['#EF5350', '#42A5F5']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
                        onClick: (e, elements) => {
                            if (elements.length > 0) {
                                const idx = elements[0].index;
                                filterAndShow('tipo', idx === 0 ? 'acto' : 'condicion');
                            }
                        }
                    }
                }));
            }
            
            // Sector chart
            const ctxSector = document.getElementById('chart-sector');
            if (ctxSector) {
                charts.push(new Chart(ctxSector, {
                    type: 'bar',
                    data: {
                        labels: Object.values(sectorConfig).map(s => s.label),
                        datasets: [{
                            data: Object.keys(sectorConfig).map(k => bySector[k]),
                            backgroundColor: Object.values(sectorConfig).map(s => s.color)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                        onClick: (e, elements) => {
                            if (elements.length > 0) {
                                const idx = elements[0].index;
                                const sector = Object.keys(sectorConfig)[idx];
                                filterAndShow('sector', sector);
                            }
                        }
                    }
                }));
            }
        }, 100);
    }
    
    function filterAndShow(filterType, value) {
        currentFilters = {sector: 'todos', tipo: 'todos', estado: 'todos', responsable: 'todos'};
        
        if (filterType === 'sector') currentFilters.sector = value;
        else if (filterType === 'tipo') currentFilters.tipo = value;
        else if (filterType === 'priority') currentFilters.estado = 'urgent';
        else if (filterType === 'estado') {
            if (value === 'pending') currentFilters.estado = 'pendiente';
            else if (value === 'inprogress') currentFilters.estado = 'proceso';
            else if (value === 'completed') currentFilters.estado = 'completado';
            else if (value === 'unassigned') currentFilters.estado = 'unassigned';
        }
        
        loadObservaciones();
    }
    
    // ==================== OBSERVACIONES LIST (SUPERVISOR) ====================
    
    function loadObservaciones() {
        currentSection = 'observaciones';
        setActiveMenu('menu-observaciones');
        document.getElementById('header-title').textContent = 'Observaciones';
        document.getElementById('fab').style.display = 'flex';
        renderObservaciones();
    }
    
    function renderObservaciones() {
        const main = document.getElementById('main-content');
        

        // Preservar filtros cuando el usuario cambia selects desde Observaciones
        const prevSearchVal = document.getElementById('search-obs') ? document.getElementById('search-obs').value : '';
        const prevTipoVal = document.getElementById('filter-tipo') ? document.getElementById('filter-tipo').value : null;
        const prevEstadoVal = document.getElementById('filter-estado') ? document.getElementById('filter-estado').value : null;

        if (prevTipoVal) currentFilters.tipo = prevTipoVal;
        if (prevEstadoVal) currentFilters.estado = prevEstadoVal;
        let html = `
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="search-obs" placeholder="Buscar..." oninput="renderObservaciones()">
                <i class="fas fa-times search-clear" onclick="clearSearch()"></i>
            </div>
            
            <div class="tabs" id="sector-tabs"></div>
            
            <div class="filter-bar">
                <select id="filter-tipo" onchange="renderObservaciones()">
                    <option value="todos">Todos los tipos</option>
                    <option value="acto">⚠️ Actos</option>
                    <option value="condicion">🔧 Condiciones</option>
                </select>
                <select id="filter-estado" onchange="renderObservaciones()">
                    <option value="todos">Todos los estados</option>
                    <option value="urgent">🔴 Urgentes</option>
                    <option value="unassigned">👤 Sin asignar</option>
                    <option value="pendiente">⏳ Pendientes</option>
                    <option value="proceso">🔄 En proceso</option>
                    <option value="completado">✅ Completados</option>
                </select>
            </div>
            
            <div class="obs-list" id="obs-list"></div>
        `;
        
        main.innerHTML = html;

        // Restaurar búsqueda (para no perder lo escrito)
        const s = document.getElementById('search-obs');
        if (s) s.value = prevSearchVal;

        // Set filter values
        document.getElementById('filter-tipo').value = currentFilters.tipo;
        document.getElementById('filter-estado').value = currentFilters.estado;
        
        renderSectorTabs();
        renderObsList();
    }
    
    function renderSectorTabs() {
        const container = document.getElementById('sector-tabs');
        if (!container) return;
        
        let html = `<div class="tab ${currentFilters.sector === 'todos' ? 'active' : ''}" onclick="setFilterSector('todos')">Todos</div>`;
        Object.keys(sectorConfig).forEach(s => {
            html += `<div class="tab ${currentFilters.sector === s ? 'active' : ''}" onclick="setFilterSector('${s}')">${sectorConfig[s].label}</div>`;
        });
        container.innerHTML = html;
    }
    
    function setFilterSector(sector) {
        currentFilters.sector = sector;
        renderSectorTabs();
        renderObsList();
    }
    
    function renderObsList() {
        const container = document.getElementById('obs-list');
        if (!container) return;
        
        let filtered = [...allObservaciones];
        
        // Search
        const search = document.getElementById('search-obs');
        if (search && search.value.trim()) {
            const q = search.value.toLowerCase();
            filtered = filtered.filter(o => 
                (o.descripcion && o.descripcion.toLowerCase().includes(q)) ||
                (o.reportadoPor && o.reportadoPor.toLowerCase().includes(q)) ||
                (o.assignedToName && o.assignedToName.toLowerCase().includes(q))
            );
            document.querySelector('.search-clear').classList.add('show');
        }
        
        // Sector filter
        if (currentFilters.sector !== 'todos') {
            filtered = filtered.filter(o => o.sector === currentFilters.sector);
        }
        
        // Tipo filter
        const tipoFilter = document.getElementById('filter-tipo');
        if (tipoFilter && tipoFilter.value !== 'todos') {
            filtered = filtered.filter(o => o.tipo === tipoFilter.value);
        }
        
        // Estado filter
        const estadoFilter = document.getElementById('filter-estado');
        if (estadoFilter && estadoFilter.value !== 'todos') {
            const val = estadoFilter.value;
            if (val === 'urgent') filtered = filtered.filter(o => o.priority === 'alta' && o.progress < 100);
            else if (val === 'unassigned') filtered = filtered.filter(o => !hasResponsables(o) && o.progress < 100);
            else if (val === 'pendiente') filtered = filtered.filter(o => o.progress === 0);
            else if (val === 'proceso') filtered = filtered.filter(o => o.progress > 0 && o.progress < 100);
            else if (val === 'completado') filtered = filtered.filter(o => o.progress >= 100);
        }
        
        // Sort: urgent first, then by date
        filtered.sort((a, b) => {
            if (a.progress < 100 && b.progress >= 100) return -1;
            if (a.progress >= 100 && b.progress < 100) return 1;
            const prioOrder = {alta: 0, media: 1, baja: 2};
            if (a.progress < 100 && b.progress < 100) {
                if (prioOrder[a.priority] !== prioOrder[b.priority]) {
                    return prioOrder[a.priority] - prioOrder[b.priority];
                }
            }
            return b.fechaDate - a.fechaDate;
        });
        
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clipboard-check"></i>
                    <p>No hay observaciones</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filtered.map(o => renderObsCard(o)).join('');
    }
    
    function renderObsCard(o) {
        const status = getStatusInfo(o.progress);
        const sector = sectorConfig[o.sector] || {icon: 'fa-question', label: o.sector, color: '#999'};
        const respLabel = getResponsablesLabel(o);
        const respHas = respLabel !== 'Sin asignar';
        
        return `
            <div class="obs-card ${o.progress >= 100 ? 'completed' : o.progress > 0 ? 'in-progress' : ''}" onclick="openDetailObs('${o.id}')">
                <div class="obs-card-top">
                    <span class="obs-card-type type-${o.tipo}">
                        <i class="fas ${o.tipo === 'acto' ? 'fa-user-slash' : 'fa-tools'}"></i>
                        ${o.tipo === 'acto' ? 'Acto' : 'Condición'}
                    </span>
                    ${o.progress < 100 ? `<span class="obs-card-priority priority-${o.priority}">${o.priority.toUpperCase()}</span>` : ''}
                </div>
                <h3>${o.descripcion || 'Sin descripción'}</h3>
                <div class="obs-card-meta">
                    <span><i class="fas ${sector.icon}" style="color:${sector.color}"></i> ${sector.label}</span>
                    <span><i class="fas fa-clock"></i> ${relativeTime(o.fechaDate)}</span>
                    <span><i class="fas fa-user"></i> ${getShortName(o.reportadoPor)}</span>
                </div>
                <div class="obs-card-footer">
                    <div class="obs-card-assignee ${respHas ? '' : 'unassigned'}">
                        <i class="fas ${respHas ? 'fa-user-check' : 'fa-user-slash'}"></i>
                        ${respLabel}
                    </div>
                    <div class="obs-card-progress">
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width:${o.progress}%;background:${getProgressColor(o.progress)}"></div>
                        </div>
                        <span class="progress-text">${o.progress}%</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    function clearSearch() {
        const input = document.getElementById('search-obs');
        if (input) {
            input.value = '';
            document.querySelector('.search-clear').classList.remove('show');
            renderObsList();
        }
    }

    // ==================== WORKER VIEWS ====================

    function loadMyTasks() {
        currentSection = 'mytasks';
        setActiveMenu('menu-mytasks');
        document.getElementById('header-title').textContent = 'Mis Tareas';
        document.getElementById('fab').style.display = 'flex';
        renderMyTasks();
    }

    function renderMyTasks() {
        const main = document.getElementById('main-content');

        main.innerHTML = `
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="search-mytasks" placeholder="Buscar en mis tareas..." oninput="renderMyTasksList()">
                <i class="fas fa-times search-clear" onclick="clearMyTasksSearch()"></i>
            </div>

            <div class="filter-bar">
                <select id="filter-mytasks-estado" onchange="renderMyTasksList()">
                    <option value="todos">Todos los estados</option>
                    <option value="pendiente">⏳ Pendientes</option>
                    <option value="proceso">🔄 En proceso</option>
                    <option value="completado">✅ Completados</option>
                </select>
            </div>

            <div class="obs-list" id="mytasks-list"></div>
        `;

        renderMyTasksList();
    }

    function clearMyTasksSearch() {
        const input = document.getElementById('search-mytasks');
        const clearBtn = document.querySelector('#main-content .search-clear');
        if (input) input.value = '';
        if (clearBtn) clearBtn.classList.remove('show');
        renderMyTasksList();
    }

    function renderMyTasksList() {
        const container = document.getElementById('mytasks-list');
        if (!container || !currentUser) return;

        // Mis tareas: asignadas a mí (y también las que yo reporté)
        let filtered = allObservaciones.filter(o =>
            ((Array.isArray(o.responsables) && o.responsables.includes(currentUser.dni)) || o.assignedTo === currentUser.dni) || (o.reportadoPorDni === currentUser.dni)
        );

        // Search
        const search = document.getElementById('search-mytasks');
        const clearBtn = document.querySelector('#main-content .search-clear');
        if (search && search.value.trim()) {
            const q = search.value.toLowerCase();
            filtered = filtered.filter(o =>
                (o.descripcion && o.descripcion.toLowerCase().includes(q)) ||
                (o.reportadoPor && o.reportadoPor.toLowerCase().includes(q)) ||
                (o.assignedToName && o.assignedToName.toLowerCase().includes(q))
            );
            if (clearBtn) clearBtn.classList.add('show');
        } else {
            if (clearBtn) clearBtn.classList.remove('show');
        }

        // Estado filter
        const estadoFilter = document.getElementById('filter-mytasks-estado');
        if (estadoFilter && estadoFilter.value !== 'todos') {
            const val = estadoFilter.value;
            if (val === 'pendiente') filtered = filtered.filter(o => o.progress === 0);
            else if (val === 'proceso') filtered = filtered.filter(o => o.progress > 0 && o.progress < 100);
            else if (val === 'completado') filtered = filtered.filter(o => o.progress >= 100);
        }

        // Sort: pendientes primero, luego prioridad, luego fecha
        filtered.sort((a, b) => {
            if (a.progress < 100 && b.progress >= 100) return -1;
            if (a.progress >= 100 && b.progress < 100) return 1;
            const prioOrder = {alta: 0, media: 1, baja: 2};
            if (a.progress < 100 && b.progress < 100) {
                if (prioOrder[a.priority] !== prioOrder[b.priority]) {
                    return prioOrder[a.priority] - prioOrder[b.priority];
                }
            }
            return b.fechaDate - a.fechaDate;
        });

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <p>No tienes tareas asignadas</p>
                </div>
            `;
            return;
        }

        container.innerHTML = filtered.map(o => renderObsCard(o)).join('');
    }

    function loadAllObsWorker() {
        currentSection = 'allobs';
        setActiveMenu('menu-all-obs');
        document.getElementById('header-title').textContent = 'Observaciones';
        document.getElementById('fab').style.display = 'flex';
        renderAllObsWorker();
    }

    function renderAllObsWorker() {
        const main = document.getElementById('main-content');

        main.innerHTML = `
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="search-allobs" placeholder="Buscar..." oninput="renderAllObsWorkerList()">
                <i class="fas fa-times search-clear" onclick="clearAllObsSearch()"></i>
            </div>

            <div class="tabs" id="sector-tabs-worker"></div>

            <div class="filter-bar">
                <select id="filter-allobs-tipo" onchange="renderAllObsWorkerList()">
                    <option value="todos">Todos los tipos</option>
                    <option value="acto">⚠️ Actos</option>
                    <option value="condicion">🔧 Condiciones</option>
                </select>
                <select id="filter-allobs-estado" onchange="renderAllObsWorkerList()">
                    <option value="todos">Todos los estados</option>
                    <option value="pendiente">⏳ Pendientes</option>
                    <option value="proceso">🔄 En proceso</option>
                    <option value="completado">✅ Completados</option>
                </select>
            </div>

            <div class="obs-list" id="allobs-list"></div>
        `;

        renderSectorTabsWorker();
        renderAllObsWorkerList();
    }

    function renderSectorTabsWorker() {
        const container = document.getElementById('sector-tabs-worker');
        if (!container) return;

        let html = `<div class="tab active" data-sector="todos" onclick="setWorkerSector('todos')">Todos</div>`;
        Object.keys(sectorConfig).forEach(s => {
            html += `<div class="tab" data-sector="${s}" onclick="setWorkerSector('${s}')">${sectorConfig[s].label}</div>`;
        });
        container.innerHTML = html;
    }

    let workerSectorFilter = 'todos';
    function setWorkerSector(sector) {
        workerSectorFilter = sector;
        document.querySelectorAll('#sector-tabs-worker .tab').forEach(t => {
            t.classList.toggle('active', t.getAttribute('data-sector') === sector);
        });
        renderAllObsWorkerList();
    }

    function clearAllObsSearch() {
        const input = document.getElementById('search-allobs');
        const clearBtn = document.querySelector('#main-content .search-clear');
        if (input) input.value = '';
        if (clearBtn) clearBtn.classList.remove('show');
        renderAllObsWorkerList();
    }

    function renderAllObsWorkerList() {
        const container = document.getElementById('allobs-list');
        if (!container) return;

        let filtered = [...allObservaciones];

        // Search
        const search = document.getElementById('search-allobs');
        const clearBtn = document.querySelector('#main-content .search-clear');
        if (search && search.value.trim()) {
            const q = search.value.toLowerCase();
            filtered = filtered.filter(o =>
                (o.descripcion && o.descripcion.toLowerCase().includes(q)) ||
                (o.reportadoPor && o.reportadoPor.toLowerCase().includes(q)) ||
                (o.assignedToName && o.assignedToName.toLowerCase().includes(q))
            );
            if (clearBtn) clearBtn.classList.add('show');
        } else {
            if (clearBtn) clearBtn.classList.remove('show');
        }

        // Sector filter
        if (workerSectorFilter !== 'todos') {
            filtered = filtered.filter(o => o.sector === workerSectorFilter);
        }

        // Tipo filter
        const tipoFilter = document.getElementById('filter-allobs-tipo');
        if (tipoFilter && tipoFilter.value !== 'todos') {
            filtered = filtered.filter(o => o.tipo === tipoFilter.value);
        }

        // Estado filter
        const estadoFilter = document.getElementById('filter-allobs-estado');
        if (estadoFilter && estadoFilter.value !== 'todos') {
            const val = estadoFilter.value;
            if (val === 'pendiente') filtered = filtered.filter(o => o.progress === 0);
            else if (val === 'proceso') filtered = filtered.filter(o => o.progress > 0 && o.progress < 100);
            else if (val === 'completado') filtered = filtered.filter(o => o.progress >= 100);
        }

        // Sort: pendientes primero, luego prioridad, luego fecha
        filtered.sort((a, b) => {
            if (a.progress < 100 && b.progress >= 100) return -1;
            if (a.progress >= 100 && b.progress < 100) return 1;
            const prioOrder = {alta: 0, media: 1, baja: 2};
            if (a.progress < 100 && b.progress < 100) {
                if (prioOrder[a.priority] !== prioOrder[b.priority]) {
                    return prioOrder[a.priority] - prioOrder[b.priority];
                }
            }
            return b.fechaDate - a.fechaDate;
        });

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clipboard-check"></i>
                    <p>No hay observaciones</p>
                </div>
            `;
            return;
        }

        container.innerHTML = filtered.map(o => renderObsCard(o)).join('');
    }

    // ==================== DETAIL VIEW ====================

    function openDetailObs(id) {
        currentObsId = id;
        const obs = allObservaciones.find(o => o.id === id);
        if (!obs) {
            showToast('Observación no encontrada', 'error');
            return;
        }

        const sector = sectorConfig[obs.sector] || { icon: 'fa-question', label: obs.sector || 'N/A', color: '#999' };
        const status = getStatusInfo(obs.progress);
        const respLabel = getResponsablesLabel(obs);
        const respHas = respLabel !== 'Sin asignar';


        let contentHtml = `
            <div style="background:var(--bg-white);padding:15px;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);margin-bottom:15px;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px;">
                    <div>
                        <span class="obs-card-type type-${obs.tipo}" style="display:inline-flex;margin-right:8px;">
                            <i class="fas ${obs.tipo === 'acto' ? 'fa-user-slash' : 'fa-tools'}"></i>
                            ${obs.tipo === 'acto' ? 'Acto' : 'Condición'}
                        </span>
                        ${obs.progress < 100 ? `<span class="obs-card-priority priority-${obs.priority}" style="display:inline-block;">${(obs.priority || 'media').toUpperCase()}</span>` : ''}
                    </div>
                    <div style="font-size:12px;color:var(--text-light);font-weight:700;">${formatDate(obs.fechaDate)}</div>
                </div>

                <h3 style="font-size:18px;font-weight:800;margin-bottom:10px;line-height:1.3;">
                    ${obs.descripcion || 'Sin descripción'}
                </h3>

                <div style="display:flex;flex-wrap:wrap;gap:10px;font-size:13px;color:var(--text-medium);margin-bottom:12px;">
                    <span><i class="fas ${sector.icon}" style="color:${sector.color}"></i> ${sector.label}</span>
                    <span><i class="fas fa-user"></i> ${obs.reportadoPor ? getShortName(obs.reportadoPor) : 'N/A'}</span>
                    <span><i class="fas fa-clock"></i> ${relativeTime(obs.fechaDate)}</span>
                    <span><i class="fas ${respHas ? 'fa-user-check' : 'fa-user-slash'}"></i> ${respLabel}</span>
                </div>
            </div>

            <div style="background:var(--bg-white);padding:15px;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);margin-bottom:15px;">
                <div style="font-weight:700;margin-bottom:8px;">Avance: <span style="color:${getProgressColor(obs.progress)}">${obs.progress}%</span></div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width:${obs.progress}%;background:${getProgressColor(obs.progress)}">${obs.progress}%</div>
                </div>
                <div style="text-align:center;margin-top:8px;">
                    <span class="${status.class}" style="padding:6px 16px;border-radius:50px;font-size:13px;font-weight:700;">${status.label}</span>
                </div>
            </div>
        `;

        // Resolution comment if completed
        if (obs.progress >= 100 && obs.comentarioResolucion) {
            contentHtml += `
                <div style="background:rgba(46,125,50,0.1);padding:12px;border-radius:var(--radius-sm);border-left:4px solid var(--success);margin-bottom:15px;">
                    <strong style="color:var(--success);"><i class="fas fa-check-circle"></i> Resolución</strong>
                    <p style="margin-top:6px;font-size:14px;">${obs.comentarioResolucion}</p>
                </div>
            `;
        }

        // History
        if (obs.history && obs.history.length > 0) {
            const sortedHistory = [...obs.history].sort((a, b) => {
                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                return dateB - dateA;
            });

            contentHtml += `
                <div style="margin-bottom:15px;">
                    <h4 style="font-size:14px;color:var(--text-medium);margin-bottom:10px;"><i class="fas fa-history"></i> Historial</h4>
                    <div class="history-list">
                        ${sortedHistory.map(h => {
                            const date = h.timestamp?.toDate ? h.timestamp.toDate() : new Date(h.timestamp);
                            return `
                                <div class="history-item">
                                    <strong>${getShortName(h.user)}</strong> - ${h.progress}%
                                    <p>${h.comment || ''}</p>
                                    <small>${date.toLocaleString('es-PE')}</small>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        document.getElementById('detail-content').innerHTML = contentHtml;

        // Actions
        let actionsHtml = '';

        if (obs.progress < 100) {
            // Can update progress
            const canUpdate = currentUser.rol === 'supervisor' || 
                              ((Array.isArray(obs.responsables) && obs.responsables.includes(currentUser.dni)) || obs.assignedTo === currentUser.dni) || 
                              obs.reportadoPor === currentUser.nombre;

            if (canUpdate) {
                actionsHtml += `
                    <button class="btn btn-primary" onclick="openUpdateProgress()" style="margin-bottom:10px;">
                        <i class="fas fa-tasks"></i> Actualizar Avance
                    </button>
                `;
            }

            // Supervisor can assign
            if (currentUser.rol === 'supervisor') {
                actionsHtml += `
                    <button class="btn" style="background:var(--info);color:#fff;margin-bottom:10px;" onclick="openAssignModal()">
                        <i class="fas fa-user-plus"></i> ${hasResponsables(obs) ? 'Editar' : 'Asignar'} Responsables
                    </button>
                `;
            }
        }

        // Supervisor can delete
        if (currentUser.rol === 'supervisor' && currentUser.nombre !== 'Invitado') {
            actionsHtml += `
                <button class="btn btn-danger" onclick="deleteObs()">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            `;
        }

        document.getElementById('detail-actions').innerHTML = actionsHtml;
        document.getElementById('modal-detail-obs').style.display = 'block';
    }

    function openAssignModal() {
        const list = document.getElementById('assign-list');
        if (!list) return;

        list.innerHTML = '';

        const obs = allObservaciones.find(o => o.id === currentObsId);
        const selected = new Set();

        if (obs) {
            if (Array.isArray(obs.responsables)) obs.responsables.forEach(d => selected.add(d));
            if (obs.assignedTo) selected.add(obs.assignedTo);
        }

        usuarios.forEach(u => {
            const checked = selected.has(u.dni) ? 'checked' : '';
            list.innerHTML += `
                <label class="assign-item">
                    <input type="checkbox" value="${u.dni}" ${checked}>
                    <span class="assign-item-name">${getDisplayNameCursos(u.nombre)}</span>
                    <span class="assign-item-dni">${u.dni}</span>
                </label>
            `;
        });

        document.getElementById('modal-assign').style.display = 'block';
    }

    function confirmAssign() {
        const list = document.getElementById('assign-list');
        if (!list) return;

        const selectedDnis = Array.from(list.querySelectorAll('input[type="checkbox"]:checked'))
            .map(i => i.value);

        const obs = allObservaciones.find(o => o.id === currentObsId);

        const primaryDni = selectedDnis.length > 0 ? selectedDnis[0] : null;
        const primaryUser = primaryDni ? usuarios.find(u => u.dni === primaryDni) : null;
        const primaryName = primaryUser ? primaryUser.nombre : null;

        const namesForMsg = selectedDnis.map(dni => {
            const u = usuarios.find(x => x.dni === dni);
            return u && u.nombre ? getShortName(u.nombre) : dni;
        });

        const comment = selectedDnis.length > 0
            ? `Responsables: ${namesForMsg.join(', ')}`
            : 'Responsables removidos (Sin asignar)';

        const historyEntry = {
            user: currentUser.nombre,
            timestamp: new Date(),
            progress: obs ? (obs.progress || 0) : 0,
            comment
        };

        db.collection('observaciones').doc(currentObsId).update({
            responsables: selectedDnis,
            assignedTo: primaryDni,
            assignedToName: primaryName,
            history: firebase.firestore.FieldValue.arrayUnion(historyEntry)
        }).then(() => {
            showToast(selectedDnis.length > 0 ? `Responsables actualizados: ${namesForMsg.join(', ')}` : 'Observación sin responsables');
            closeModal('modal-assign');
            closeModal('modal-detail-obs');
        }).catch(e => {
            console.error(e);
            showToast('Error al asignar', 'error');
        });
    }

    function openUpdateProgress() {
        const obs = allObservaciones.find(o => o.id === currentObsId);
        if (!obs) return;
        
        updateProgressValue = obs.progress;
        document.getElementById('update-progress-display').textContent = updateProgressValue + '%';
        document.getElementById('update-progress-value').value = updateProgressValue;
        document.getElementById('update-comment').value = '';
        
        // Update presets active state
        document.querySelectorAll('#update-presets .wheel-preset').forEach(p => {
            p.classList.toggle('active', parseInt(p.textContent) === updateProgressValue);
        });
        
        closeModal('modal-detail-obs');
        document.getElementById('modal-update-progress').style.display = 'block';
    }
    
    function changeUpdateProgress(delta) {
        updateProgressValue = Math.max(0, Math.min(100, updateProgressValue + delta));
        document.getElementById('update-progress-display').textContent = updateProgressValue + '%';
        document.getElementById('update-progress-value').value = updateProgressValue;
        
        document.querySelectorAll('#update-presets .wheel-preset').forEach(p => {
            p.classList.toggle('active', parseInt(p.textContent) === updateProgressValue);
        });
    }
    
    function setUpdateProgress(val) {
        updateProgressValue = val;
        document.getElementById('update-progress-display').textContent = updateProgressValue + '%';
        document.getElementById('update-progress-value').value = updateProgressValue;
        
        document.querySelectorAll('#update-presets .wheel-preset').forEach(p => {
            p.classList.toggle('active', parseInt(p.textContent) === updateProgressValue);
        });
    }
    
    function confirmUpdateProgress() {
        const comment = document.getElementById('update-comment').value.trim();
        
        if (!comment) {
            showToast('Escribe un comentario', 'error');
            return;
        }
        
        const historyEntry = {
            user: currentUser.nombre,
            timestamp: new Date(),
            progress: updateProgressValue,
            comment: comment
        };
        
        const updateData = {
            progress: updateProgressValue,
            history: firebase.firestore.FieldValue.arrayUnion(historyEntry)
        };
        
        if (updateProgressValue >= 100) {
            updateData.resuelto = true;
            updateData.comentarioResolucion = comment;
            updateData.fechaResolucion = firebase.firestore.FieldValue.serverTimestamp();
        }
        
        db.collection('observaciones').doc(currentObsId).update(updateData).then(() => {
            showToast('Avance actualizado');
            closeModal('modal-update-progress');
        }).catch(e => {
            console.error(e);
            showToast('Error al actualizar', 'error');
        });
    }
    
    function deleteObs() {
        if (!confirm('¿Eliminar esta observación permanentemente?')) return;
        
        db.collection('observaciones').doc(currentObsId).delete().then(() => {
            showToast('Observación eliminada');
            closeModal('modal-detail-obs');
        }).catch(e => {
            console.error(e);
            showToast('Error al eliminar', 'error');
        });
    }
    
    // ==================== NEW OBSERVATION ====================
    
    function openNewObsModal() {
        // Reset form
        document.querySelectorAll('.type-option').forEach(e => e.classList.remove('selected'));
        document.querySelectorAll('.sector-option').forEach(e => e.classList.remove('selected'));
        document.querySelectorAll('.priority-option').forEach(e => e.classList.remove('selected'));
        document.querySelector('.priority-option[data-priority="media"]').classList.add('selected');
        
        document.getElementById('new-obs-type').value = '';
        document.getElementById('new-obs-sector').value = '';
        document.getElementById('new-obs-priority').value = 'media';
        document.getElementById('new-obs-desc').value = '';
        document.getElementById('new-obs-progress').value = '0';
        document.getElementById('new-obs-resolution').value = '';
        document.getElementById('resolution-comment-group').style.display = 'none';
        
        newObsProgress = 0;
        document.getElementById('progress-display').textContent = '0%';
        document.querySelectorAll('.wheel-presets .wheel-preset').forEach(p => {
            p.classList.toggle('active', p.textContent === '0%');
        });
        
        document.getElementById('modal-new-obs').style.display = 'block';
    }
    
    function selectType(type) {
        document.querySelectorAll('.type-option').forEach(e => e.classList.remove('selected'));
        document.querySelector(`.type-option[data-type="${type}"]`).classList.add('selected');
        document.getElementById('new-obs-type').value = type;
    }
    
    function selectSector(sector) {
        document.querySelectorAll('.sector-option').forEach(e => e.classList.remove('selected'));
        document.querySelector(`.sector-option[data-sector="${sector}"]`).classList.add('selected');
        document.getElementById('new-obs-sector').value = sector;
    }
    
    function selectPriority(priority) {
        document.querySelectorAll('.priority-option').forEach(e => e.classList.remove('selected'));
        document.querySelector(`.priority-option[data-priority="${priority}"]`).classList.add('selected');
        document.getElementById('new-obs-priority').value = priority;
    }
    
    function changeProgress(delta) {
        newObsProgress = Math.max(0, Math.min(100, newObsProgress + delta));
        document.getElementById('progress-display').textContent = newObsProgress + '%';
        document.getElementById('new-obs-progress').value = newObsProgress;
        document.getElementById('resolution-comment-group').style.display = newObsProgress >= 100 ? 'block' : 'none';
        
        document.querySelectorAll('.wheel-presets .wheel-preset').forEach(p => {
            p.classList.toggle('active', parseInt(p.textContent) === newObsProgress);
        });
    }
    
    function setProgress(val) {
        newObsProgress = val;
        document.getElementById('progress-display').textContent = newObsProgress + '%';
        document.getElementById('new-obs-progress').value = newObsProgress;
        document.getElementById('resolution-comment-group').style.display = newObsProgress >= 100 ? 'block' : 'none';
        
        document.querySelectorAll('.wheel-presets .wheel-preset').forEach(p => {
            p.classList.toggle('active', parseInt(p.textContent) === newObsProgress);
        });
    }
    
    function saveNewObs() {
        const type = document.getElementById('new-obs-type').value;
        const sector = document.getElementById('new-obs-sector').value;
        const priority = document.getElementById('new-obs-priority').value;
        const desc = document.getElementById('new-obs-desc').value.trim();
        const progress = parseInt(document.getElementById('new-obs-progress').value) || 0;
        const resolution = document.getElementById('new-obs-resolution').value.trim();
        
        if (!type) { showToast('Selecciona el tipo (Acto o Condición)', 'error'); return; }
        if (!sector) { showToast('Selecciona un sector', 'error'); return; }
        if (!desc) { showToast('Escribe una descripción', 'error'); return; }
        if (progress >= 100 && !resolution) { showToast('Escribe cómo se resolvió', 'error'); return; }
        
        const btn = document.getElementById('btn-save-new-obs');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> Guardando...';
        
        const historyEntry = {
            user: currentUser.nombre,
            timestamp: new Date(),
            progress: progress,
            comment: progress >= 100 ? resolution : 'Observación creada'
        };
        
        const data = {
            tipo: type,
            sector: sector,
            priority: priority,
            descripcion: desc,
            reportadoPor: currentUser.nombre,
            reportadoPorDni: currentUser.dni,
            fechaReporte: firebase.firestore.FieldValue.serverTimestamp(),
            progress: progress,
            resuelto: progress >= 100,
            comentarioResolucion: progress >= 100 ? resolution : null,
            fechaResolucion: progress >= 100 ? firebase.firestore.FieldValue.serverTimestamp() : null,
            history: [historyEntry],
            assignedTo: null,
            assignedToName: null
        };
        
        db.collection('observaciones').add(data).then(() => {
            showToast('Observación guardada');
            closeModal('modal-new-obs');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> GUARDAR OBSERVACIÓN';
        }).catch(e => {
            console.error(e);
            showToast('Error al guardar', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> GUARDAR OBSERVACIÓN';
        });
    }
    
    // ==================== VOICE INPUT ====================
    
    function toggleVoice(targetId) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            showToast('Tu navegador no soporta voz', 'error');
            return;
        }
        
        if (isRecording) {
            recognition.stop();
            isRecording = false;
            document.querySelectorAll('.voice-btn').forEach(b => {
                b.classList.remove('recording');
                b.innerHTML = '<i class="fas fa-microphone"></i>';
            });
            return;
        }
        
        recognition = new SpeechRecognition();
        recognition.lang = 'es-PE';
        recognition.continuous = true;
        recognition.interimResults = true;
        
        recognition.onresult = (e) => {
            let transcript = '';
            for (let i = e.resultIndex; i < e.results.length; i++) {
                transcript += e.results[i][0].transcript;
            }
            document.getElementById(targetId).value += transcript + ' ';
        };
        
        recognition.onend = () => {
            isRecording = false;
            document.querySelectorAll('.voice-btn').forEach(b => {
                b.classList.remove('recording');
                b.innerHTML = '<i class="fas fa-microphone"></i>';
            });
        };
        
        recognition.onerror = () => {
            isRecording = false;
            showToast('Error con el micrófono', 'error');
        };
        
        recognition.start();
        isRecording = true;
        document.querySelectorAll('.voice-btn').forEach(b => {
            b.classList.add('recording');
            b.innerHTML = '<i class="fas fa-stop"></i>';
        });
        showToast('Escuchando...', 'warning');
    }
    
    // ==================== CURSOS (SUPERVISOR) ====================
    
    function loadCursos() {
        currentSection = 'cursos';
        setActiveMenu('menu-cursos');
        document.getElementById('header-title').textContent = 'Gestión de Cursos';
        document.getElementById('fab').style.display = 'none';
        renderCursos();
    }
    
    function renderCursos() {
        const main = document.getElementById('main-content');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Stats
        let vigentes = 0, porVencer = 0, vencidos = 0;
        allCursos.forEach(c => {
            const days = Math.ceil((c.vencDate - today) / (1000 * 60 * 60 * 24));
            if (days > 90) vigentes++;
            else if (days > 0) porVencer++;
            else vencidos++;
        });
        
        // Build matrix
        const personNames = usuarios.map(u => u.nombre).sort();
        const cursoNames = [...new Set(allCursos.map(c => c.curso))].sort();
        
        const matrix = {};
        personNames.forEach(p => { matrix[p] = {}; });
        
        allCursos.forEach(c => {
            const user = usuarios.find(u => u.dni === c.dni);
            if (user && matrix[user.nombre]) {
                const days = Math.ceil((c.vencDate - today) / (1000 * 60 * 60 * 24));
                matrix[user.nombre][c.curso] = { days, id: c.id, date: c.vencDate };
            }
        });
        
        let html = `
            <button class="btn btn-success" onclick="openAddCursoModal()" style="margin-bottom:15px;">
                <i class="fas fa-plus"></i> Añadir Curso
            </button>
            
            <div class="dashboard-grid">
                <div class="dash-card success">
                    <i class="fas fa-check-circle"></i>
                    <div class="number">${vigentes}</div>
                    <div class="label">Vigentes</div>
                </div>
                <div class="dash-card warning">
                    <i class="fas fa-clock"></i>
                    <div class="number">${porVencer}</div>
                    <div class="label">Por Vencer</div>
                </div>
                <div class="dash-card urgent">
                    <i class="fas fa-times-circle"></i>
                    <div class="number">${vencidos}</div>
                    <div class="label">Vencidos</div>
                </div>
                <div class="dash-card primary">
                    <i class="fas fa-graduation-cap"></i>
                    <div class="number">${allCursos.length}</div>
                    <div class="label">Total</div>
                </div>
            </div>
            
            <div style="background:var(--bg-white);padding:12px;border-radius:var(--radius-md);margin-bottom:15px;">
                <h4 style="font-size:13px;color:var(--text-medium);margin-bottom:8px;">Leyenda</h4>
                <div style="display:flex;gap:15px;flex-wrap:wrap;font-size:12px;">
                    <span><span style="display:inline-block;width:12px;height:12px;background:#C8E6C9;border-radius:2px;margin-right:4px;"></span> Vigente (+90 días)</span>
                    <span><span style="display:inline-block;width:12px;height:12px;background:#FFE0B2;border-radius:2px;margin-right:4px;"></span> Por vencer (1-90 días)</span>
                    <span><span style="display:inline-block;width:12px;height:12px;background:#FFCDD2;border-radius:2px;margin-right:4px;"></span> Vencido</span>
                    <span><i class="fas fa-info-circle"></i> <b>###d</b> = días restantes</span>
                </div>
            </div>
        `;
        
        if (cursoNames.length > 0) {
            html += `<div class="matrix-wrapper"><table class="matrix-table"><thead><tr><th class="sticky-col">Personal</th>`;
            cursoNames.forEach(c => { html += `<th>${c}</th>`; });
            html += `</tr></thead><tbody>`;
            
            personNames.forEach(p => {
                html += `<tr><td class="sticky-col" onclick="showPersonalInfo('${p}')" style="cursor:pointer;">${getDisplayNameCursos(p)}</td>`;
                cursoNames.forEach(c => {
                    const data = matrix[p][c];
                    if (data) {
                        let cellClass = 'cell-ok';
                        let text = `${data.days}d`;
                        if (data.days <= 0) {
                            cellClass = 'cell-danger';
                            text = data.days === 0 ? 'HOY' : `${Math.abs(data.days)}d venc.`;
                        } else if (data.days <= 90) {
                            cellClass = 'cell-warning';
                            text = `${data.days}d`;
                        }
                        html += `<td class="${cellClass}" onclick="openEditCurso('${data.id}')" style="cursor:pointer;" title="Vence: ${formatDate(data.date)}">${text}</td>`;
                    } else {
                        html += `<td class="cell-empty">-</td>`;
                    }
                });
                html += `</tr>`;
            });
            
            html += `</tbody></table></div>`;
        } else {
            html += `<div class="empty-state"><i class="fas fa-graduation-cap"></i><p>No hay cursos registrados</p></div>`;
        }
        
        main.innerHTML = html;
    }
    
    function showPersonalInfo(nombre) {
        const user = usuarios.find(u => u.nombre === nombre);
        if (user) {
            document.getElementById('personal-nombre').textContent = user.nombre;
            document.getElementById('personal-dni').textContent = user.dni;
            document.getElementById('modal-personal').style.display = 'block';
        }
    }
    
    function openAddCursoModal() {
        editingCursoId = null;
        document.getElementById('curso-modal-title').innerHTML = '<i class="fas fa-graduation-cap"></i> Añadir Curso';
        
        const select = document.getElementById('curso-personal');
        select.innerHTML = '<option value="">-- Seleccionar personal --</option>';
        usuarios.forEach(u => {
            select.innerHTML += `<option value="${u.dni}">${getShortName(u.nombre)} - ${u.dni}</option>`;
        });
        
        document.getElementById('curso-nombre').value = '';
        document.getElementById('curso-fecha').value = '';
        document.getElementById('btn-delete-curso').style.display = 'none';
        
        document.getElementById('modal-curso').style.display = 'block';
    }
    
    function openEditCurso(id) {
        editingCursoId = id;
        const curso = allCursos.find(c => c.id === id);
        if (!curso) return;
        
        document.getElementById('curso-modal-title').innerHTML = '<i class="fas fa-edit"></i> Editar Curso';
        
        const select = document.getElementById('curso-personal');
        select.innerHTML = '<option value="">-- Seleccionar personal --</option>';
        usuarios.forEach(u => {
            const selected = u.dni === curso.dni ? 'selected' : '';
            select.innerHTML += `<option value="${u.dni}" ${selected}>${getShortName(u.nombre)} - ${u.dni}</option>`;
        });
        
        document.getElementById('curso-nombre').value = curso.curso || '';
        document.getElementById('curso-fecha').value = curso.vencDate.toISOString().split('T')[0];
        document.getElementById('btn-delete-curso').style.display = 'block';
        
        document.getElementById('modal-curso').style.display = 'block';
    }
    
    function saveCurso() {
        const dni = document.getElementById('curso-personal').value;
        const nombre = document.getElementById('curso-nombre').value.trim();
        const fecha = document.getElementById('curso-fecha').value;
        
        if (!dni) { showToast('Selecciona el personal', 'error'); return; }
        if (!nombre) { showToast('Escribe el nombre del curso', 'error'); return; }
        if (!fecha) { showToast('Selecciona la fecha', 'error'); return; }
        
        const data = {
            dni: dni,
            curso: nombre,
            vencimiento: firebase.firestore.Timestamp.fromDate(new Date(fecha))
        };
        
        if (editingCursoId) {
            db.collection('cursos').doc(editingCursoId).update(data).then(() => {
                showToast('Curso actualizado');
                closeModal('modal-curso');
            }).catch(e => {
                console.error(e);
                showToast('Error al actualizar', 'error');
            });
        } else {
            db.collection('cursos').add(data).then(() => {
                showToast('Curso añadido');
                closeModal('modal-curso');
            }).catch(e => {
                console.error(e);
                showToast('Error al guardar', 'error');
            });
        }
    }
    
    function deleteCurso() {
        if (!confirm('¿Eliminar este curso?')) return;
        
        db.collection('cursos').doc(editingCursoId).delete().then(() => {
            showToast('Curso eliminado');
            closeModal('modal-curso');
        }).catch(e => {
            console.error(e);
            showToast('Error al eliminar', 'error');
        });
    }
    
    // ==================== MY CURSOS (WORKER) ====================
    
    function loadMyCursos() {
        currentSection = 'mycursos';
        setActiveMenu('menu-cursos');
        document.getElementById('header-title').textContent = 'Mis Cursos';
        document.getElementById('fab').style.display = 'none';
        renderMyCursos();
    }
    
    function renderMyCursos() {
        const main = document.getElementById('main-content');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const myCursos = allCursos.filter(c => c.dni === currentUser.dni);
        
        let vigentes = 0, porVencer = 0, vencidos = 0;
        myCursos.forEach(c => {
            const days = Math.ceil((c.vencDate - today) / (1000 * 60 * 60 * 24));
            if (days > 90) vigentes++;
            else if (days > 0) porVencer++;
            else vencidos++;
        });
        
        let html = `
            <div class="dashboard-grid">
                <div class="dash-card success">
                    <i class="fas fa-check-circle"></i>
                    <div class="number">${vigentes}</div>
                    <div class="label">Vigentes</div>
                </div>
                <div class="dash-card warning">
                    <i class="fas fa-clock"></i>
                    <div class="number">${porVencer}</div>
                    <div class="label">Por Vencer</div>
                </div>
                <div class="dash-card urgent">
                    <i class="fas fa-times-circle"></i>
                    <div class="number">${vencidos}</div>
                    <div class="label">Vencidos</div>
                </div>
                <div class="dash-card primary">
                    <i class="fas fa-graduation-cap"></i>
                    <div class="number">${myCursos.length}</div>
                    <div class="label">Total</div>
                </div>
            </div>
        `;
        
        if (myCursos.length === 0) {
            html += `<div class="empty-state"><i class="fas fa-graduation-cap"></i><p>No tienes cursos registrados</p></div>`;
        } else {
            html += `<div class="course-grid">`;
            myCursos.sort((a, b) => a.vencDate - b.vencDate).forEach(c => {
                const days = Math.ceil((c.vencDate - today) / (1000 * 60 * 60 * 24));
                let cardClass = '';
                let daysClass = 'ok';
                let daysText = `Vence en ${days} días`;
                
                if (days <= 0) {
                    cardClass = 'expired';
                    daysClass = 'danger';
                    daysText = days === 0 ? 'Vence HOY' : `Venció hace ${Math.abs(days)} días`;
                } else if (days <= 90) {
                    cardClass = 'expiring';
                    daysClass = 'warning';
                }
                
                html += `
                    <div class="course-card ${cardClass}">
                        <h4><i class="fas fa-certificate"></i> ${c.curso}</h4>
                        <div class="days ${daysClass}">${days > 0 ? days : Math.abs(days)}</div>
                        <div class="legend">${daysText}</div>
                        <div style="font-size:12px;color:var(--text-light);margin-top:8px;">${formatDate(c.vencDate)}</div>
                    </div>
                `;
            });
            html += `</div>`;
        }
        
        main.innerHTML = html;
    }
    
    // ==================== INIT ====================
    
    window.onload = function() {
        // Always start with login
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
        
        // DNI input listeners
        const dniInput = document.getElementById('dni-input');
        dniInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        dniInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            if (location.protocol === 'http:' || location.protocol === 'https:') {
            navigator.serviceWorker.register('./sw.js').catch(e => console.log('SW error:', e));
        }
}
        
        // Firebase Auth
        firebase.auth().signInAnonymously().catch(e => console.error('Auth:', e));
        
        // Online/Offline
        window.addEventListener('online', () => {
            document.getElementById('offline-banner').classList.remove('show');
            document.body.classList.remove('offline');
            showToast('Conexión restaurada');
        });
        window.addEventListener('offline', () => {
            document.getElementById('offline-banner').classList.add('show');
            document.body.classList.add('offline');
            showToast('Sin conexión', 'warning');
        });
    };
    </script>
</body>
</html>
