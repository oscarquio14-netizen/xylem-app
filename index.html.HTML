<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00A0B0">
    <title>App Xylem Trabajos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Paleta de colores: principal #00A0B0, acentos #4CAF50 verde, #FFB300 ámbar, #FF4444 rojo */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #ffffff;
            color: #333333;
            overflow: hidden;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #00A0B0;
            color: #ffffff;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .hamburger {
            font-size: 30px;
            cursor: pointer;
            margin-right: 20px;
        }
        .header-title {
            font-size: 1.4em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 998;
        }
        .overlay.active {
            display: block;
        }
        .drawer {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: #00A0B0;
            color: #ffffff;
            padding: 80px 20px 20px;
            transition: left 0.3s ease;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 999;
            overflow-y: auto;
        }
        .drawer.open {
            left: 0;
        }
        .drawer h2 {
            color: #4CAF50;
            font-size: 1.2em;
            margin-bottom: 10px;
            margin-top: 20px;
        }
        .drawer ul {
            list-style: none;
            padding: 0;
        }
        .drawer li {
            margin-bottom: 15px;
        }
        .drawer button {
            background: none;
            border: none;
            color: #ffffff;
            text-align: left;
            cursor: pointer;
            font-size: 1em;
            padding: 10px;
            width: 100%;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .drawer button:hover, .drawer button.active {
            background-color: #00838f;
        }
        .main-content {
            margin-top: 60px;
            padding: 20px;
            width: 100%;
            height: calc(100% - 60px);
            overflow-y: auto;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .tabs {
            display: flex;
            width: 90%;
            max-width: 1200px;
            background-color: #f9f9f9;
            border-bottom: 2px solid #00A0B0;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background-color: #e0e0e0;
            flex: 1;
            text-align: center;
            font-weight: bold;
        }
        .tab.active {
            background-color: #00A0B0;
            color: white;
        }
        .tab-content {
            display: none;
            width: 90%;
            max-width: 1200px;
        }
        .tab-content.active {
            display: block;
        }
        .section-content {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
        }
        .report-box {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #00A0B0;
            padding: 15px;
            margin-top: 20px;
            background-color: #ffffff;
            border-radius: 8px;
        }
        .observations-box {
            max-height: 800px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #00A0B0;
            padding: 15px;
            margin-top: 40px;
            background-color: #ffffff;
            border-radius: 8px;
        }
        .observation-history {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        table tr:hover {
            background-color: #e0f7fa;
        }
        th, td {
            border: 1px solid #00A0B0;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #00A0B0;
            color: #ffffff;
        }
        th:nth-child(4), td:nth-child(4) {
            text-align: center;
        }
        th:nth-child(6), td:nth-child(6) {
            text-align: center;
            width: 300px;
        }
        input[type="text"], input[type="number"], textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 5px;
        }
        button.save-report, button.add-observation {
            background-color: #00A0B0;
            color: #ffffff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }
        button.save-report:hover, button.add-observation:hover {
            background-color: #00838f;
        }
        button.add-row {
            background-color: #00A0B0;
            color: #ffffff;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
        }
        button.add-row:hover {
            background-color: #4CAF50;
        }
        input[type="date"] {
            margin-bottom: 10px;
            padding: 8px;
            width: calc(100% - 16px);
            box-sizing: border-box;
        }
        button.edit {
            background-color: #00838f;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button.delete-row {
            background-color: #ff0000;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button.save-row {
            background-color: #4caf50;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button.cancel-row {
            background-color: #9e9e9e;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button.toggle-history {
            background-color: #00838f;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button.delete-obs {
            background-color: #ff0000;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }
        button.edit-obs {
            background-color: #00838f;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }
        button.update-progress {
            background-color: #00838f;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }
        progress {
            accent-color: #00A0B0;
            width: 100px;
        }
        .history-row td {
            background-color: #e0f7fa;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #f9f9f9;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .close {
            color: #00838f;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #00A0B0;
            text-decoration: none;
            cursor: pointer;
        }
        .modal label {
            display: block;
            margin-top: 10px;
        }
        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }
        .modal button {
            background-color: #00A0B0;
            color: #ffffff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }
        .modal button:hover {
            background-color: #00838f;
        }
        .chart-wrapper {
            width: 150px;
            height: 150px;
            margin: 10px auto;
        }
        .actions-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            justify-content: flex-start;
        }
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }
        .card {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 180px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .card h4 {
            margin: 0 0 15px 0;
            color: #00A0B0;
        }
        .card .big-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #00A0B0;
        }
        .card.red .big-number {
            color: #ff4444;
        }
        .matrix-table-wrapper {
            overflow-x: auto;
            border: 1px solid #00A0B0;
            border-radius: 8px;
            background-color: #ffffff;
        }
        .matrix-table th, .matrix-table td {
            min-width: 120px;
            padding: 12px;
            text-align: center;
            border: 1px solid #00A0B0;
        }
        .matrix-table th {
            background-color: #00A0B0;
            color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .fixed-column {
            position: sticky;
            left: 0;
            background-color: #f9f9f9;
            z-index: 1;
            font-weight: bold;
        }
        .matrix-table th.fixed-column {
            background-color: #00A0B0;
            color: #ffffff;
            z-index: 3;
        }
        .cell-green {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        .cell-orange {
            background-color: #ffb300;
            color: black;
            cursor: pointer;
        }
        .cell-red {
            background-color: #ff4444;
            color: white;
            cursor: pointer;
        }
        .cell-gray {
            background-color: #cccccc;
            color: black;
            cursor: pointer;
        }
        .cell-critical-zero {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        .cell-critical-positive {
            background-color: #ff4444;
            color: white;
            font-weight: bold;
        }
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .priority-alta {
            background-color: #FF4444;
            color: white;
        }
        .priority-media {
            background-color: #FFB300;
            color: black;
        }
        .priority-baja {
            background-color: #4CAF50;
            color: white;
        }
        .state-completada {
            background-color: #4CAF50;
            color: white;
        }
        .state-en-progreso {
            background-color: #00A0B0;
            color: white;
        }
        .state-pendiente {
            background-color: #FFB300;
            color: black;
        }
        .progress-container {
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            height: 30px;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            line-height: 30px;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        .overdue {
            background-color: #ffcccc !important;
            font-weight: bold;
        }
        .critical-row {
            border-left: 5px solid #FF4444;
        }
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin: 20px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .big-icon {
            font-size: 3em;
        }
        .priority-radios {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        .priority-radios label {
            cursor: pointer;
            margin: 0;
        }
        .kanban-board {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 20px 0;
        }
        .kanban-column {
            flex: 1;
            min-width: 300px;
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 15px;
        }
        .kanban-column h3 {
            text-align: center;
            margin: 0 0 15px 0;
            color: #00A0B0;
            font-size: 1.3em;
        }
        .kanban-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .kanban-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .kanban-card h5 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: #333;
        }
        .kanban-card .actions-cell {
            margin-top: 10px;
            justify-content: center;
        }
        @media (max-width: 768px) {
            .drawer {
                width: 80%;
                left: -100%;
            }
            .drawer.open {
                left: 0;
            }
            .tabs {
                width: 100%;
            }
            .tab-content {
                width: 100%;
            }
            .header-title {
                font-size: 1.2em;
            }
            .chart-wrapper {
                width: 120px;
                height: 120px;
            }
            .hamburger {
                font-size: 40px;
            }
            .actions-cell {
                flex-direction: row;
                justify-content: center;
            }
            .priority-radios {
                justify-content: center;
            }
        }
        @media (max-width: 600px) {
            .tabs {
                flex-direction: column;
            }
            .tab {
                flex: none;
            }
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            .toolbar > * {
                width: 100%;
            }
            .toolbar > div {
                margin-left: 0 !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="hamburger" onclick="toggleDrawer()">☰</div>
        <div class="header-title" id="header-title">App Xylem Trabajos</div>
    </div>

    <div class="overlay" onclick="toggleDrawer()"></div>

    <div class="drawer" id="drawer">
        <h2>SUPERVISIÓN</h2>
        <ul>
            <li><button id="btn-seguridad" onclick="selectSection('seguridad')">Seguridad</button></li>
            <li><button id="btn-gestion_operativa" onclick="selectSection('gestion_operativa')">Gestión Operativa</button></li>
        </ul>
        <h2>OPERACIONES</h2>
        <ul>
            <li><button id="btn-pozos" onclick="selectSection('pozos')">Pozos</button></li>
            <li><button id="btn-pozas" onclick="selectSection('pozas')">Pozas</button></li>
            <li><button id="btn-well_point" onclick="selectSection('well_point')">Well Point</button></li>
            <li><button id="btn-taller_pb1_mecanica_electrica" onclick="selectSection('taller_pb1_mecanica_electrica')">Taller PB1 - Mecánica/Eléctrica</button></li>
            <li><button id="btn-taller_pb1_instrumentacion" onclick="selectSection('taller_pb1_instrumentacion')">Taller PB1 - Instrumentación</button></li>
        </ul>
        <h2>GENERAL</h2>
        <ul>
            <li><button id="btn-pendientes_supervision" onclick="selectPendientesSupervision()">Seguimiento de Pendientes (Supervisión)</button></li>
            <li><button id="btn-pendientes_operaciones" onclick="selectPendientesOperaciones()">Seguimiento de Pendientes (Operaciones)</button></li>
        </ul>
    </div>

    <div class="main-content">
        <h1 id="section-title">Seguimiento de Tareas</h1>

        <div class="tabs">
            <div class="tab active" id="tab-report" onclick="switchTab('report')">Reporte Diario</div>
            <div class="tab" id="tab-obs" onclick="switchTab('obs')">Observaciones</div>
            <div class="tab" id="tab-cursos" onclick="switchTab('cursos')">Seguimiento de Cursos</div>
        </div>

        <div id="tab-content-report" class="tab-content active section-content"></div>
        <div id="tab-content-obs" class="tab-content section-content"></div>
        <div id="tab-content-cursos" class="tab-content section-content"></div>
    </div>

    <!-- Modal para añadir/editar observación -->
    <div id="add-obs-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-title">Añadir Observación</h3>
            <label for="obs-sector">Sector:</label>
            <select id="obs-sector"></select>
            <label for="obs-desc">Descripción:</label>
            <textarea id="obs-desc" rows="4"></textarea>
            <label for="obs-esp">Especialidad:</label>
            <input type="text" id="obs-esp" list="esp-datalist">
            <datalist id="esp-datalist"></datalist>
            <label>Prioridad:</label>
            <div class="priority-radios">
                <input type="radio" name="obs-prioridad" value="Alta" id="obs-pri-alta">
                <label for="obs-pri-alta" class="badge priority-alta">Alta</label>
                <input type="radio" name="obs-prioridad" value="Media" id="obs-pri-media">
                <label for="obs-pri-media" class="badge priority-media">Media</label>
                <input type="radio" name="obs-prioridad" value="Baja" id="obs-pri-baja">
                <label for="obs-pri-baja" class="badge priority-baja">Baja</label>
            </div>
            <label for="obs-date">Fecha de inicio:</label>
            <input type="date" id="obs-date">
            <label for="obs-progress">% Avance inicial:</label>
            <input type="number" id="obs-progress" value="0" min="0" max="100">
            <button id="save-obs">Guardar</button>
        </div>
    </div>

    <!-- Modal para seleccionar usuario al actualizar observación -->
    <div id="update-user-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('update-user-modal').style.display='none'">&times;</span>
            <h3>¿Quién realiza esta actualización?</h3>
            <select id="update-user-select">
                <option value="Francisco Ramos">Francisco Ramos</option>
                <option value="Juan Vidal">Juan Vidal</option>
                <option value="William Flores">William Flores</option>
                <option value="Cesar Turpo">Cesar Turpo</option>
                <option value="Otro">Otro...</option>
            </select>
            <input type="text" id="update-user-custom" placeholder="Nombre personalizado" style="display:none; margin-top:10px;">
            <button onclick="confirmUpdateUser()">Continuar</button>
        </div>
    </div>

    <!-- Modal para añadir/editar curso -->
    <div id="add-curso-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="curso-modal-title">Añadir Curso</h3>
            <label for="curso-personal">Personal:</label>
            <input type="text" id="curso-personal">
            <label for="curso-nombre">Curso:</label>
            <input type="text" id="curso-nombre">
            <label for="curso-venc">Fecha de Vencimiento:</label>
            <input type="date" id="curso-venc">
            <button id="save-curso">Guardar</button>
            <button id="delete-curso" style="display:none; background-color:#ff0000; margin-left:10px;">Eliminar</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyhP0Ak3ziNrGTCFHKlFr7-_HAMimYX_g",
            authDomain: "trabajos---xylem.firebaseapp.com",
            projectId: "trabajos---xylem",
            storageBucket: "trabajos---xylem.firebasestorage.app",
            messagingSenderId: "719564556454",
            appId: "1:719564556454:web:22e10612163f79d4b5cc67",
            measurementId: "G-M4QXHB30W2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        db.enablePersistence()
          .catch((err) => {
              if (err.code === 'failed-precondition') {
                  console.warn('Persistence failed: multiple tabs open');
              } else if (err.code === 'unimplemented') {
                  console.warn('Persistence not supported in this browser');
              }
          });

        const sections = {
            'seguridad': 'Seguridad',
            'gestion_operativa': 'Gestión Operativa',
            'pozos': 'Pozos',
            'pozas': 'Pozas',
            'well_point': 'Well Point',
            'taller_pb1_mecanica_electrica': 'Taller PB1 - Mecánica/Eléctrica',
            'taller_pb1_instrumentacion': 'Taller PB1 - Instrumentación'
        };

        const supervisionSections = ['seguridad', 'gestion_operativa'];
        const operacionesSections = ['pozos', 'pozas', 'well_point', 'taller_pb1_mecanica_electrica', 'taller_pb1_instrumentacion'];

        let currentSection = null;
        let currentGroup = null;
        let isPendientesGroup = false;
        let selectedDate = null;
        let activities = [];
        let currentTab = 'report';
        let pendingUpdate = null;
        let editingObsId = null;
        let editingCursoId = null;
        let currentCharts = [];

        let currentObsData = [];
        let currentFiltered = [];
        let currentPage = 1;
        const pageSize = 15;
        let currentView = 'table';
        let allEspecialidades = [];

        function destroyCharts() {
            currentCharts.forEach(chart => chart && chart.destroy());
            currentCharts = [];
        }

        // Modal setup
        const modal = document.getElementById('add-obs-modal');
        const cursoModal = document.getElementById('add-curso-modal');
        const span = modal.getElementsByClassName("close")[0];
        const cursoClose = cursoModal.getElementsByClassName("close")[0];
        span.onclick = function() {
            modal.style.display = "none";
        }
        cursoClose.onclick = function() {
            cursoModal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
            if (event.target == document.getElementById('update-user-modal')) {
                document.getElementById('update-user-modal').style.display = "none";
            }
            if (event.target == cursoModal) {
                cursoModal.style.display = "none";
            }
        }

        document.getElementById('update-user-select').onchange = function() {
            const custom = document.getElementById('update-user-custom');
            custom.style.display = this.value === 'Otro' ? 'block' : 'none';
        };

        function confirmUpdateUser() {
            let user = document.getElementById('update-user-select').value;
            if (user === 'Otro') {
                user = document.getElementById('update-user-custom').value.trim();
                if (!user) return alert('Ingresa un nombre');
            }
            if (pendingUpdate) {
                performUpdateObservation(pendingUpdate.obsId, pendingUpdate.newProgress, pendingUpdate.action, user);
            }
            document.getElementById('update-user-modal').style.display = "none";
        }

        function populateObsSectorSelect() {
            const select = document.getElementById('obs-sector');
            select.innerHTML = '';
            const allowedSections = currentGroup === 'supervision' ? supervisionSections : operacionesSections;
            allowedSections.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = sections[key];
                select.appendChild(option);
            });
            if (currentSection) {
                select.value = currentSection;
                select.disabled = true;
            } else {
                select.disabled = false;
                select.value = allowedSections[0];
            }
        }

        function populateEspDatalist(current = '') {
            const datalist = document.getElementById('esp-datalist');
            if (!datalist) return;
            datalist.innerHTML = '';
            let esps = [...allEspecialidades];
            if (current && !esps.includes(current)) esps.push(current);
            esps.sort();
            esps.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e;
                datalist.appendChild(opt);
            });
        }

        function openAddObsModal() {
            editingObsId = null;
            document.getElementById('modal-title').innerText = "Añadir Observación";
            populateObsSectorSelect();
            document.getElementById('obs-desc').value = '';
            document.getElementById('obs-esp').value = '';
            document.getElementById('obs-pri-media').checked = true;
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('obs-date').value = todayStr;
            document.getElementById('obs-progress').value = 0;
            populateEspDatalist();
            modal.style.display = "block";
        }

        async function openEditObsModal(obsId) {
            editingObsId = obsId;
            document.getElementById('modal-title').innerText = "Editar Observación";
            const doc = await db.collection('observaciones').doc(obsId).get();
            if (doc.exists) {
                const data = doc.data();
                populateObsSectorSelect();
                document.getElementById('obs-sector').value = data.section;
                document.getElementById('obs-sector').disabled = !!currentSection;
                document.getElementById('obs-desc').value = data.description || '';
                document.getElementById('obs-esp').value = data.especialidad || '';
                const priLower = (data.prioridad || 'Media').toLowerCase();
                document.getElementById(`obs-pri-${priLower}`).checked = true;
                document.getElementById('obs-date').value = data.startDate ? data.startDate.toDate().toISOString().split('T')[0] : '';
                document.getElementById('obs-progress').value = data.progress || 0;
                populateEspDatalist(data.especialidad || '');
                modal.style.display = "block";
            }
        }

        async function saveObservation() {
            const sector = document.getElementById('obs-sector').value;
            const desc = document.getElementById('obs-desc').value.trim();
            const esp = document.getElementById('obs-esp').value.trim();
            const prioridadRadio = document.querySelector('input[name="obs-prioridad"]:checked');
            if (!prioridadRadio) return alert('Selecciona una prioridad');
            const prioridad = prioridadRadio.value;
            const dateStr = document.getElementById('obs-date').value;
            const progress = parseInt(document.getElementById('obs-progress').value);

            if (!sector || !desc || !esp || !prioridad || !dateStr || isNaN(progress)) {
                return alert('Completa todos los campos obligatorios: Sector, Descripción, Especialidad, Prioridad, Fecha de inicio y % Avance');
            }

            const startDate = firebase.firestore.Timestamp.fromDate(new Date(dateStr));

            const data = {
                section: sector,
                description: desc,
                especialidad: esp,
                prioridad: prioridad,
                startDate: startDate,
                progress: progress
            };

            let obsId = editingObsId;

            try {
                if (editingObsId) {
                    await db.collection('observaciones').doc(editingObsId).update(data);
                    obsId = editingObsId;
                } else {
                    data.history = [];
                    const docRef = await db.collection('observaciones').add(data);
                    obsId = docRef.id;
                }

                alert(editingObsId ? 'Observación editada correctamente' : 'Observación añadida correctamente');
                modal.style.display = "none";
                destroyCharts();
                if (isPendientesGroup) {
                    loadPendientesGroup(currentGroup);
                } else {
                    loadObservations(currentSection);
                }
            } catch (error) {
                console.error(error);
                alert('Error al guardar la observación');
            }
        }

        document.getElementById('save-obs').onclick = saveObservation;

        function openAddCursoModal() {
            editingCursoId = null;
            document.getElementById('curso-modal-title').innerText = "Añadir Curso";
            document.getElementById('curso-personal').value = '';
            document.getElementById('curso-nombre').value = '';
            document.getElementById('curso-venc').value = '';
            document.getElementById('delete-curso').style.display = 'none';
            cursoModal.style.display = "block";
        }

        function openEditCursoModal(id) {
            editingCursoId = id;
            document.getElementById('curso-modal-title').innerText = "Editar Curso";
            db.collection('cursos').doc(id).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('curso-personal').value = data.personal || '';
                    document.getElementById('curso-nombre').value = data.curso || '';
                    document.getElementById('curso-venc').value = data.vencimiento ? data.vencimiento.toDate().toISOString().split('T')[0] : '';
                    document.getElementById('delete-curso').style.display = 'block';
                    cursoModal.style.display = "block";
                }
            }).catch(error => console.error(error));
        }

        function deleteCurrentCurso() {
            if (!editingCursoId) return;
            if (confirm('¿Estás seguro de eliminar este curso?')) {
                db.collection('cursos').doc(editingCursoId).delete()
                    .then(() => {
                        alert('Curso eliminado correctamente');
                        cursoModal.style.display = "none";
                        editingCursoId = null;
                        destroyCharts();
                        loadCursos();
                    }).catch(error => console.error(error));
            }
        }

        function saveCurso() {
            const personal = document.getElementById('curso-personal').value.trim();
            const curso = document.getElementById('curso-nombre').value.trim();
            const dateStr = document.getElementById('curso-venc').value;

            if (!personal || !curso || !dateStr) {
                return alert('Completa todos los campos');
            }

            const vencDate = new Date(dateStr);
            const vencTimestamp = firebase.firestore.Timestamp.fromDate(vencDate);

            const data = {
                section: 'seguridad',
                personal: personal,
                curso: curso,
                vencimiento: vencTimestamp
            };

            if (editingCursoId) {
                db.collection('cursos').doc(editingCursoId).update(data)
                    .then(() => {
                        alert('Curso actualizado correctamente');
                        cursoModal.style.display = "none";
                        destroyCharts();
                        loadCursos();
                    }).catch(error => console.error(error));
            } else {
                db.collection('cursos').add(data)
                    .then(() => {
                        alert('Curso añadido correctamente');
                        cursoModal.style.display = "none";
                        destroyCharts();
                        loadCursos();
                    }).catch(error => console.error(error));
            }
        }

        document.getElementById('save-curso').onclick = saveCurso;
        document.getElementById('delete-curso').onclick = deleteCurrentCurso;

        function toggleDrawer() {
            document.getElementById('drawer').classList.toggle('open');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function clearActiveButtons() {
            const buttonIds = ['seguridad', 'gestion_operativa', 'pozos', 'pozas', 'well_point', 'taller_pb1_mecanica_electrica', 'taller_pb1_instrumentacion', 'pendientes_supervision', 'pendientes_operaciones'];
            buttonIds.forEach(id => {
                const btn = document.getElementById(`btn-${id}`);
                if (btn) btn.classList.remove('active');
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-report').classList.toggle('active', tab === 'report');
            document.getElementById('tab-obs').classList.toggle('active', tab === 'obs');
            document.getElementById('tab-cursos').classList.toggle('active', tab === 'cursos');
            document.getElementById('tab-content-report').classList.toggle('active', tab === 'report');
            document.getElementById('tab-content-obs').classList.toggle('active', tab === 'obs');
            document.getElementById('tab-content-cursos').classList.toggle('active', tab === 'cursos');

            if (tab === 'obs') {
                destroyCharts();
                if (isPendientesGroup) {
                    loadPendientesGroup(currentGroup);
                } else if (currentSection) {
                    loadObservations(currentSection);
                }
            } else if (tab === 'cursos') {
                destroyCharts();
                loadCursos();
            }
        }

        function selectSection(sectionKey) {
            toggleDrawer();
            clearActiveButtons();
            document.getElementById(`btn-${sectionKey}`).classList.add('active');

            currentSection = sectionKey;
            currentGroup = supervisionSections.includes(sectionKey) ? 'supervision' : 'operaciones';
            isPendientesGroup = false;
            document.getElementById('section-title').innerText = `Seguimiento de ${sections[sectionKey]}`;
            document.getElementById('header-title').innerText = sections[sectionKey];

            const isSupervision = supervisionSections.includes(sectionKey);
            document.getElementById('tab-report').style.display = isSupervision ? 'none' : 'block';
            document.getElementById('tab-cursos').style.display = (sectionKey === 'seguridad') ? 'block' : 'none';

            loadSectionContent(sectionKey);

            if (sectionKey !== 'seguridad' && currentTab === 'cursos') {
                switchTab(isSupervision ? 'obs' : 'report');
            }

            if (isSupervision) {
                switchTab('obs');
            } else {
                switchTab('report');
            }

            if (currentTab === 'obs') {
                destroyCharts();
                loadObservations(sectionKey);
            } else if (currentTab === 'cursos') {
                destroyCharts();
                loadCursos();
            }
        }

        function selectPendientesSupervision() {
            toggleDrawer();
            clearActiveButtons();
            document.getElementById('btn-pendientes_supervision').classList.add('active');

            currentSection = null;
            currentGroup = 'supervision';
            isPendientesGroup = true;
            document.getElementById('section-title').innerText = 'Seguimiento de Pendientes (Supervisión)';
            document.getElementById('header-title').innerText = 'Pendientes Supervisión';

            document.getElementById('tab-report').style.display = 'none';
            document.getElementById('tab-cursos').style.display = 'none';
            switchTab('obs');

            const obsContent = document.getElementById('tab-content-obs');
            obsContent.innerHTML = `
                <h2>Observaciones y Pendientes</h2>
                <div id="observations-box-group" class="observations-box"></div>
            `;
            loadPendientesGroup('supervision');

            destroyCharts();
        }

        function selectPendientesOperaciones() {
            toggleDrawer();
            clearActiveButtons();
            document.getElementById('btn-pendientes_operaciones').classList.add('active');

            currentSection = null;
            currentGroup = 'operaciones';
            isPendientesGroup = true;
            document.getElementById('section-title').innerText = 'Seguimiento de Pendientes (Operaciones)';
            document.getElementById('header-title').innerText = 'Pendientes Operaciones';

            document.getElementById('tab-report').style.display = 'none';
            document.getElementById('tab-cursos').style.display = 'none';
            switchTab('obs');

            const obsContent = document.getElementById('tab-content-obs');
            obsContent.innerHTML = `
                <h2>Observaciones y Pendientes</h2>
                <div id="observations-box-group" class="observations-box"></div>
            `;
            loadPendientesGroup('operaciones');

            destroyCharts();
        }

        function loadSectionContent(sectionKey) {
            const isSupervision = supervisionSections.includes(sectionKey);

            const reportContent = document.getElementById('tab-content-report');
            if (!isSupervision) {
                reportContent.innerHTML = `
                    <label for="date-${sectionKey}">Seleccionar Fecha para Reporte Diario:</label>
                    <input type="date" id="date-${sectionKey}" onchange="loadReport('${sectionKey}', this.value)">
                    <div id="report-box-${sectionKey}" class="report-box"><h3>Reporte de Trabajo Diario</h3></div>
                `;
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const formattedYesterday = yesterday.toISOString().split('T')[0];
                document.getElementById(`date-${sectionKey}`).value = formattedYesterday;
                selectedDate = formattedYesterday;
                loadReport(sectionKey, formattedYesterday);
            } else {
                reportContent.innerHTML = '';
            }

            const obsContent = document.getElementById('tab-content-obs');
            obsContent.innerHTML = `
                <h2>Observaciones y Pendientes</h2>
                <div id="observations-box-${sectionKey}" class="observations-box"></div>
            `;
        }

        function loadReport(section, dateStr) {
            selectedDate = dateStr;
            const reportBox = document.getElementById(`report-box-${section}`);
            if (!dateStr) {
                reportBox.innerHTML = '<h3>Reporte de Trabajo Diario</h3><p>Seleccione una fecha para ver o editar el reporte.</p>';
                activities = [];
                return;
            }

            const reportId = `${section}_${dateStr.replace(/-/g, '')}`;
            db.collection('reportes').doc(reportId).get()
                .then(doc => {
                    activities = doc.exists ? doc.data().activities || [] : [];
                    renderDailyReportTable(reportBox);
                }).catch(error => console.error(error));
        }

        function renderDailyReportTable(reportBox) {
            let tableHTML = `
                <h3>Reporte de Trabajo Diario</h3>
                <table id="report-table">
                    <thead>
                        <tr>
                            <th>Actividad</th>
                            <th>% Avance</th>
                            <th>Especialidad</th>
                            <th>Comentario</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="report-tbody">
            `;

            activities.forEach((act, index) => {
                if (act.locked) {
                    tableHTML += `
                        <tr>
                            <td>${act.actividad || ''}</td>
                            <td><progress value="${act.avance || 0}" max="100"></progress> ${act.avance || 0}%</td>
                            <td>${act.especialidad || ''}</td>
                            <td>${act.comentario || ''}</td>
                            <td class="actions-cell">
                                <button class="edit" title="Modificar" onclick="editRow(${index})"><i class="fas fa-edit"></i></button>
                                <button class="delete-row" title="Borrar" onclick="deleteRow(${index})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                } else {
                    tableHTML += `
                        <tr id="row-${index}">
                            <td><input type="text" value="${act.actividad || ''}" id="act-${index}"></td>
                            <td><input type="number" min="0" max="100" value="${act.avance || 0}" id="av-${index}"></td>
                            <td><input type="text" value="${act.especialidad || ''}" id="esp-${index}"></td>
                            <td><input type="text" value="${act.comentario || ''}" id="com-${index}"></td>
                            <td class="actions-cell">
                                <button class="save-row" title="Guardar" onclick="saveRow(${index})"><i class="fas fa-check"></i></button>
                                <button class="cancel-row" title="Cancelar" onclick="cancelRow(${index})"><i class="fas fa-times"></i></button>
                            </td>
                        </tr>
                    `;
                }
            });

            tableHTML += `
                    </tbody>
                </table>
                <div style="margin-top: 15px;">
                    <button class="add-row" onclick="addDailyRow()"><i class="fas fa-plus"></i> Añadir Fila</button>
                    <button class="save-report" onclick="saveDailyReport()"><i class="fas fa-save"></i> Guardar Reporte</button>
                </div>
            `;

            reportBox.innerHTML = tableHTML;
        }

        function addDailyRow() {
            if (!selectedDate) return alert('Seleccione una fecha primero');
            activities.push({actividad: '', avance: 0, comentario: '', especialidad: '', locked: false});
            const reportBox = document.getElementById(`report-box-${currentSection}`);
            renderDailyReportTable(reportBox);
        }

        function editRow(index) {
            activities[index].locked = false;
            const reportBox = document.getElementById(`report-box-${currentSection}`);
            renderDailyReportTable(reportBox);
        }

        function deleteRow(index) {
            if (confirm('¿Estás seguro de que quieres borrar esta actividad?')) {
                activities.splice(index, 1);
                const reportBox = document.getElementById(`report-box-${currentSection}`);
                renderDailyReportTable(reportBox);
            }
        }

        function saveRow(index) {
            const act = {
                actividad: document.getElementById(`act-${index}`).value.trim(),
                avance: parseInt(document.getElementById(`av-${index}`).value),
                especialidad: document.getElementById(`esp-${index}`).value.trim(),
                comentario: document.getElementById(`com-${index}`).value.trim(),
                locked: true
            };
            if (act.actividad === '' || isNaN(act.avance) || act.avance < 0 || act.avance > 100 || act.especialidad === '') {
                alert('Por favor, completa Actividad, % Avance (entre 0 y 100) y Especialidad.');
                return;
            }
            activities[index] = act;
            const reportBox = document.getElementById(`report-box-${currentSection}`);
            renderDailyReportTable(reportBox);
        }

        function cancelRow(index) {
            if (activities[index].actividad.trim() === '' && activities[index].especialidad.trim() === '') {
                activities.splice(index, 1);
            } else {
                activities[index].locked = true;
            }
            const reportBox = document.getElementById(`report-box-${currentSection}`);
            renderDailyReportTable(reportBox);
        }

        function saveDailyReport() {
            if (!selectedDate) return alert('Seleccione una fecha primero');
            if (activities.some(act => !act.locked)) {
                return alert('Por favor, guarda o cancela todas las ediciones pendientes antes de guardar el reporte.');
            }

            const reportId = `${currentSection}_${selectedDate.replace(/-/g, '')}`;
            const reportData = {
                section: currentSection,
                date: selectedDate,
                activities: activities
            };

            db.collection('reportes').doc(reportId).set(reportData)
                .then(() => {
                    alert('Reporte diario guardado exitosamente');
                    loadReport(currentSection, selectedDate);
                })
                .catch(error => {
                    console.error('Error guardando reporte:', error);
                });
        }

        function toggleUpdate(id) {
            const row = document.getElementById(`update-row-${id}`);
            row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
        }

        function toggleHistory(id) {
            const row = document.getElementById(`history-row-${id}`);
            row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
        }

        function toggleView() {
            currentView = currentView === 'table' ? 'kanban' : 'table';
            const btn = document.querySelector('#toggle-view-btn');
            if (btn) btn.innerText = currentView === 'table' ? 'Vista Kanban' : 'Vista Tabla';
            renderCurrentView();
        }

        function renderCurrentView() {
            const tableWrapper = document.getElementById('obs-table-wrapper');
            const kanbanBoard = document.getElementById('kanban-board');
            if (tableWrapper) tableWrapper.style.display = currentView === 'table' ? 'block' : 'none';
            if (kanbanBoard) kanbanBoard.style.display = currentView === 'kanban' ? 'flex' : 'none';
            if (currentView === 'table') {
                renderObsTable(currentFiltered, isPendientesGroup ? 'observations-box-group' : `observations-box-${currentSection}`, isPendientesGroup);
            } else {
                renderKanban(currentFiltered, isPendientesGroup);
            }
        }

        function renderObsTable(data, boxId, isGroup = false) {
            const tableWrapper = document.getElementById('obs-table-wrapper') || document.querySelector(`#${boxId} .matrix-table-wrapper`);
            const tbody = tableWrapper.querySelector('tbody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = data.slice(start, end);

            const today = new Date();
            today.setHours(0,0,0,0);

            pageData.forEach(o => {
                const lastUpdate = o.history && o.history.length > 0 ? o.history[o.history.length - 1] : null;
                const lastUpdateDateStr = lastUpdate && lastUpdate.timestamp
                    ? new Date(lastUpdate.timestamp.seconds * 1000).toLocaleDateString('es-ES')
                    : 'Sin actualizaciones';
                const lastUpdateStr = lastUpdate
                    ? `${lastUpdateDateStr} - ${lastUpdate.user} - ${lastUpdate.action} (${lastUpdate.progressChange > 0 ? '+' : ''}${lastUpdate.progressChange}%)`
                    : 'Sin actualizaciones';

                const tr = document.createElement('tr');

                let rowHTML = isGroup ? `<td>${o.sectorName}</td>` : '';
                rowHTML += `
                    <td title="${o.description}">${o.description.length > 100 ? o.description.substring(0,100) + '...' : o.description}</td>
                    <td>${o.especialidad || ''}</td>
                    <td><span class="badge priority-${(o.prioridad || 'media').toLowerCase()}">${o.prioridad || 'Media'}</span></td>
                    <td>${o.startFormatted}</td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${o.progress}%; background-color: ${o.colorBar};">${o.progress}%</div>
                        </div>
                    </td>
                    <td><span class="badge state-${o.estado.toLowerCase().replace(' ', '-')}">${o.estado}</span></td>
                    <td>${lastUpdateStr}</td>
                    <td class="actions-cell">
                        <button class="edit-obs" onclick="openEditObsModal('${o.id}')"><i class="fas fa-edit"></i></button>
                        <button class="update-progress" onclick="toggleUpdate('${o.id}')"><i class="fas fa-sync"></i></button>
                        <button class="toggle-history" onclick="toggleHistory('${o.id}')"><i class="fas fa-history"></i></button>
                        <button class="delete-obs" onclick="deleteObservation('${o.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tr.innerHTML = rowHTML;
                tbody.appendChild(tr);

                // Update row
                const updateTr = document.createElement('tr');
                updateTr.id = `update-row-${o.id}`;
                updateTr.style.display = 'none';
                updateTr.innerHTML = `<td colspan="${isGroup ? '9' : '8'}">
                    <div style="padding:15px; background:#f9f9f9; border-radius:8px;">
                        <label>Nuevo % Avance:</label>
                        <input type="number" id="new-progress-${o.id}" value="${o.progress}" min="0" max="100" style="width:100px;">
                        <label>Acción realizada:</label>
                        <textarea id="new-action-${o.id}" rows="2" style="width:100%;"></textarea>
                        <div style="margin-top:10px;">
                            <button class="save-row" onclick="prepareUpdateObservation('${o.id}')">Guardar Actualización</button>
                            <button class="cancel-row" onclick="toggleUpdate('${o.id}')">Cancelar</button>
                        </div>
                    </div>
                </td>`;
                tbody.appendChild(updateTr);

                // History row
                const historyTr = document.createElement('tr');
                historyTr.id = `history-row-${o.id}`;
                historyTr.className = 'history-row';
                historyTr.style.display = 'none';
                historyTr.innerHTML = `
                    <td colspan="${isGroup ? '9' : '8'}">
                        <div class="observation-history">
                            <h5>Historial Completo</h5>
                            ${(o.history || []).map(log => {
                                if (!log.timestamp || !log.timestamp.seconds) return '<p>Dato corrupto</p>';
                                const fullDate = new Date(log.timestamp.seconds * 1000).toLocaleString('es-ES');
                                return `<p>${fullDate} - <strong>${log.user || 'Desconocido'}</strong>: ${log.action || ''} (${log.progressChange > 0 ? '+' : ''}${log.progressChange || 0}%)</p>`;
                            }).join('') || '<p>Sin historial</p>'}
                        </div>
                    </td>
                `;
                tbody.appendChild(historyTr);
            });

            // Pagination
            const totalPages = Math.ceil(data.length / pageSize);
            const pagination = document.getElementById('pagination-controls');
            if (totalPages <= 1 || currentView !== 'table') {
                if (pagination) pagination.style.display = 'none';
            } else {
                if (pagination) {
                    pagination.style.display = 'block';
                    pagination.innerHTML = `
                        <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button>
                        <span>Página ${currentPage} de ${totalPages}</span>
                        <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>Siguiente</button>
                    `;
                }
            }
        }

        function renderKanban(data, isGroup = false) {
            const kanbanBoard = document.getElementById('kanban-board');
            if (!kanbanBoard) return;
            kanbanBoard.innerHTML = '';

            const columns = {
                'Pendiente': [],
                'En Progreso': [],
                'Completada': []
            };

            data.forEach(o => {
                columns[o.estado].push(o);
            });

            Object.keys(columns).forEach(state => {
                const col = document.createElement('div');
                col.className = 'kanban-column';
                col.innerHTML = `<h3>${state} (${columns[state].length})</h3><div class="kanban-cards"></div>`;
                const cardsDiv = col.querySelector('.kanban-cards');

                columns[state].forEach(o => {
                    const card = document.createElement('div');
                    card.className = 'kanban-card';
                    let cardHTML = isGroup ? `<p><strong>Sector:</strong> ${o.sectorName}</p>` : '';
                    cardHTML += `
                        <h5 title="${o.description}">${o.description.length > 80 ? o.description.substring(0,80) + '...' : o.description}</h5>
                        <p><strong>Especialidad:</strong> ${o.especialidad || ''}</p>
                        <span class="badge priority-${(o.prioridad || 'media').toLowerCase()}">${o.prioridad || 'Media'}</span>
                        <p><strong>Fecha Inicio:</strong> ${o.startFormatted}</p>
                        <div class="progress-container" style="margin:10px 0;">
                            <div class="progress-bar" style="width: ${o.progress}%; background-color: ${o.colorBar};">${o.progress}%</div>
                        </div>
                        <div class="actions-cell">
                            <button class="edit-obs" onclick="openEditObsModal('${o.id}')"><i class="fas fa-edit"></i></button>
                            <button class="update-progress" onclick="toggleUpdate('${o.id}')"><i class="fas fa-sync"></i></button>
                            <button class="toggle-history" onclick="toggleHistory('${o.id}')"><i class="fas fa-history"></i></button>
                            <button class="delete-obs" onclick="deleteObservation('${o.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    card.innerHTML = cardHTML;
                    cardsDiv.appendChild(card);
                });

                kanbanBoard.appendChild(col);
            });
        }

        function loadObservations(section) {
            const obsBox = document.getElementById(`observations-box-${section}`);
            if (!obsBox) return;

            obsBox.innerHTML = `
                <div class="dashboard" id="dashboard-${section}"></div>
                <div class="toolbar">
                    <button class="add-observation" style="font-size:1.2em; padding:10px 20px;" onclick="openAddObsModal()">Añadir Observación</button>
                    <input type="text" id="search-obs-${section}" placeholder="Buscar en descripción..." style="padding:8px; flex:1; min-width:200px;">
                    <select id="filter-especialidad-${section}"><option value="">Todas Especialidades</option></select>
                    <select id="filter-prioridad-${section}">
                        <option value="">Todas Prioridades</option>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Baja">Baja</option>
                    </select>
                    <select id="filter-estado-${section}">
                        <option value="">Todos Estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Completada">Completada</option>
                    </select>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <label style="margin:0; white-space:nowrap;">Desde:</label>
                        <input type="date" id="filter-from-${section}">
                        <label style="margin:0; white-space:nowrap;">Hasta:</label>
                        <input type="date" id="filter-to-${section}">
                    </div>
                    <div style="margin-left:auto;">
                        <button id="toggle-view-btn" onclick="toggleView()">Vista Kanban</button>
                    </div>
                </div>
                <div id="obs-table-wrapper" class="matrix-table-wrapper">
                    <table class="obs-table">
                        <thead>
                            <tr>
                                <th>Observación</th>
                                <th>Especialidad</th>
                                <th>Prioridad</th>
                                <th>Fecha Inicio</th>
                                <th>% Avance</th>
                                <th>Estado</th>
                                <th>Última Actualización</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="kanban-board" class="kanban-board" style="display:none;"></div>
                <div id="pagination-controls" style="margin-top:20px; text-align:center;"></div>
            `;

            db.collection('observaciones')
                .where('section', '==', section)
                .orderBy('startDate', 'desc')
                .get()
                .then(snapshot => {
                    let obsData = [];
                    let totalProgress = 0;
                    const today = new Date();
                    today.setHours(0,0,0,0);

                    allEspecialidades = [];

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const progress = data.progress || 0;
                        totalProgress += progress;
                        const estado = progress === 100 ? 'Completada' : progress > 0 ? 'En Progreso' : 'Pendiente';
                        const colorBar = progress === 100 ? '#4CAF50' : '#00A0B0';

                        obsData.push({
                            id: doc.id,
                            sectorName: sections[data.section] || data.section,
                            description: data.description || '',
                            especialidad: data.especialidad || '',
                            prioridad: data.prioridad || 'Media',
                            startDate: data.startDate,
                            startFormatted: data.startDate ? data.startDate.toDate().toLocaleDateString('es-ES') : 'N/A',
                            progress: progress,
                            estado: estado,
                            colorBar: colorBar,
                            history: data.history || []
                        });

                        if (data.especialidad) allEspecialidades.push(data.especialidad);
                    });

                    allEspecialidades = [...new Set(allEspecialidades)].sort();

                    const total = obsData.length;
                    const completadas = obsData.filter(o => o.estado === 'Completada').length;
                    const enProgreso = obsData.filter(o => o.estado === 'En Progreso').length;
                    const pendientes = obsData.filter(o => o.estado === 'Pendiente').length;
                    const avgProgress = total > 0 ? Math.round(totalProgress / total) : 0;

                    const dashboard = document.getElementById(`dashboard-${section}`);
                    dashboard.innerHTML = `
                        <div class="card">
                            <i class="fas fa-list big-icon" style="color:#00A0B0"></i>
                            <h4>Total Observaciones</h4>
                            <div class="big-number" style="color:#00A0B0">${total}</div>
                        </div>
                        <div class="card">
                            <i class="fas fa-clock big-icon" style="color:#FFB300"></i>
                            <h4>Pendientes</h4>
                            <div class="big-number" style="color:#FFB300">${pendientes}</div>
                        </div>
                        <div class="card">
                            <i class="fas fa-cogs big-icon" style="color:#00A0B0"></i>
                            <h4>En Progreso</h4>
                            <div class="big-number" style="color:#00A0B0">${enProgreso}</div>
                        </div>
                        <div class="card">
                            <i class="fas fa-check-circle big-icon" style="color:#4CAF50"></i>
                            <h4>Completadas</h4>
                            <div class="big-number" style="color:#4CAF50">${completadas}</div>
                        </div>
                        <div class="card">
                            <h4>% Cumplimiento General</h4>
                            <div class="chart-wrapper">
                                <canvas id="chart-compliance-${section}"></canvas>
                            </div>
                            <div class="big-number" style="color:#00A0B0">${avgProgress}%</div>
                        </div>
                        <div class="card">
                            <i class="fas fa-exclamation-triangle big-icon" style="color:#FF4444"></i>
                            <h4>Críticas/Vencidas</h4>
                            <div class="big-number" style="color:#FF4444">0</div>
                        </div>
                    `;

                    const chart = new Chart(document.getElementById(`chart-compliance-${section}`), {
                        type: 'doughnut',
                        data: {
                            labels: ['Completado', 'Pendiente'],
                            datasets: [{
                                data: [avgProgress, 100 - avgProgress],
                                backgroundColor: ['#4CAF50', '#FF4444'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' },
                                title: { display: false }
                            }
                        }
                    });
                    currentCharts.push(chart);

                    const especialidades = [...new Set(obsData.map(o => o.especialidad).filter(Boolean))].sort();
                    const espSelect = document.getElementById(`filter-especialidad-${section}`);
                    especialidades.forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = e;
                        opt.textContent = e;
                        espSelect.appendChild(opt);
                    });

                    document.getElementById(`search-obs-${section}`).oninput = () => filterObservations(section);
                    document.getElementById(`filter-especialidad-${section}`).onchange = () => filterObservations(section);
                    document.getElementById(`filter-prioridad-${section}`).onchange = () => filterObservations(section);
                    document.getElementById(`filter-estado-${section}`).onchange = () => filterObservations(section);
                    document.getElementById(`filter-from-${section}`).onchange = () => filterObservations(section);
                    document.getElementById(`filter-to-${section}`).onchange = () => filterObservations(section);

                    currentObsData = obsData;
                    currentFiltered = obsData;
                    currentPage = 1;
                    currentView = 'table';
                    document.getElementById('toggle-view-btn').innerText = 'Vista Kanban';
                    renderCurrentView();
                }).catch(error => console.error(error));
        }

        function loadPendientesGroup(group) {
            const obsBox = document.getElementById('observations-box-group');
            if (!obsBox) return;

            obsBox.innerHTML = `
                <div class="dashboard" id="dashboard-group"></div>
                <div class="toolbar">
                    <button class="add-observation" style="font-size:1.2em; padding:10px 20px;" onclick="openAddObsModal()">Añadir Observación</button>
                    <input type="text" id="search-obs-group" placeholder="Buscar en descripción..." style="padding:8px; flex:1; min-width:200px;">
                    <select id="filter-especialidad-group"><option value="">Todas Especialidades</option></select>
                    <select id="filter-prioridad-group">
                        <option value="">Todas Prioridades</option>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Baja">Baja</option>
                    </select>
                    <select id="filter-estado-group">
                        <option value="">Todos Estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Completada">Completada</option>
                    </select>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <label style="margin:0; white-space:nowrap;">Desde:</label>
                        <input type="date" id="filter-from-group">
                        <label style="margin:0; white-space:nowrap;">Hasta:</label>
                        <input type="date" id="filter-to-group">
                    </div>
                    <div style="margin-left:auto;">
                        <button id="toggle-view-btn" onclick="toggleView()">Vista Kanban</button>
                    </div>
                </div>
                <div id="obs-table-wrapper" class="matrix-table-wrapper">
                    <table class="obs-table">
                        <thead>
                            <tr>
                                <th>Sector</th>
                                <th>Observación</th>
                                <th>Especialidad</th>
                                <th>Prioridad</th>
                                <th>Fecha Inicio</th>
                                <th>% Avance</th>
                                <th>Estado</th>
                                <th>Última Actualización</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="kanban-board" class="kanban-board" style="display:none;"></div>
                <div id="pagination-controls" style="margin-top:20px; text-align:center;"></div>
            `;

            const allowedSections = group === 'supervision' ? supervisionSections : operacionesSections;

            db.collection('observaciones')
                .where('section', 'in', allowedSections)
                .orderBy('startDate', 'desc')
                .get()
                .then(snapshot => {
                    let obsData = [];
                    let totalProgress = 0;
                    const today = new Date();
                    today.setHours(0,0,0,0);

                    allEspecialidades = [];

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const progress = data.progress || 0;
                        totalProgress += progress;
                        const estado = progress === 100 ? 'Completada' : progress > 0 ? 'En Progreso' : 'Pendiente';
                        const colorBar = progress === 100 ? '#4CAF50' : '#00A0B0';

                        obsData.push({
                            id: doc.id,
                            sectorName: sections[data.section] || data.section,
                            description: data.description || '',
                            especialidad: data.especialidad || '',
                            prioridad: data.prioridad || 'Media',
                            startDate: data.startDate,
                            startFormatted: data.startDate ? data.startDate.toDate().toLocaleDateString('es-ES') : 'N/A',
                            progress: progress,
                            estado: estado,
                            colorBar: colorBar,
                            history: data.history || []
                        });

                        if (data.especialidad) allEspecialidades.push(data.especialidad);
                    });

                    allEspecialidades = [...new Set(allEspecialidades)].sort();

                    const total = obsData.length;
                    const completadas = obsData.filter(o => o.estado === 'Completada').length;
                    const enProgreso = obsData.filter(o => o.estado === 'En Progreso').length;
                    const pendientes = obsData.filter(o => o.estado === 'Pendiente').length;
                    const avgProgress = total > 0 ? Math.round(totalProgress / total) : 0;

                    const dashboard = document.getElementById('dashboard-group');
                    dashboard.innerHTML = `
                        <div class="card">
                            <i class="fas fa-list big-icon" style="color:#00A0B0"></i>
                            <h4>Total Observaciones</h4>
                            <div class="big-number" style="color:#00A0B0">${total}</div>
                        </div>
                        <div class="card">
                            <i class="fas fa-clock big-icon" style="color:#FFB300"></i>
                            <h4>Pendientes</h4>
                            <div class="big-number" style="color:#FFB300">${pendientes}</div>
                        </div>
                        <div class="card">
                            <i class="fas fa-cogs big-icon" style="color:#00A0B0"></i>
                            <h4>En Progreso</h4>
                            <div class="big-number" style="color:#00A0B0">${enProgreso}</div>
                        </div>
                        <div class="card">
                            <i class="fas fa-check-circle big-icon" style="color:#4CAF50"></i>
                            <h4>Completadas</h4>
                            <div class="big-number" style="color:#4CAF50">${completadas}</div>
                        </div>
                        <div class="card">
                            <h4>% Cumplimiento General</h4>
                            <div class="chart-wrapper">
                                <canvas id="chart-compliance-group"></canvas>
                            </div>
                            <div class="big-number" style="color:#00A0B0">${avgProgress}%</div>
                        </div>
                        <div class="card">
                            <i class="fas fa-exclamation-triangle big-icon" style="color:#FF4444"></i>
                            <h4>Críticas/Vencidas</h4>
                            <div class="big-number" style="color:#FF4444">0</div>
                        </div>
                    `;

                    const chart = new Chart(document.getElementById('chart-compliance-group'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Completado', 'Pendiente'],
                            datasets: [{
                                data: [avgProgress, 100 - avgProgress],
                                backgroundColor: ['#4CAF50', '#FF4444'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' },
                                title: { display: false }
                            }
                        }
                    });
                    currentCharts.push(chart);

                    const especialidades = [...new Set(obsData.map(o => o.especialidad).filter(Boolean))].sort();
                    const espSelect = document.getElementById('filter-especialidad-group');
                    especialidades.forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = e;
                        opt.textContent = e;
                        espSelect.appendChild(opt);
                    });

                    document.getElementById('search-obs-group').oninput = () => filterObservations('group');
                    document.getElementById('filter-especialidad-group').onchange = () => filterObservations('group');
                    document.getElementById('filter-prioridad-group').onchange = () => filterObservations('group');
                    document.getElementById('filter-estado-group').onchange = () => filterObservations('group');
                    document.getElementById('filter-from-group').onchange = () => filterObservations('group');
                    document.getElementById('filter-to-group').onchange = () => filterObservations('group');

                    currentObsData = obsData;
                    currentFiltered = obsData;
                    currentPage = 1;
                    currentView = 'table';
                    document.getElementById('toggle-view-btn').innerText = 'Vista Kanban';
                    renderCurrentView();
                }).catch(error => console.error(error));
        }

        function filterObservations(idSuffix) {
            let filtered = currentObsData;

            const search = document.getElementById(`search-obs-${idSuffix}`).value.toLowerCase();
            if (search) {
                filtered = filtered.filter(o => o.description.toLowerCase().includes(search));
            }

            const esp = document.getElementById(`filter-especialidad-${idSuffix}`).value;
            if (esp) filtered = filtered.filter(o => o.especialidad === esp);

            const pri = document.getElementById(`filter-prioridad-${idSuffix}`).value;
            if (pri) filtered = filtered.filter(o => o.prioridad === pri);

            const est = document.getElementById(`filter-estado-${idSuffix}`).value;
            if (est) filtered = filtered.filter(o => o.estado === est);

            const from = document.getElementById(`filter-from-${idSuffix}`).value;
            if (from) {
                const fromDate = new Date(from);
                filtered = filtered.filter(o => o.startDate.toDate() >= fromDate);
            }

            const to = document.getElementById(`filter-to-${idSuffix}`).value;
            if (to) {
                const toDate = new Date(to);
                toDate.setHours(23,59,59,999);
                filtered = filtered.filter(o => o.startDate.toDate() <= toDate);
            }

            currentFiltered = filtered;
            currentPage = 1;
            renderCurrentView();
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            const totalPages = Math.ceil(currentFiltered.length / pageSize);
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderCurrentView();
            }
        }

        function deleteObservation(obsId) {
            if (confirm('¿Estás seguro de que deseas eliminar esta observación completa? Esta acción no se puede deshacer.')) {
                db.collection('observaciones').doc(obsId).delete()
                    .then(() => {
                        alert('Observación eliminada');
                        destroyCharts();
                        if (isPendientesGroup) {
                            loadPendientesGroup(currentGroup);
                        } else if (currentSection) {
                            loadObservations(currentSection);
                        }
                    })
                    .catch(error => console.error(error));
            }
        }

        function prepareUpdateObservation(obsId) {
            const newProgressEl = document.getElementById(`new-progress-${obsId}`);
            const actionEl = document.getElementById(`new-action-${obsId}`);
            if (!newProgressEl || !actionEl) return;

            const newProgress = parseInt(newProgressEl.value);
            const action = actionEl.value.trim();

            if (isNaN(newProgress) || newProgress < 0 || newProgress > 100 || !action) {
                return alert('Ingresa un % válido (0-100) y describe la acción realizada.');
            }

            pendingUpdate = { obsId, newProgress, action };
            document.getElementById('update-user-modal').style.display = "block";
        }

        function performUpdateObservation(obsId, newProgress, action, user) {
            db.collection('observaciones').doc(obsId).get().then(doc => {
                if (!doc.exists) {
                    alert('Observación no encontrada');
                    return;
                }
                const currentProgress = doc.data().progress || 0;
                const progressChange = newProgress - currentProgress;
                const log = {
                    user: user,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    action: action,
                    progressChange: progressChange
                };
                db.collection('observaciones').doc(obsId).update({
                    progress: newProgress,
                    history: firebase.firestore.FieldValue.arrayUnion(log)
                })
                .then(() => {
                    alert('Observación actualizada correctamente');
                    destroyCharts();
                    if (isPendientesGroup) {
                        loadPendientesGroup(currentGroup);
                    } else {
                        loadObservations(currentSection);
                    }
                })
                .catch(error => {
                    console.error('Error actualizando observación:', error);
                });
            }).catch(error => {
                console.error(error);
            });
        }

        function loadCursos() {
            const cursosContent = document.getElementById('tab-content-cursos');
            cursosContent.innerHTML = `
                <h3>Seguimiento de Cursos de Seguridad</h3>
                <button class="add-observation" onclick="openAddCursoModal()">Añadir Curso</button>
                <div class="dashboard">
                    <div class="card chart-card">
                        <h4>Distribución de Cursos</h4>
                        <canvas id="cursos-chart"></canvas>
                    </div>
                    <div class="card">
                        <h3>Total Personal</h3>
                        <div class="big-number" id="total-personal">0</div>
                    </div>
                    <div class="card">
                        <h3>Cursos Registrados</h3>
                        <div class="big-number" id="total-cursos">0</div>
                    </div>
                    <div class="card" id="card-criticos-personas">
                        <h3>Personas con Cursos Críticos</h3>
                        <div class="big-number" id="personas-criticos">0</div>
                    </div>
                    <div class="card">
                        <h3>Total Cursos Vencidos</h3>
                        <div class="big-number" id="total-vencidos">0</div>
                    </div>
                </div>
                <div class="matrix-table-wrapper">
                    <table class="matrix-table">
                        <thead id="matrix-thead"></thead>
                        <tbody id="matrix-tbody"></tbody>
                    </table>
                </div>
            `;

            db.collection('cursos')
                .where('section', '==', 'seguridad')
                .get()
                .then(snapshot => {
                    const cursosData = [];
                    snapshot.forEach(doc => {
                        cursosData.push({ id: doc.id, ...doc.data() });
                    });

                    const uniquePersons = [...new Set(cursosData.map(c => c.personal))].sort();
                    const uniqueCursos = [...new Set(cursosData.map(c => c.curso))].sort();

                    const matrix = {};
                    uniquePersons.forEach(p => {
                        matrix[p] = {};
                        uniqueCursos.forEach(c => matrix[p][c] = null);
                    });

                    let vigentes = 0;
                    let porVencer = 0;
                    let vencidos = 0;
                    let totalVencidos = 0;
                    const personasCriticos = new Set();

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    cursosData.forEach(item => {
                        const personal = item.personal;
                        const curso = item.curso;
                        const vencDate = item.vencimiento.toDate();
                        vencDate.setHours(0, 0, 0, 0);
                        const diffDays = Math.ceil((vencDate - today) / (1000 * 60 * 60 * 24));

                        matrix[personal][curso] = {
                            days: diffDays,
                            date: vencDate,
                            id: item.id
                        };

                        if (diffDays > 90) {
                            vigentes++;
                        } else if (diffDays > 0 && diffDays <= 90) {
                            porVencer++;
                            personasCriticos.add(personal);
                        } else {
                            vencidos++;
                            totalVencidos++;
                            personasCriticos.add(personal);
                        }

                        if (diffDays <= 90) {
                            personasCriticos.add(personal);
                        }
                    });

                    document.getElementById('total-personal').innerText = uniquePersons.length;
                    document.getElementById('total-cursos').innerText = cursosData.length;
                    document.getElementById('personas-criticos').innerText = personasCriticos.size;
                    document.getElementById('total-vencidos').innerText = vencidos;

                    if (personasCriticos.size > 0) {
                        document.getElementById('card-criticos-personas').classList.add('red');
                    }

                    const chartCtx = document.getElementById('cursos-chart');
                    const chart = new Chart(chartCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Vigentes (>90 días)', 'Por Vencer (≤90 días)', 'Vencidos'],
                            datasets: [{
                                data: [vigentes, porVencer, vencidos],
                                backgroundColor: ['#00A0B0', '#ffb300', '#ff4444']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                    currentCharts.push(chart);

                    const personCriticals = {};
                    uniquePersons.forEach(p => {
                        let count = 0;
                        uniqueCursos.forEach(c => {
                            const cell = matrix[p][c];
                            if (cell && cell.days <= 90) count++;
                        });
                        personCriticals[p] = count;
                    });

                    uniquePersons.sort((a, b) => personCriticals[b] - personCriticals[a]);

                    const thead = document.getElementById('matrix-thead');
                    let headerHTML = '<tr><th class="fixed-column">Personal</th>';
                    uniqueCursos.forEach(c => {
                        headerHTML += `<th>${c}</th>`;
                    });
                    headerHTML += '<th>Críticos</th></tr>';
                    thead.innerHTML = headerHTML;

                    const tbody = document.getElementById('matrix-tbody');
                    tbody.innerHTML = '';
                    uniquePersons.forEach(p => {
                        const tr = document.createElement('tr');
                        const tdPersonal = document.createElement('td');
                        tdPersonal.className = 'fixed-column';
                        tdPersonal.textContent = p;
                        tr.appendChild(tdPersonal);

                        uniqueCursos.forEach(c => {
                            const td = document.createElement('td');
                            const cellData = matrix[p][c];

                            if (!cellData) {
                                td.textContent = 'NO REQUIERE';
                                td.className = 'cell-gray';
                                td.onclick = () => {
                                    editingCursoId = null;
                                    document.getElementById('curso-personal').value = p;
                                    document.getElementById('curso-nombre').value = c;
                                    document.getElementById('curso-venc').value = '';
                                    document.getElementById('delete-curso').style.display = 'none';
                                    cursoModal.style.display = "block";
                                };
                            } else {
                                let daysText = '';
                                if (cellData.days > 0) {
                                    daysText = `${cellData.days} días`;
                                } else if (cellData.days === 0) {
                                    daysText = 'Vence hoy';
                                } else {
                                    daysText = `Vencido hace ${-cellData.days} días`;
                                }
                                const formattedDate = cellData.date.toLocaleDateString('es-ES');
                                td.innerHTML = `<strong>${daysText}</strong><br><small>${formattedDate}</small>`;

                                if (cellData.days > 90) {
                                    td.className = 'cell-green';
                                } else if (cellData.days > 0 && cellData.days <= 90) {
                                    td.className = 'cell-orange';
                                } else {
                                    td.className = 'cell-red';
                                }

                                td.onclick = () => openEditCursoModal(cellData.id);
                            }
                            tr.appendChild(td);
                        });

                        const critTd = document.createElement('td');
                        const critCount = personCriticals[p];
                        critTd.textContent = critCount;
                        critTd.className = critCount > 0 ? 'cell-critical-positive' : 'cell-critical-zero';
                        tr.appendChild(critTd);

                        tbody.appendChild(tr);
                    });
                })
                .catch(error => console.error(error));
        }

        window.onload = () => {
            selectSection('pozos');
        };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registrado con éxito:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('Error al registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>