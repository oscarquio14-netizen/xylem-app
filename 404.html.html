<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f26322">
    <title>App Xylem Trabajos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Paleta de colores: #005461, #018790, #00B7B5, #F4F4F4 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #005461;
            overflow: hidden;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #005461;
            color: #ffffff;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .hamburger {
            font-size: 30px;
            cursor: pointer;
            margin-right: 20px;
        }
        .header-title {
            font-size: 1.4em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 998;
        }
        .overlay.active {
            display: block;
        }
        .drawer {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: #005461;
            color: #ffffff;
            padding: 80px 20px 20px;
            transition: left 0.3s ease;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 999;
            overflow-y: auto;
        }
        .drawer.open {
            left: 0;
        }
        .drawer h2 {
            color: #00B7B5;
            font-size: 1.2em;
            margin-bottom: 10px;
            margin-top: 20px;
        }
        .drawer ul {
            list-style: none;
            padding: 0;
        }
        .drawer li {
            margin-bottom: 15px;
        }
        .drawer button {
            background: none;
            border: none;
            color: #ffffff;
            text-align: left;
            cursor: pointer;
            font-size: 1em;
            padding: 10px;
            width: 100%;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .drawer button:hover, .drawer button.active {
            background-color: #00B7B5;
        }
        .main-content {
            margin-top: 60px;
            padding: 20px;
            width: 100%;
            height: calc(100% - 60px);
            overflow-y: auto;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .tabs {
            display: flex;
            width: 90%;
            max-width: 1200px;
            background-color: #F4F4F4;
            border-bottom: 2px solid #005461;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background-color: #e0e0e0;
            flex: 1;
            text-align: center;
            font-weight: bold;
        }
        .tab.active {
            background-color: #00B7B5;
            color: white;
        }
        .tab-content {
            display: none;
            width: 90%;
            max-width: 1200px;
        }
        .tab-content.active {
            display: block;
        }
        .section-content {
            background-color: #F4F4F4;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
        }
        .report-box {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #005461;
            padding: 15px;
            margin-top: 20px;
            background-color: #ffffff;
            border-radius: 8px;
        }
        .observations-box {
            max-height: 800px;
            overflow-y: auto;
            border: 1px solid #005461;
            padding: 15px;
            margin-top: 40px;
            background-color: #ffffff;
            border-radius: 8px;
        }
        .observation-history {
            margin-top: 10px;
            padding: 10px;
            background-color: #F4F4F4;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table tr:nth-child(even) {
            background-color: #F4F4F4;
        }
        table tr:hover {
            background-color: #e0f7fa;
        }
        th, td {
            border: 1px solid #018790;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #005461;
            color: #ffffff;
        }
        th:nth-child(4), td:nth-child(4) {
            text-align: center;
        }
        th:nth-child(6), td:nth-child(6) {
            text-align: center;
            width: 300px;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            box-sizing: border-box;
            padding: 5px;
        }
        button.save-report, button.add-observation {
            background-color: #00B7B5;
            color: #ffffff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }
        button.save-report:hover, button.add-observation:hover {
            background-color: #018790;
        }
        button.add-row {
            background-color: #005461;
            color: #ffffff;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
        }
        button.add-row:hover {
            background-color: #00B7B5;
        }
        input[type="date"] {
            margin-bottom: 10px;
            padding: 8px;
            width: calc(100% - 16px);
            box-sizing: border-box;
        }
        button.edit {
            background-color: #018790;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button.delete-row {
            background-color: #ff0000;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button.save-row {
            background-color: #4caf50;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button.cancel-row {
            background-color: #9e9e9e;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button.toggle-history {
            background-color: #018790;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button.delete-obs {
            background-color: #ff0000;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }
        button.edit-obs {
            background-color: #018790;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }
        progress {
            accent-color: #00B7B5;
            width: 100px;
        }
        .history-row td {
            background-color: #e0f7fa;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #F4F4F4;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .close {
            color: #018790;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #005461;
            text-decoration: none;
            cursor: pointer;
        }
        .modal label {
            display: block;
            margin-top: 10px;
        }
        .modal input, .modal select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }
        .modal button {
            background-color: #00B7B5;
            color: #ffffff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }
        .modal button:hover {
            background-color: #018790;
        }
        .chart-wrapper {
            width: 300px;
            text-align: center;
            margin-bottom: 30px;
        }
        @media (max-width: 768px) {
            .drawer {
                width: 80%;
                left: -100%;
            }
            .drawer.open {
                left: 0;
            }
            .tabs {
                width: 100%;
            }
            .tab-content {
                width: 100%;
            }
            .header-title {
                font-size: 1.2em;
            }
            .chart-wrapper {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="hamburger" onclick="toggleDrawer()">☰</div>
        <div class="header-title" id="header-title">App Xylem Trabajos</div>
    </div>

    <div class="overlay" onclick="toggleDrawer()"></div>

    <div class="drawer" id="drawer">
        <h2>SUPERVISIÓN</h2>
        <ul>
            <li><button id="btn-seguridad" onclick="selectSection('seguridad')">Seguridad</button></li>
            <li><button id="btn-gestion_operativa" onclick="selectSection('gestion_operativa')">Gestión Operativa</button></li>
        </ul>
        <h2>OPERACIONES</h2>
        <ul>
            <li><button id="btn-pozos" onclick="selectSection('pozos')">Pozos</button></li>
            <li><button id="btn-pozas" onclick="selectSection('pozas')">Pozas</button></li>
            <li><button id="btn-well_point" onclick="selectSection('well_point')">Well Point</button></li>
            <li><button id="btn-taller_pb1_mecanica_electrica" onclick="selectSection('taller_pb1_mecanica_electrica')">Taller PB1 - Mecánica/Eléctrica</button></li>
            <li><button id="btn-taller_pb1_instrumentacion" onclick="selectSection('taller_pb1_instrumentacion')">Taller PB1 - Instrumentación</button></li>
        </ul>
        <h2>GENERAL</h2>
        <ul>
            <li><button id="btn-todos_pendientes" onclick="selectAllPendings()">Seguimiento de Pendientes (Todos)</button></li>
        </ul>
    </div>

    <div class="main-content">
        <h1 id="section-title">Seguimiento de Tareas</h1>

        <div class="tabs">
            <div class="tab active" id="tab-report" onclick="switchTab('report')">Reporte Diario</div>
            <div class="tab" id="tab-obs" onclick="switchTab('obs')">Observaciones</div>
        </div>

        <div id="tab-content-report" class="tab-content active section-content"></div>
        <div id="tab-content-obs" class="tab-content section-content"></div>
    </div>

    <!-- Modal para añadir/editar observación -->
    <div id="add-obs-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-title">Añadir Observación</h3>
            <label for="obs-sector">Sector:</label>
            <select id="obs-sector">
                <option value="seguridad">Seguridad</option>
                <option value="gestion_operativa">Gestión Operativa</option>
                <option value="pozos">Pozos</option>
                <option value="pozas">Pozas</option>
                <option value="well_point">Well Point</option>
                <option value="taller_pb1_mecanica_electrica">Taller PB1 - Mecánica/Eléctrica</option>
                <option value="taller_pb1_instrumentacion">Taller PB1 - Instrumentación</option>
            </select>
            <label for="obs-desc">Observación:</label>
            <input type="text" id="obs-desc">
            <label for="obs-esp">Especialidad:</label>
            <input type="text" id="obs-esp">
            <label for="obs-date">Fecha de inicio:</label>
            <input type="date" id="obs-date">
            <label for="obs-progress">% Avance inicial:</label>
            <input type="number" id="obs-progress" value="0" min="0" max="100">
            <button id="save-obs">Guardar</button>
        </div>
    </div>

    <!-- Modal para seleccionar usuario al actualizar observación -->
    <div id="update-user-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('update-user-modal').style.display='none'">&times;</span>
            <h3>¿Quién realiza esta actualización?</h3>
            <select id="update-user-select">
                <option value="Francisco Ramos">Francisco Ramos</option>
                <option value="Juan Vidal">Juan Vidal</option>
                <option value="William Flores">William Flores</option>
                <option value="Cesar Turpo">Cesar Turpo</option>
                <option value="Otro">Otro...</option>
            </select>
            <input type="text" id="update-user-custom" placeholder="Nombre personalizado" style="display:none; margin-top:10px;">
            <button onclick="confirmUpdateUser()">Continuar</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyhP0Ak3ziNrGTCFHKlFr7-_HAMimYX_g",
            authDomain: "trabajos---xylem.firebaseapp.com",
            projectId: "trabajos---xylem",
            storageBucket: "trabajos---xylem.firebasestorage.app",
            messagingSenderId: "719564556454",
            appId: "1:719564556454:web:22e10612163f79d4b5cc67",
            measurementId: "G-M4QXHB30W2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const sections = {
            'seguridad': 'Seguridad',
            'gestion_operativa': 'Gestión Operativa',
            'pozos': 'Pozos',
            'pozas': 'Pozas',
            'well_point': 'Well Point',
            'taller_pb1_mecanica_electrica': 'Taller PB1 - Mecánica/Eléctrica',
            'taller_pb1_instrumentacion': 'Taller PB1 - Instrumentación',
            'todos_pendientes': 'Seguimiento de Pendientes (Todos)'
        };

        let currentSection = null;
        let selectedDate = null;
        let activities = [];
        let currentTab = 'report';
        let pendingUpdate = null;
        let isAllPendings = false;
        let editingObsId = null;
        let currentCharts = [];

        function destroyCharts() {
            currentCharts.forEach(chart => chart && chart.destroy());
            currentCharts = [];
        }

        // Modal setup
        const modal = document.getElementById('add-obs-modal');
        const span = modal.getElementsByClassName("close")[0];
        span.onclick = function() {
            modal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
            if (event.target == document.getElementById('update-user-modal')) {
                document.getElementById('update-user-modal').style.display = "none";
            }
        }

        document.getElementById('update-user-select').onchange = function() {
            const custom = document.getElementById('update-user-custom');
            custom.style.display = this.value === 'Otro' ? 'block' : 'none';
        };

        function confirmUpdateUser() {
            let user = document.getElementById('update-user-select').value;
            if (user === 'Otro') {
                user = document.getElementById('update-user-custom').value.trim();
                if (!user) return alert('Ingresa un nombre');
            }
            if (pendingUpdate) {
                performUpdateObservation(pendingUpdate.obsId, pendingUpdate.section, pendingUpdate.newProgress, pendingUpdate.action, user);
            }
            document.getElementById('update-user-modal').style.display = "none";
        }

        function openAddObsModal() {
            editingObsId = null;
            document.getElementById('modal-title').innerText = "Añadir Observación";
            modal.style.display = "block";
            document.getElementById('obs-desc').value = '';
            document.getElementById('obs-esp').value = '';
            document.getElementById('obs-date').value = '';
            document.getElementById('obs-progress').value = 0;
            if (!isAllPendings && currentSection) {
                document.getElementById('obs-sector').value = currentSection;
            }
        }

        function openEditObsModal(obsId, section) {
            editingObsId = obsId;
            document.getElementById('modal-title').innerText = "Editar Observación";
            db.collection('observaciones').doc(obsId).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('obs-sector').value = data.section;
                    document.getElementById('obs-desc').value = data.description;
                    document.getElementById('obs-esp').value = data.especialidad || '';
                    document.getElementById('obs-date').value = data.startDate ? data.startDate.toDate().toISOString().split('T')[0] : '';
                    document.getElementById('obs-progress').value = data.progress || 0;
                    modal.style.display = "block";
                }
            }).catch(error => console.error(error));
        }

        function saveObservation() {
            const sector = document.getElementById('obs-sector').value;
            const desc = document.getElementById('obs-desc').value.trim();
            const esp = document.getElementById('obs-esp').value.trim();
            const dateStr = document.getElementById('obs-date').value;
            const progress = parseInt(document.getElementById('obs-progress').value);

            if (!sector || !desc || !esp || !dateStr || isNaN(progress)) {
                return alert('Completa todos los campos correctamente');
            }

            const startDate = new Date(dateStr);
            const startTimestamp = firebase.firestore.Timestamp.fromDate(startDate);

            const data = {
                section: sector,
                startDate: startTimestamp,
                description: desc,
                especialidad: esp,
                progress: progress
            };

            if (editingObsId) {
                db.collection('observaciones').doc(editingObsId).update(data)
                    .then(() => {
                        alert('Observación editada correctamente');
                        modal.style.display = "none";
                        destroyCharts();
                        if (isAllPendings) loadAllPendings();
                        else loadObservations(sector);
                    }).catch(error => console.error(error));
            } else {
                data.history = [];
                db.collection('observaciones').add(data)
                    .then(() => {
                        alert('Observación añadida correctamente');
                        modal.style.display = "none";
                        destroyCharts();
                        if (isAllPendings) loadAllPendings();
                        else loadObservations(sector);
                    }).catch(error => console.error(error));
            }
        }

        document.getElementById('save-obs').onclick = saveObservation;

        function toggleDrawer() {
            document.getElementById('drawer').classList.toggle('open');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-report').classList.toggle('active', tab === 'report');
            document.getElementById('tab-obs').classList.toggle('active', tab === 'obs');
            document.getElementById('tab-content-report').classList.toggle('active', tab === 'report');
            document.getElementById('tab-content-obs').classList.toggle('active', tab === 'obs');

            if (tab === 'obs') {
                destroyCharts();
                if (isAllPendings) {
                    loadAllPendings();
                } else if (currentSection) {
                    loadObservations(currentSection);
                }
            }
        }

        function selectSection(sectionKey) {
            toggleDrawer();

            Object.keys(sections).forEach(key => {
                const btn = document.getElementById(`btn-${key}`);
                if (btn) btn.classList.remove('active');
            });
            document.getElementById(`btn-${sectionKey}`).classList.add('active');

            currentSection = sectionKey;
            isAllPendings = false;
            document.getElementById('section-title').innerText = `Seguimiento de ${sections[sectionKey]}`;
            document.getElementById('header-title').innerText = sections[sectionKey];

            const isSupervision = ['seguridad', 'gestion_operativa'].includes(sectionKey);
            document.getElementById('tab-report').style.display = isSupervision ? 'none' : 'block';
            if (isSupervision) {
                switchTab('obs');
            } else {
                switchTab('report');
            }

            loadSectionContent(sectionKey);
        }

        function selectAllPendings() {
            toggleDrawer();

            Object.keys(sections).forEach(key => {
                const btn = document.getElementById(`btn-${key}`);
                if (btn) btn.classList.remove('active');
            });
            document.getElementById('btn-todos_pendientes').classList.add('active');

            currentSection = null;
            isAllPendings = true;
            document.getElementById('section-title').innerText = sections['todos_pendientes'];
            document.getElementById('header-title').innerText = sections['todos_pendientes'];

            document.getElementById('tab-report').style.display = 'none';
            switchTab('obs');
            destroyCharts();
            loadAllPendings();
        }

        function loadSectionContent(sectionKey) {
            const isSupervision = ['seguridad', 'gestion_operativa'].includes(sectionKey);

            const reportContent = document.getElementById('tab-content-report');
            if (!isSupervision) {
                reportContent.innerHTML = `
                    <label for="date-${sectionKey}">Seleccionar Fecha para Reporte Diario:</label>
                    <input type="date" id="date-${sectionKey}" onchange="loadReport('${sectionKey}', this.value)">
                    <div id="report-box-${sectionKey}" class="report-box"><h3>Reporte de Trabajo Diario</h3></div>
                `;
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const formattedYesterday = yesterday.toISOString().split('T')[0];
                document.getElementById(`date-${sectionKey}`).value = formattedYesterday;
                selectedDate = formattedYesterday;
                loadReport(sectionKey, formattedYesterday);
            } else {
                reportContent.innerHTML = '';
            }

            const obsContent = document.getElementById('tab-content-obs');
            obsContent.innerHTML = `
                <h3>Seguimiento de Observaciones y/o Pendientes</h3>
                <button class="add-observation" onclick="openAddObsModal()">Añadir Observación</button>
                <div id="observations-box-${sectionKey}" class="observations-box"></div>
            `;
            destroyCharts();
            loadObservations(sectionKey);
        }

        function loadReport(section, dateStr) {
            selectedDate = dateStr;
            const reportBox = document.getElementById(`report-box-${section}`);
            if (!dateStr) {
                reportBox.innerHTML = '<h3>Reporte de Trabajo Diario</h3><p>Seleccione una fecha para ver o editar el reporte.</p>';
                activities = [];
                return;
            }

            const reportId = `${section}_${dateStr.replace(/-/g, '')}`;
            db.collection('reportes').doc(reportId).get()
                .then(doc => {
                    activities = doc.exists ? doc.data().activities || [] : [];
                    renderDailyReportTable(reportBox);
                }).catch(error => console.error(error));
        }

        function renderDailyReportTable(reportBox) {
            let tableHTML = `
                <h3>Reporte de Trabajo Diario</h3>
                <table id="report-table">
                    <thead>
                        <tr>
                            <th>Actividad</th>
                            <th>% Avance</th>
                            <th>Especialidad</th>
                            <th>Comentario</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="report-tbody">
            `;

            activities.forEach((act, index) => {
                if (act.locked) {
                    tableHTML += `
                        <tr>
                            <td>${act.actividad || ''}</td>
                            <td><progress value="${act.avance || 0}" max="100"></progress> ${act.avance || 0}%</td>
                            <td>${act.especialidad || ''}</td>
                            <td>${act.comentario || ''}</td>
                            <td>
                                <button class="edit" title="Modificar" onclick="editRow(${index})"><i class="fas fa-edit"></i></button>
                                <button class="delete-row" title="Borrar" onclick="deleteRow(${index})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                } else {
                    tableHTML += `
                        <tr id="row-${index}">
                            <td><input type="text" value="${act.actividad || ''}" id="act-${index}"></td>
                            <td><input type="number" min="0" max="100" value="${act.avance || 0}" id="av-${index}"></td>
                            <td><input type="text" value="${act.especialidad || ''}" id="esp-${index}"></td>
                            <td><input type="text" value="${act.comentario || ''}" id="com-${index}"></td>
                            <td>
                                <button class="save-row" title="Guardar" onclick="saveRow(${index})"><i class="fas fa-check"></i></button>
                                <button class="cancel-row" title="Cancelar" onclick="cancelRow(${index})"><i class="fas fa-times"></i></button>
                            </td>
                        </tr>
                    `;
                }
            });

            tableHTML += `
                    </tbody>
                </table>
                <div style="margin-top: 15px;">
                    <button class="add-row" onclick="addDailyRow()"><i class="fas fa-plus"></i> Añadir Fila</button>
                    <button class="save-report" onclick="saveDailyReport()"><i class="fas fa-save"></i> Guardar Reporte</button>
                </div>
            `;

            reportBox.innerHTML = tableHTML;
        }

        function addDailyRow() {
            if (!selectedDate) return alert('Seleccione una fecha primero');
            activities.push({actividad: '', avance: 0, comentario: '', especialidad: '', locked: false});
            const reportBox = document.getElementById(`report-box-${currentSection}`);
            renderDailyReportTable(reportBox);
        }

        function editRow(index) {
            activities[index].locked = false;
            const reportBox = document.getElementById(`report-box-${currentSection}`);
            renderDailyReportTable(reportBox);
        }

        function deleteRow(index) {
            if (confirm('¿Estás seguro de que quieres borrar esta actividad?')) {
                activities.splice(index, 1);
                const reportBox = document.getElementById(`report-box-${currentSection}`);
                renderDailyReportTable(reportBox);
            }
        }

        function saveRow(index) {
            const act = {
                actividad: document.getElementById(`act-${index}`).value.trim(),
                avance: parseInt(document.getElementById(`av-${index}`).value),
                especialidad: document.getElementById(`esp-${index}`).value.trim(),
                comentario: document.getElementById(`com-${index}`).value.trim(),
                locked: true
            };
            if (act.actividad === '' || isNaN(act.avance) || act.avance < 0 || act.avance > 100 || act.especialidad === '') {
                alert('Por favor, completa Actividad, % Avance (entre 0 y 100) y Especialidad.');
                return;
            }
            activities[index] = act;
            const reportBox = document.getElementById(`report-box-${currentSection}`);
            renderDailyReportTable(reportBox);
        }

        function cancelRow(index) {
            if (activities[index].actividad.trim() === '' && activities[index].especialidad.trim() === '') {
                activities.splice(index, 1);
            } else {
                activities[index].locked = true;
            }
            const reportBox = document.getElementById(`report-box-${currentSection}`);
            renderDailyReportTable(reportBox);
        }

        function saveDailyReport() {
            if (!selectedDate) return alert('Seleccione una fecha primero');
            if (activities.some(act => !act.locked)) {
                return alert('Por favor, guarda o cancela todas las ediciones pendientes antes de guardar el reporte.');
            }

            const reportId = `${currentSection}_${selectedDate.replace(/-/g, '')}`;
            const reportData = {
                section: currentSection,
                date: selectedDate,
                activities: activities
            };

            if (isOnline()) {
                db.collection('reportes').doc(reportId).set(reportData)
                    .then(() => {
                        alert('Reporte diario guardado exitosamente');
                        loadReport(currentSection, selectedDate);
                    })
                    .catch(error => {
                        console.error(error);
                        saveToPending('reports', reportId, reportData);
                    });
            } else {
                saveToPending('reports', reportId, reportData);
            }
        }

        function loadObservations(section) {
            const obsBox = document.getElementById(`observations-box-${section}`);
            obsBox.innerHTML = `
                <div class="chart-wrapper">
                    <h4>Cumplimiento General</h4>
                    <canvas id="chart-compliance-${section}"></canvas>
                </div>
                <table id="obs-table">
                    <thead>
                        <tr>
                            <th>Observación</th>
                            <th>Especialidad</th>
                            <th>Fecha de Inicio</th>
                            <th>% Avance</th>
                            <th>Última Actualización</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `;

            const tbody = obsBox.querySelector('tbody');

            db.collection('observaciones')
                .where('section', '==', section)
                .orderBy('startDate', 'desc')
                .get()
                .then(snapshot => {
                    let totalProgress = 0;
                    let count = 0;

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        totalProgress += data.progress || 0;
                        count++;

                        const startDate = data.startDate ? data.startDate.toDate().toLocaleDateString('es-ES') : 'N/A';
                        const lastUpdate = data.history && data.history.length > 0 ? data.history[data.history.length - 1] : null;
                        const lastUpdateDateStr = lastUpdate && lastUpdate.timestamp
                            ? new Date(lastUpdate.timestamp.seconds * 1000).toLocaleDateString('es-ES')
                            : 'Sin actualizaciones';
                        const lastUpdateStr = lastUpdate
                            ? `${lastUpdateDateStr} - ${lastUpdate.user} - ${lastUpdate.action} (${lastUpdate.progressChange > 0 ? '+' : ''}${lastUpdate.progressChange}%)`
                            : 'Sin actualizaciones';

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${data.description}</td>
                            <td>${data.especialidad || ''}</td>
                            <td>${startDate}</td>
                            <td><progress value="${data.progress}" max="100"></progress> ${data.progress}%</td>
                            <td>${lastUpdateStr}</td>
                            <td>
                                <button class="edit-obs" onclick="openEditObsModal('${doc.id}', '${section}')"><i class="fas fa-edit"></i> Editar</button>
                                <input type="number" id="progress-${doc.id}" min="0" max="100" value="${data.progress}" style="width: 60px;">
                                <input type="text" id="action-${doc.id}" placeholder="Describe la acción" style="width: 150px;">
                                <button onclick="prepareUpdateObservation('${doc.id}', '${section}')"><i class="fas fa-sync"></i> Actualizar</button>
                                <button class="toggle-history" onclick="toggleHistory('${doc.id}')"><i class="fas fa-history"></i> Historial</button>
                                <button class="delete-obs" onclick="deleteObservation('${doc.id}', '${section}')"><i class="fas fa-trash"></i> Eliminar</button>
                            </td>
                        `;
                        tbody.appendChild(tr);

                        const historyTr = document.createElement('tr');
                        historyTr.id = `history-row-${doc.id}`;
                        historyTr.className = 'history-row';
                        historyTr.style.display = 'none';
                        historyTr.innerHTML = `
                            <td colspan="6">
                                <div class="observation-history">
                                    <h5>Historial Completo</h5>
                                    ${data.history.map(log => {
                                        if (!log.timestamp || !log.timestamp.seconds) return '<p>Dato corrupto</p>';
                                        const fullDate = new Date(log.timestamp.seconds * 1000).toLocaleString('es-ES');
                                        const shortDate = new Date(log.timestamp.seconds * 1000).toLocaleDateString('es-ES');
                                        return `<p>${fullDate} (${shortDate}) - <strong>${log.user || 'Desconocido'}</strong>: ${log.action || ''} (${log.progressChange > 0 ? '+' : ''}${log.progressChange || 0}%)</p>`;
                                    }).join('')}
                                </div>
                            </td>
                        `;
                        tbody.appendChild(historyTr);
                    });

                    const avgProgress = count > 0 ? Math.round(totalProgress / count) : 0;

                    const chart = new Chart(document.getElementById(`chart-compliance-${section}`), {
                        type: 'doughnut',
                        data: {
                            labels: ['Avance', 'Pendiente'],
                            datasets: [{
                                data: [avgProgress, 100 - avgProgress],
                                backgroundColor: ['#00B7B5', '#ff4444'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' },
                                title: { display: true, text: `Promedio: ${avgProgress}%` }
                            }
                        }
                    });
                    currentCharts.push(chart);

                }).catch(error => console.error(error));
        }

        function loadAllPendings() {
            const obsContent = document.getElementById('tab-content-obs');
            obsContent.innerHTML = `
                <h3>Seguimiento de Pendientes - Todos los Sectores</h3>
                <button class="add-observation" onclick="openAddObsModal()">Añadir Observación</button>
                <div id="observations-box-all" class="observations-box"></div>
            `;

            const obsBox = document.getElementById('observations-box-all');
            obsBox.innerHTML = `
                <div class="chart-wrapper">
                    <h4>Cumplimiento General (Todos)</h4>
                    <canvas id="chart-compliance-all"></canvas>
                </div>
                <table id="obs-table">
                    <thead>
                        <tr>
                            <th>Sector</th>
                            <th>Observación</th>
                            <th>Especialidad</th>
                            <th>Fecha de Inicio</th>
                            <th>% Avance</th>
                            <th>Última Actualización</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `;

            const tbody = obsBox.querySelector('tbody');

            db.collection('observaciones')
                .orderBy('startDate', 'desc')
                .get()
                .then(snapshot => {
                    let totalProgress = 0;
                    let count = 0;

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        totalProgress += data.progress || 0;
                        count++;

                        const sectorName = sections[data.section] || data.section;
                        const startDate = data.startDate ? data.startDate.toDate().toLocaleDateString('es-ES') : 'N/A';
                        const lastUpdate = data.history && data.history.length > 0 ? data.history[data.history.length - 1] : null;
                        const lastUpdateDateStr = lastUpdate && lastUpdate.timestamp
                            ? new Date(lastUpdate.timestamp.seconds * 1000).toLocaleDateString('es-ES')
                            : 'Sin actualizaciones';
                        const lastUpdateStr = lastUpdate
                            ? `${lastUpdateDateStr} - ${lastUpdate.user} - ${lastUpdate.action} (${lastUpdate.progressChange > 0 ? '+' : ''}${lastUpdate.progressChange}%)`
                            : 'Sin actualizaciones';

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${sectorName}</td>
                            <td>${data.description}</td>
                            <td>${data.especialidad || ''}</td>
                            <td>${startDate}</td>
                            <td><progress value="${data.progress}" max="100"></progress> ${data.progress}%</td>
                            <td>${lastUpdateStr}</td>
                            <td>
                                <button class="toggle-history" onclick="toggleHistory('${doc.id}')"><i class="fas fa-history"></i> Historial</button>
                                <button class="delete-obs" onclick="deleteObservation('${doc.id}', null)"><i class="fas fa-trash"></i> Eliminar</button>
                            </td>
                        `;
                        tbody.appendChild(tr);

                        const historyTr = document.createElement('tr');
                        historyTr.id = `history-row-${doc.id}`;
                        historyTr.className = 'history-row';
                        historyTr.style.display = 'none';
                        historyTr.innerHTML = `
                            <td colspan="7">
                                <div class="observation-history">
                                    <h5>Historial Completo</h5>
                                    ${data.history.map(log => {
                                        if (!log.timestamp || !log.timestamp.seconds) return '<p>Dato corrupto</p>';
                                        const fullDate = new Date(log.timestamp.seconds * 1000).toLocaleString('es-ES');
                                        const shortDate = new Date(log.timestamp.seconds * 1000).toLocaleDateString('es-ES');
                                        return `<p>${fullDate} (${shortDate}) - <strong>${log.user || 'Desconocido'}</strong>: ${log.action || ''} (${log.progressChange > 0 ? '+' : ''}${log.progressChange || 0}%)</p>`;
                                    }).join('')}
                                </div>
                            </td>
                        `;
                        tbody.appendChild(historyTr);
                    });

                    const avgProgress = count > 0 ? Math.round(totalProgress / count) : 0;

                    const chart = new Chart(document.getElementById('chart-compliance-all'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Avance', 'Pendiente'],
                            datasets: [{
                                data: [avgProgress, 100 - avgProgress],
                                backgroundColor: ['#00B7B5', '#ff4444'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' },
                                title: { display: true, text: `Promedio General: ${avgProgress}%` }
                            }
                        }
                    });
                    currentCharts.push(chart);
                }).catch(error => console.error(error));
        }

        function toggleHistory(id) {
            const row = document.getElementById(`history-row-${id}`);
            row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
        }

        function deleteObservation(obsId, section) {
            if (confirm('¿Estás seguro de que deseas eliminar esta observación completa? Esta acción no se puede deshacer.')) {
                db.collection('observaciones').doc(obsId).delete()
                    .then(() => {
                        alert('Observación eliminada');
                        destroyCharts();
                        if (isAllPendings) {
                            loadAllPendings();
                        } else {
                            loadObservations(section);
                        }
                    })
                    .catch(error => console.error(error));
            }
        }

        function prepareUpdateObservation(obsId, section) {
            const newProgressInput = document.getElementById(`progress-${obsId}`);
            const actionInput = document.getElementById(`action-${obsId}`);

            if (!newProgressInput || !actionInput) return;

            const newProgress = parseInt(newProgressInput.value);
            const action = actionInput.value.trim();

            if (isNaN(newProgress) || newProgress < 0 || newProgress > 100 || !action) {
                return alert('Ingresa un % válido (0-100) y describe la acción realizada.');
            }

            pendingUpdate = { obsId, section, newProgress, action };
            document.getElementById('update-user-modal').style.display = "block";
            document.getElementById('update-user-custom').style.display = 'none';
        }

        function performUpdateObservation(obsId, section, newProgress, action, user) {
            db.collection('observaciones').doc(obsId).get().then(doc => {
                if (!doc.exists) return;

                const currentProgress = doc.data().progress || 0;
                const progressChange = newProgress - currentProgress;

                const log = {
                    user: user,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    action: action,
                    progressChange: progressChange
                };

                if (isOnline()) {
                    db.collection('observaciones').doc(obsId).update({ progress: newProgress })
                        .then(() => {
                            return db.collection('observaciones').doc(obsId).update({
                                history: firebase.firestore.FieldValue.arrayUnion(log)
                            });
                        })
                        .then(() => {
                            alert('Observación actualizada correctamente');
                            destroyCharts();
                            if (isAllPendings) {
                                loadAllPendings();
                            } else {
                                loadObservations(section);
                            }
                        })
                        .catch(error => {
                            console.error(error);
                            saveToPending('observations', obsId, { 
                                progress: newProgress, 
                                history: firebase.firestore.FieldValue.arrayUnion(log) 
                            });
                        });
                } else {
                    saveToPending('observations', obsId, { 
                        progress: newProgress, 
                        history: firebase.firestore.FieldValue.arrayUnion(log) 
                    });
                }
            }).catch(error => console.error(error));
        }

        function isOnline() {
            return navigator.onLine;
        }

        function saveToPending(type, id, data) {
            const key = type === 'reports' ? 'pendingReports' : 'pendingObservations';
            let pending = JSON.parse(localStorage.getItem(key) || '[]');
            pending.push({ id, data });
            localStorage.setItem(key, JSON.stringify(pending));
            alert('Sin conexión: Datos guardados localmente. Se sincronizarán al conectar.');
        }

        function syncPendingData() {
            if (!isOnline()) return;

            const pendingReports = JSON.parse(localStorage.getItem('pendingReports') || '[]');
            pendingReports.forEach(report => {
                db.collection('reportes').doc(report.id).set(report.data)
                    .then(() => console.log('Reporte sincronizado:', report.id))
                    .catch(error => console.error('Error sincronizando reporte:', error));
            });
            if (pendingReports.length > 0) localStorage.setItem('pendingReports', '[]');

            const pendingObs = JSON.parse(localStorage.getItem('pendingObservations') || '[]');
            pendingObs.forEach(obs => {
                db.collection('observaciones').doc(obs.id).update(obs.data)
                    .then(() => console.log('Observación sincronizada:', obs.id))
                    .catch(error => console.error('Error sincronizando obs:', error));
            });
            if (pendingObs.length > 0) localStorage.setItem('pendingObservations', '[]');
        }

        window.addEventListener('online', syncPendingData);

        window.onload = () => {
            syncPendingData();
            selectSection('pozos');
        };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registrado con éxito:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('Error al registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>